"use strict";(self.webpackChunkwebgi=self.webpackChunkwebgi||[]).push([[412],{9044:function(e,t,r){var a=r(352),i=r.n(a)()((function(e){return e[1]}));i.push([e.id,"#assetManagerLoadingBar{z-index:400;position:absolute;top:0;left:0;right:0;width:100%;background-color:rgba(0,0,0,0);height:auto}#assetManagerLoadingBarContent{color:#fff;position:absolute;left:0;right:0;margin:auto;transition:width .5s;background-color:rgba(34,34,34,.6666666667);text-align:center;font-size:.5rem;line-height:.6rem;height:.6rem;border-radius:0 0 .125rem .125rem;border-bottom:#999 1px solid}.processState{font-weight:bold}",""]),t.Z=i},7798:function(e,t,r){var a=r(352),i=r.n(a)()((function(e){return e[1]}));i.push([e.id,"#assetManagerPopup{z-index:300;position:absolute;bottom:2rem;right:2rem;-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);color:#fff;background-blend-mode:luminosity;background-color:rgba(40,34,60,.6666666667);padding:1.5rem;font-size:1rem;width:-moz-max-content;width:max-content;max-width:80vw;max-height:80vh;overflow-y:scroll;border-radius:.5rem;height:-moz-max-content;height:max-content}#assetManagerPopupClose{position:absolute;top:0;right:0;padding:.5rem;cursor:pointer}#assetManagerPopupContent{padding-top:.5rem}.processState{font-weight:bold}",""]),t.Z=i},9879:function(e,t,r){r.d(t,{M:function(){return l}});var a=r(3995),i=r(5551),n=r(9008),s=r(4107),o=r(4821);class l extends a.Q{_onEnabledChange(){this.enabled||(this._mainDiv.style.display="none")}constructor(e){super(),this.enabled=!0,this.dependencies=[o.k],this._mainDiv=(0,n.createDiv)({id:"assetManager"+e,addToBody:!1,innerHTML:""}),this._contentDiv=(0,n.createDiv)({id:"assetManager"+e+"Content",addToBody:!1,innerHTML:""}),this.enabled||(this._mainDiv.style.display="none"),this._mainDiv.appendChild(this._contentDiv)}async onAdded(e){await super.onAdded(e),e.container.appendChild(this._mainDiv);const t=new Map;this._updateMainDiv(t),e.getManager()?.importer?.addEventListener("importFile",(e=>{"done"!==e.state?t.set(e.path,{state:e.state,progress:e.progress?100*e.progress:void 0}):t.delete(e.path),this._updateMainDiv(t)})),e.getManager()?.exporter?.addEventListener("exportFile",(e=>{"done"!==e.state?t.set(e.obj.name,{state:e.state,progress:e.progress?100*e.progress:void 0}):t.delete(e.obj.name),this._updateMainDiv(t)})),e.getPluginByType("FileTransferPlugin")?.addEventListener("transferFile",(e=>{"done"!==e.state?t.set(e.path,{state:e.state,progress:e.progress?100*e.progress:void 0}):t.delete(e.path),this._updateMainDiv(t)})),e.getPluginByType("MaterialConfiguratorPlugin")?.addEventListener("progress",(e=>{"done"!==e.state?t.set("MatpreviewGeneration",{state:e.state,progress:0}):t.delete("MatpreviewGeneration"),this._updateMainDiv(t)})),e.getPluginByType("SwitchNodePlugin")?.addEventListener("progress",(e=>{"done"!==e.state?t.set("SwitchNodeGeneration",{state:e.state,progress:0}):t.delete("SwitchNodeGeneration"),this._updateMainDiv(t)})),e.getPluginByType("ThemePlugin")?.addEventListener("progress",(e=>{"done"!==e.state?t.set("ThemeInit",{state:e.state,progress:0}):t.delete("ThemeInit"),this._updateMainDiv(t)}))}}!function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);n>3&&s&&Object.defineProperty(t,r,s)}([(0,i.Q7)("Enabled"),(0,n.onChange)(l.prototype._onEnabledChange),(0,s.qC)()],l.prototype,"enabled",void 0)},9076:function(e,t,r){r.d(t,{S:function(){return x}});var a=r(5701),i=r.n(a),n=r(8236),s=r.n(n),o=r(6850),l=r.n(o),c=r(7182),u=r.n(c),d=r(9213),p=r.n(d),h=r(9044),m={};h.Z&&h.Z.locals&&(m.locals=h.Z.locals);var f,g=0,v={};v.styleTagTransform=p(),v.setAttributes=l(),v.insert=function(e,t){(t.target||document.head).appendChild(e)},v.domAPI=s(),v.insertStyleElement=u(),m.use=function(e){return v.options=e||{},g++||(f=i()(h.Z,v)),m},m.unuse=function(){g>0&&!--g&&(f(),f=null)};var _=m,y=r(5551),b=r(9879);let x=class extends b.M{constructor(e=!0){super("LoadingBar"),this.showText=e}_updateMainDiv(e){if(!this._contentDiv)return;if(!this.enabled)return void(this._mainDiv.style.display="none");let t=1,r=1;e.forEach(((e,a)=>{t+=e.progress??99,r+=100})),this._contentDiv.innerHTML=this.showText?(100*t/r).toFixed(0)+"%":"&nbsp;",this._contentDiv.style.width=(100*t/r).toFixed(0)+"%",0===e.size?this._mainDiv.style.display="none":this._mainDiv.style.display="block"}async onAdded(e){_.use({target:e.container}),await super.onAdded(e)}};x.PluginType="AssetManagerLoadingBarPlugin",x=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s}([(0,y.Sp)("Asset manager loading bar")],x)},8041:function(e,t,r){r.d(t,{_:function(){return C}});var a=r(9008),i=r(5701),n=r.n(i),s=r(8236),o=r.n(s),l=r(6850),c=r.n(l),u=r(7182),d=r.n(u),p=r(9213),h=r.n(p),m=r(7798),f={};m.Z&&m.Z.locals&&(f.locals=m.Z.locals);var g,v=0,_={};_.styleTagTransform=h(),_.setAttributes=c(),_.insert=function(e,t){(t.target||document.head).appendChild(e)},_.domAPI=o(),_.insertStyleElement=d(),f.use=function(e){return _.options=e||{},v++||(g=n()(m.Z,_)),f},f.unuse=function(){v>0&&!--v&&(g(),g=null)};var y=f,b=r(5551),x=r(9879);let C=class extends x.M{constructor(){super("Popup");const e=(0,a.createDiv)({id:"assetManagerPopupClose",addToBody:!1,innerHTML:"&#10005"});e.addEventListener("click",(()=>{this._mainDiv.style.display="none"})),this._mainDiv.appendChild(e)}_updateMainDiv(e){if(!this._contentDiv)return;if(!this.enabled)return void(this._mainDiv.style.display="none");let t="";e.forEach(((e,r)=>{t+=`<span class="processState">${e.state}</span>: ${(r||"").split("/").pop()} ${e.progress?" - "+e.progress.toFixed(0)+"%":""}<br>`})),this._contentDiv.innerHTML=t,0===e.size?this._mainDiv.style.display="none":this._mainDiv.style.display="block"}async onAdded(e){y.use({target:e.container}),await super.onAdded(e)}};C.PluginType="AssetManagerBasicPopupPlugin",C=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s}([(0,b.Sp)("Asset manager popup")],C)},6689:function(e,t,r){r.d(t,{O:function(){return l}});var a=r(2681),i=r(2354),n=r(2562),s=r(9008),o=r(4821);class l extends s.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[o.k]}async onAdded(e){this._importer||(this._importer=new i.q(class extends n.I{constructor(t){super(t),this.setDataType((0,a.g)(e.renderer.rendererObject))}},["exr"],!1)),e.getManager()?.importer?.Importers.push(this._importer)}async onDispose(e){this._importer=void 0}async onRemove(e){this._importer&&e.getManager()?.importer?.Importers&&e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}l.PluginType="EXRLoadPlugin"},7283:function(e,t,r){r.d(t,{k:function(){return o}});var a=r(2354),i=r(4329),n=r(9008),s=r(4821);class o extends n.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[s.k],this._importer=new a.q(i.y,["fbx"],!0)}async onAdded(e){e.getManager()?.importer?.Importers.push(this._importer)}async onDispose(e){}async onRemove(e){e.getManager()?.importer?.Importers&&e.getManager()?.importer?.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer),1)}}o.PluginType="FBXLoadPlugin"},8712:function(e,t,r){r.d(t,{B:function(){return n}});var a=r(9008),i=r(4821);class n extends a.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[i.k]}async onAdded(e){const t=document.createElement("script");t.type="module",t.innerHTML="\nimport { MeshoptDecoder } from 'https://cdn.jsdelivr.net/gh/zeux/meshoptimizer@master/js/meshopt_decoder.module.js'\nwindow.MeshoptDecoder = MeshoptDecoder\n",document.head.appendChild(t),this._script=t}async onDispose(e){}async onRemove(e){this._script&&(document.head.removeChild(this._script),this._script=void 0)}}n.PluginType="GLTFMeshOptPlugin"},3898:function(e,t,r){r.d(t,{B:function(){return C}});var a=r(2354),i=r(2988);class n extends i.aNw{constructor(e){super(e)}load(e,t,r,a){const n=this,s=""===this.path?i.Zp0.extractUrlBase(e):this.path,o=new i.hH6(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(r){try{t(n.parse(r,s))}catch(t){a?a(t):console.error(t),n.manager.itemError(e)}}),r,a)}setMaterialOptions(e){return this.materialOptions=e,this}parse(e,t){const r=e.split("\n");let a={};const i=/\s+/,n={};for(let e=0;e<r.length;e++){let t=r[e];if(t=t.trim(),0===t.length||"#"===t.charAt(0))continue;const s=t.indexOf(" ");let o=s>=0?t.substring(0,s):t;o=o.toLowerCase();let l=s>=0?t.substring(s+1):"";if(l=l.trim(),"newmtl"===o)a={name:l},n[l]=a;else if("ka"===o||"kd"===o||"ks"===o||"ke"===o){const e=l.split(i,3);a[o]=[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])]}else a[o]=l}const o=new s(this.resourcePath||t,this.materialOptions);return o.setCrossOrigin(this.crossOrigin),o.setManager(this.manager),o.setMaterials(n),o}}class s{constructor(e="",t={}){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.crossOrigin="anonymous",this.side=void 0!==this.options.side?this.options.side:i.Wl3,this.wrap=void 0!==this.options.wrap?this.options.wrap:i.rpg}setCrossOrigin(e){return this.crossOrigin=e,this}setManager(e){this.manager=e}setMaterials(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}}convert(e){if(!this.options)return e;const t={};for(const r in e){const a=e[r],i={};t[r]=i;for(const e in a){let t=!0,r=a[e];const n=e.toLowerCase();switch(n){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(r=[r[0]/255,r[1]/255,r[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===r[0]&&0===r[1]&&0===r[2]&&(t=!1)}t&&(i[n]=r)}}return t}async preload(){for(const e in this.materialsInfo)await this.create(e)}getIndex(e){return this.nameLookup[e]}async getAsArray(){let e=0;for(const t in this.materialsInfo)this.materialsArray[e]=await this.create(t),this.nameLookup[t]=e,e++;return this.materialsArray}async create(e){return void 0===this.materials[e]&&await this.createMaterial_(e),this.materials[e]}async createMaterial_(e){const t=this,r=this.materialsInfo[e],a={name:e,side:this.side};async function n(e,r){if(a[e])return;const n=t.getTextureParams(r,a);return new Promise(((r,s)=>{let o=!1,l=()=>!o&&(o=!0)&&r();const c=t.loadTexture((u=t.baseUrl,"string"!=typeof(d=n.url)||""===d?"":/^https?:\/\//i.test(d)?d:u+d),void 0,(t=>{a[e]=t,l()}),void 0,l);var u,d;setTimeout(l,50),c.repeat.copy(n.scale),c.offset.copy(n.offset),c.wrapS=t.wrap,c.wrapT=t.wrap,"map"!==e&&"emissiveMap"!==e||(c.colorSpace=i.KI_)}))}const s=Array.from(Object.keys(r||{}));let o=s.includes("d")||s.includes("D");for(const e of s){const t=r[e];let s;if(""!==t)switch(e.toLowerCase()){case"kd":a.color=(new i.Ilk).fromArray(t).convertSRGBToLinear();break;case"ks":a.specular=(new i.Ilk).fromArray(t).convertSRGBToLinear();break;case"ke":a.emissive=(new i.Ilk).fromArray(t).convertSRGBToLinear();break;case"map_kd":await n("map",t);break;case"map_ks":await n("specularMap",t);break;case"map_ke":await n("emissiveMap",t);break;case"norm":await n("normalMap",t);break;case"map_bump":case"bump":await n("bumpMap",t);break;case"map_d":await n("alphaMap",t),a.transparent=!0;break;case"ns":a.shininess=parseFloat(t);break;case"d":s=parseFloat(t),s<1&&(a.opacity=s,a.transparent=!0);break;case"tr":if(o)break;s=parseFloat(t),this.options&&this.options.invertTrProperty&&(s=1-s),s>0&&(a.opacity=1-s,a.transparent=!0)}}return this.materials[e]=new i.xoR(a),this.materials[e]}getTextureParams(e,t){const r={scale:new i.FM8(1,1),offset:new i.FM8(0,0)},a=e.split(/\s+/);let n;return n=a.indexOf("-bm"),n>=0&&(t.bumpScale=parseFloat(a[n+1]),a.splice(n,2)),n=a.indexOf("-s"),n>=0&&(r.scale.set(parseFloat(a[n+1]),parseFloat(a[n+2])),a.splice(n,4)),n=a.indexOf("-o"),n>=0&&(r.offset.set(parseFloat(a[n+1]),parseFloat(a[n+2])),a.splice(n,4)),r.url=a.join(" ").trim(),r}loadTexture(e,t,r,a,n){const s=void 0!==this.manager?this.manager:i.tEQ;let o=s.getHandler(e);null===o&&(o=new i.dpR(s)),o.setCrossOrigin&&o.setCrossOrigin(this.crossOrigin);const l=o.load(e,r,a,n);return void 0!==t&&(l.mapping=t),l}}const o=/^[og]\s*(.+)?/,l=/^mtllib /,c=/^usemtl /,u=/^usemap /,d=/\s+/,p=new i.Pa4,h=new i.Pa4,m=new i.Pa4,f=new i.Pa4,g=new i.Pa4,v=new i.Ilk;function _(){const e={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=e,void(this.object.fromDeclaration=!1!==t);const r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:!1!==t,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(e,t){const r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);const a={index:this.materials.length,name:e||"",mtllib:Array.isArray(t)&&t.length>0?t[t.length-1]:"",smooth:void 0!==r?r.smooth:this.smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(e){const t={index:"number"==typeof e?e:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(a),a},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(e){const t=this.currentMaterial();if(t&&-1===t.groupEnd&&(t.groupEnd=this.geometry.vertices.length/3,t.groupCount=t.groupEnd-t.groupStart,t.inherited=!1),e&&this.materials.length>1)for(let e=this.materials.length-1;e>=0;e--)this.materials[e].groupCount<=0&&this.materials.splice(e,1);return e&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),t}},r&&r.name&&"function"==typeof r.clone){const e=r.clone(0);e.inherited=!0,this.object.materials.push(e)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseNormalIndex:function(e,t){const r=parseInt(e,10);return 3*(r>=0?r-1:r+t/3)},parseUVIndex:function(e,t){const r=parseInt(e,10);return 2*(r>=0?r-1:r+t/2)},addVertex:function(e,t,r){const a=this.vertices,i=this.object.geometry.vertices;i.push(a[e+0],a[e+1],a[e+2]),i.push(a[t+0],a[t+1],a[t+2]),i.push(a[r+0],a[r+1],a[r+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,r){const a=this.normals,i=this.object.geometry.normals;i.push(a[e+0],a[e+1],a[e+2]),i.push(a[t+0],a[t+1],a[t+2]),i.push(a[r+0],a[r+1],a[r+2])},addFaceNormal:function(e,t,r){const a=this.vertices,i=this.object.geometry.normals;p.fromArray(a,e),h.fromArray(a,t),m.fromArray(a,r),g.subVectors(m,h),f.subVectors(p,h),g.cross(f),g.normalize(),i.push(g.x,g.y,g.z),i.push(g.x,g.y,g.z),i.push(g.x,g.y,g.z)},addColor:function(e,t,r){const a=this.colors,i=this.object.geometry.colors;void 0!==a[e]&&i.push(a[e+0],a[e+1],a[e+2]),void 0!==a[t]&&i.push(a[t+0],a[t+1],a[t+2]),void 0!==a[r]&&i.push(a[r+0],a[r+1],a[r+2])},addUV:function(e,t,r){const a=this.uvs,i=this.object.geometry.uvs;i.push(a[e+0],a[e+1]),i.push(a[t+0],a[t+1]),i.push(a[r+0],a[r+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,r,a,i,n,s,o,l){const c=this.vertices.length;let u=this.parseVertexIndex(e,c),d=this.parseVertexIndex(t,c),p=this.parseVertexIndex(r,c);if(this.addVertex(u,d,p),this.addColor(u,d,p),void 0!==s&&""!==s){const e=this.normals.length;u=this.parseNormalIndex(s,e),d=this.parseNormalIndex(o,e),p=this.parseNormalIndex(l,e),this.addNormal(u,d,p)}else this.addFaceNormal(u,d,p);if(void 0!==a&&""!==a){const e=this.uvs.length;u=this.parseUVIndex(a,e),d=this.parseUVIndex(i,e),p=this.parseUVIndex(n,e),this.addUV(u,d,p),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let r=0,a=e.length;r<a;r++){const a=this.parseVertexIndex(e[r],t);this.addVertexPoint(a),this.addColor(a)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const r=this.vertices.length,a=this.uvs.length;for(let t=0,a=e.length;t<a;t++)this.addVertexLine(this.parseVertexIndex(e[t],r));for(let e=0,r=t.length;e<r;e++)this.addUVLine(this.parseUVIndex(t[e],a))}};return e.startObject("",!1),e}class y extends i.aNw{constructor(e){super(e),this.materials=null}load(e,t,r,a){const n=this,s=new i.hH6(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(async function(r){try{t(await n.parse(r))}catch(t){a?a(t):console.error(t),n.manager.itemError(e)}}),r,a)}setMaterials(e){return this.materials=e,this}async parse(e){const t=new _;-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n")),-1!==e.indexOf("\\\n")&&(e=e.replace(/\\\n/g,""));const r=e.split("\n");let a=[];for(let e=0,i=r.length;e<i;e++){const i=r[e].trimStart();if(0===i.length)continue;const n=i.charAt(0);if("#"!==n)if("v"===n){const e=i.split(d);switch(e[0]){case"v":t.vertices.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])),e.length>=7?(v.setRGB(parseFloat(e[4]),parseFloat(e[5]),parseFloat(e[6])).convertSRGBToLinear(),t.colors.push(v.r,v.g,v.b)):t.colors.push(void 0,void 0,void 0);break;case"vn":t.normals.push(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]));break;case"vt":t.uvs.push(parseFloat(e[1]),parseFloat(e[2]))}}else if("f"===n){const e=i.slice(1).trim().split(d),r=[];for(let t=0,a=e.length;t<a;t++){const a=e[t];if(a.length>0){const e=a.split("/");r.push(e)}}const a=r[0];for(let e=1,i=r.length-1;e<i;e++){const i=r[e],n=r[e+1];t.addFace(a[0],i[0],n[0],a[1],i[1],n[1],a[2],i[2],n[2])}}else if("l"===n){const e=i.substring(1).trim().split(" ");let r=[];const a=[];if(-1===i.indexOf("/"))r=e;else for(let t=0,i=e.length;t<i;t++){const i=e[t].split("/");""!==i[0]&&r.push(i[0]),""!==i[1]&&a.push(i[1])}t.addLineGeometry(r,a)}else if("p"===n){const e=i.slice(1).trim().split(" ");t.addPointGeometry(e)}else if(null!==(a=o.exec(i))){const e=(" "+a[0].slice(1).trim()).slice(1);t.startObject(e)}else if(c.test(i))t.object.startMaterial(i.substring(7).trim(),t.materialLibraries);else if(l.test(i)){t.materialLibraries.push(i.substring(7).trim());const e=i.substring(7).trim(),r=this.manager.getHandler(e);if(r){const t=await r.loadAsync(e).catch((e=>{console.warn(e)}));t&&this.setMaterials(t)}else console.warn("OBJLoader2: Set MTLLoader to loading manager to load materials.")}else if(u.test(i))console.warn('OBJLoader2: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if("s"===n){if(a=i.split(" "),a.length>1){const e=a[1].trim().toLowerCase();t.object.smooth="0"!==e&&"off"!==e}else t.object.smooth=!0;const e=t.object.currentMaterial();e&&(e.smooth=t.object.smooth)}else{if("\0"===i)continue;console.warn('THREE.OBJLoader: Unexpected line: "'+i+'"')}}t.finalize();const n=new i.ZAu;if(n.materialLibraries=[].concat(t.materialLibraries),!0==!(1===t.objects.length&&0===t.objects[0].geometry.vertices.length))for(let e=0,r=t.objects.length;e<r;e++){const r=t.objects[e],a=r.geometry,s=r.materials,o="Line"===a.type,l="Points"===a.type;let c=!1;if(0===a.vertices.length)continue;const u=new i.u9r;u.setAttribute("position",new i.a$l(a.vertices,3)),a.normals.length>0&&u.setAttribute("normal",new i.a$l(a.normals,3)),a.colors.length>0&&(c=!0,u.setAttribute("color",new i.a$l(a.colors,3))),!0===a.hasUVIndices&&u.setAttribute("uv",new i.a$l(a.uvs,2));const d=[];for(let e=0,r=s.length;e<r;e++){const r=s[e],a=r.name+"_"+r.smooth+"_"+c;let n=t.materials[a];if(null!==this.materials)if(n=await this.materials.create(r.name),!o||!n||n instanceof i.nls){if(l&&n&&!(n instanceof i.UY4)){const e=new i.UY4({size:10,sizeAttenuation:!1});i.F5T.prototype.copy.call(e,n),e.color.copy(n.color),e.map=n.map,n=e}}else{const e=new i.nls;i.F5T.prototype.copy.call(e,n),e.color.copy(n.color),n=e}void 0===n&&(n=o?new i.nls:l?new i.UY4({size:1,sizeAttenuation:!1}):new i.xoR,n.name=r.name,n.flatShading=!r.smooth,n.vertexColors=c,t.materials[a]=n),d.push(n)}let p;if(d.length>1){for(let e=0,t=s.length;e<t;e++){const t=s[e];u.addGroup(t.groupStart,t.groupCount,e)}p=o?new i.ejS(u,d):l?new i.woe(u,d):new i.Kj0(u,d)}else p=o?new i.ejS(u,d[0]):l?new i.woe(u,d[0]):new i.Kj0(u,d[0]);p.name=r.name,n.add(p)}else if(t.vertices.length>0){const e=new i.UY4({size:1,sizeAttenuation:!1}),r=new i.u9r;r.setAttribute("position",new i.a$l(t.vertices,3)),t.colors.length>0&&void 0!==t.colors[0]&&(r.setAttribute("color",new i.a$l(t.colors,3)),e.vertexColors=!0);const a=new i.woe(r,e);n.add(a)}return n}}var b=r(9008),x=r(4821);class C extends b.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[x.k],this._importer1=new a.q(y,["obj"],!0),this._importer2=new a.q(n,["mtl"],!1)}async onAdded(e){e.getManager()?.importer?.Importers.push(this._importer1),e.getManager()?.importer?.Importers.push(this._importer2)}async onDispose(e){}async onRemove(e){e.getManager()?.importer?.Importers&&(e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer1),1),e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer2),1))}}C.PluginType="ObjMtlLoadPlugin"},2295:function(e,t,r){r.d(t,{P:function(){return p}});var a,i=r(2354),n=r(9008),s=r(4821),o=r(398),l=r(2988),c=r(5551),u=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};class d extends o.Z{constructor(e){super(e),this.materials=[],this.setLibraryPath(d.LIBRARY_PATH)}_createMaterial(e){return d.ImportMaterials?super._createMaterial(e):this.materials[0]||new l.Wid({color:new l.Ilk(1,1,1),metalness:.8,name:"default",side:l.ehD})}async loadAsync(e,t){const r=await super.loadAsync(e,t);r.rotateX(-Math.PI/2),r.userData.materials&&delete r.userData.materials;const a=r.userData.layers;return r.traverse((e=>{const t=e.userData.attributes?.castsShadows,i=e.userData.attributes?.receivesShadows;e.castShadow=t,e.receiveShadow=i;const n=e.userData.attributes?.layerIndex??e.userData.defAttributes?.layerIndex,s=a[n];s&&(e.userData.rhinoLayer=s),e.userData.rhino3dmRoot=r.uuid,this._hideLineMesh(e),this._useInstancedMesh(e),this._useMaterialSource(e,s)})),this.materials=[],r}_useMaterialSource(e,t){if(!d.ImportMaterials)return;const r=e;if("default"===r.material?.name||d.ForceLayerMaterials){const e=r.userData.attributes?.materialSource||r.userData.defAttributes?.materialSource,a=r.userData.attributes?.colorSource||r.userData.defAttributes?.colorSource;if(!e&&!a)return;d.ForceLayerMaterials||0===e?.value||1===e?.value&&0===a?.value?t&&(r.material=this._compareMaterials(this._createMaterial({diffuseColor:t.color,name:t.name,transparency:0,textures:[]}))):3===e?.value||1===e?.value&&3===a?.value?r.traverseAncestors((e=>{e?.material&&(r.material=e.material)})):e&&1!==e.value&&console.warn("Unknown material source",e,r,r.userData.attributes)}}_useInstancedMesh(e){if(!d.ReplaceWithInstancedMesh)return;if(e.children.length<=0)return;const t=e.children,r=t.map((e=>e.geometry));r.filter(((e,t)=>r.indexOf(e)===t)).forEach((r=>{const a=t.filter((e=>e.geometry===r)),i=a.length>0?a.filter((e=>e.material===a[0].material)):[];if(i.length>1){const t=new l.SPe(r,i[0].material,i.length);t.userData={...i[0].userData},t.userData.instanceUserData=[],t.userData.attributes=t.userData.defAttributes||t.userData.attributes,t.userData.defAttributes&&delete t.userData.defAttributes,t.name=t.userData.attributes?.name||i[0].name,i.forEach(((r,a)=>{t.setMatrixAt(a,r.matrix),e.remove(r),t.userData.instanceUserData.push(r.userData)})),e.add(t)}}))}_hideLineMesh(e){if(!d.HideLineMesh)return;if(e.children.length<=0)return;const t=[];e.traverse((e=>{e?.isLine&&t.push(e)})),t.forEach((e=>{e.userData.visible_3dm=e.visible,e.visible=!1}))}}d.LIBRARY_PATH="https://cdn.jsdelivr.net/npm/rhino3dm@7.15.0/",d.ImportMaterials=!0,d.ForceLayerMaterials=!1,d.ReplaceWithInstancedMesh=!1,d.HideLineMesh=!1;let p=a=class extends n.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[s.k],this._importer=new i.q(d,["3dm"],!0),this.importMaterials=d.ImportMaterials,this.forceLayerMaterials=d.ForceLayerMaterials,this.replaceWithInstancedMesh=d.ReplaceWithInstancedMesh,this.hideLineMesh=d.HideLineMesh}_refresh(){d.ImportMaterials=this.importMaterials,d.ForceLayerMaterials=this.forceLayerMaterials,d.ReplaceWithInstancedMesh=this.replaceWithInstancedMesh,d.HideLineMesh=this.hideLineMesh}async onAdded(e){e.getManager()?.importer?.Importers.push(this._importer)}async onDispose(e){}async onRemove(e){e.getManager()?.importer?.Importers&&e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer),1)}};p.PluginType="Rhino3dmLoadPlugin",u([(0,n.onChange)(a.prototype._refresh),(0,c.Q7)()],p.prototype,"importMaterials",void 0),u([(0,n.onChange)(a.prototype._refresh),(0,c.Q7)()],p.prototype,"forceLayerMaterials",void 0),u([(0,n.onChange)(a.prototype._refresh),(0,c.Q7)()],p.prototype,"replaceWithInstancedMesh",void 0),u([(0,n.onChange)(a.prototype._refresh),(0,c.Q7)()],p.prototype,"hideLineMesh",void 0),p=a=u([(0,c.Sp)("Rhino 3dm loader")],p)},1744:function(e,t,r){r.d(t,{v:function(){return o}});var a=r(9008),i=r(4821),n=r(2354),s=r(4625);class o extends a.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[i.k]}async onAdded(e){this._importer||(this._importer=new n.q(s.j,["stl"],!0)),e.getManager()?.importer?.Importers.push(this._importer)}async onDispose(e){this._importer=void 0}async onRemove(e){this._importer&&e.getManager()?.importer?.Importers&&e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}o.PluginType="STLLoadPlugin"},5942:function(e,t,r){r.d(t,{j:function(){return h}});var a=r(3995),i=r(4821);const n=(e,t)=>{const r={};for(const a of e.mappings)for(const e of a.variants)r[t[e]]={material:null,gltfMaterialIndex:a.material};return r},s="KHR_materials_variants";class o{constructor(e){this.parser=e,this.name=s}async afterRoot(e){const t=this.parser,r=t.json;if(!r.extensions||!r.extensions[this.name])return;const a=(e=>{const t=[],r=new Set;for(const a of e){let e=a,i=0;for(;r.has(e);)e=a+"."+ ++i;r.add(e),t.push(e)}return t})((r.extensions[this.name].variants||[]).map((e=>e.name)));for(const i of e.scenes)i.traverse((e=>{const i=t.associations.get(e);if(!i||void 0===i.meshes||void 0===i.primitives)return;const s=r.meshes[i.meshes].primitives[i.primitives].extensions;s&&s[this.name]&&(e.userData._variantMaterials=n(s[this.name],a))}));await Promise.all(e.scenes.map((async e=>{const r=[];return e.traverse((e=>{return void 0!==(a=e).material&&a.userData&&a.userData._variantMaterials&&r.push((async e=>{const r=e.material,a=e.userData._variantMaterials,i=[];for(const r in a){const n=a[r];if(n.material)continue;const s=n.gltfMaterialIndex;i.push(t.getDependency("material",s).then((i=>{e.material=i,t.assignFinalMaterial(e),a[r].material=e.material})))}return Promise.all(i).then((()=>{e.material=r}))})(e));var a})),e.userData.__importData||(e.userData.__importData={}),e.userData.__importData[s]={names:a},Promise.all(r)})))}}var l=r(9008);const c=e=>void 0!==e.material&&e.userData&&e.userData._variantMaterials&&!!Object.values(e.userData._variantMaterials).filter((e=>u(e?.material))),u=e=>e&&e.isMaterial&&!Array.isArray(e);class d{constructor(e){this.writer=e,this.name=s,this.variantNames=[]}beforeParse(e){const t=new Set;for(const r of e)r.traverse((e=>{if(!c(e))return;const r=e.userData._variantMaterials;for(const e in r){const a=r[e];u(a.material)&&t.add(e)}}));t.forEach((e=>this.variantNames.push(e)))}writeMesh(e,t){if(!c(e))return;const r=e.userData,a=r._variantMaterials,i={};for(const e in a){const t=a[e].material;if(!u(t))continue;const r=this.variantNames.indexOf(e),n=this.writer.processMaterial(t);i[n]||(i[n]={material:n,variants:[]}),i[n].variants.push(r)}const n=Object.values(i).map((e=>e.variants.sort(((e,t)=>e-t))&&e)).sort(((e,t)=>e.material-t.material));if(0===n.length)return;const s=u(r._originalMaterial)?this.writer.processMaterial(r._originalMaterial)??-1:-1;for(const e of t.primitives)s>=0&&(e.material=s),e.extensions=e.extensions||{},e.extensions[this.name]={mappings:n}}afterParse(e){if(0===this.variantNames.length)return;const t=this.writer.json;t.extensions=t.extensions||{};const r=this.variantNames.map((e=>({name:e})));t.extensions[this.name]={variants:r},this.writer.extensionsUsed[this.name]=!0}}function p(e){return new d(e)}class h extends a.Q{constructor(){super(),this.enabled=!0,this.toJSON=void 0,this.dependencies=[i.k],this.variants={},this.selectedVariant="",this._objectAdded=e=>{const t=e.object;"model"===t?.assetType&&t.modelObject&&this._viewer&&(t.modelObject.traverse((e=>{if(e.userData._variantMaterials)for(const t of Object.values(e.userData._variantMaterials))t?.material&&(t.material=this._viewer?.getManager()?.materials?.processMaterial(t.material,{})||t.material);const t=e.userData?.__importData?.[s];if(!t)return;const r=t.names||[];for(const t of r)this.variants[t]||(this.variants[t]=[]),this.variants[t].push(e);delete e.userData.__importData[s]})),this.uiConfig.uiRefresh?.())},this.uiConfig={type:"folder",label:"KHR Material Variants",children:[()=>({children:[null,...Object.keys(this.variants)].map((e=>e?{label:e}:{label:"none",value:""})),type:"dropdown",label:"Variant",property:[this,"selectedVariant"]})]},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e),e.scene.addEventListener("addSceneObject",this._objectAdded);const t=e.getPlugin(i.k);t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(p)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new o(e)))}async onRemove(e){e.scene.removeEventListener("addSceneObject",this._objectAdded);const t=e.getPlugin(i.k);t.importer?.removeEventListener("loaderCreate",this._loaderCreate);const r=t.exporter?.getExporter("gltf","glb")?.extensions?.indexOf(p);return void 0!==r&&-1!==r&&t.exporter.getExporter("gltf","glb")?.extensions?.splice(r,1),this.variants={},super.onRemove(e)}_variantChanged(){this.applyVariant(this.selectedVariant||"",!0)}applyVariant(e,t=!1,r,a=!0){if(!t&&!r&&this.selectedVariant===e)return;if(!e)return;r||(this.selectedVariant=e);const i=r?Array.isArray(r)?r:[r]:e?this.variants[e]||[]:Object.values(this.variants).flat();for(const t of i){const r=new Set,i=t=>{if(!t.userData._variantMaterials||r.has(t))return;const a=e?t.userData._variantMaterials[e]?.material:t.userData._originalMaterial;a&&(t.userData._originalMaterial||(t.userData._originalMaterial=t.material),t?.setMaterial?.(a)),r.add(t)};a?t.traverse(i):i(t)}}}h.PluginType="GLTFKHRMaterialVariantsPlugin",function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);n>3&&s&&Object.defineProperty(t,r,s)}([(0,l.onChange)(h.prototype._variantChanged)],h.prototype,"selectedVariant",void 0)},2412:function(e,t,r){r.d(t,{h:function(){return ce},B:function(){return ue}});var a=r(8015),i=r(4821),n=r(8112),s=r(2278),o=r(5571),l=r(7697),c=r(5254),u=r(6882),d=r(5220),p=r(6695),h=r(7821),m=r(6667),f=r(439),g=r(1233),v=r(922),_=r(1531),y=r(4388),b=r(6493),x=r(4722),C=r(7256),S=r(1213),D=r(2875),P=r(418),M=r(3036),w=r(9483),T=r(3316),E=r(5133),O=r(1755),B=r(529),F=r(8505),L=r(4352),j=r(1672),U=r(1134),R=r(5942),A=r(5454),N=r(6757),I=r(5008),k=r(939),z=r(2714),G=r(1321),V=r(2354),W=r(1732),H=r(9008),q=r(4107);const X="KHR_texture_basisu";class Q extends H.SimpleEventDispatcher{constructor(){super(...arguments),this.dependencies=[i.k]}async onAdded(e){this._importer||(this._importer=new V.q(class extends W.a{constructor(t){super(t),this.setTranscoderPath(Q.TRANSCODER_LIBRARY_PATH).detectSupport(e.renderer.rendererObject)}async createTexture(e,t){const r=new Uint8Array(e.slice(0)),a=await super.createTexture(e,t);return a.source._sourceImgBuffer=r,a.userData.mimeType="image/ktx2",a.toJSON=e=>(0,q.Rg)(a,e,a.name,"image/ktx2"),a.clone=()=>{throw new Error("ktx2 texture cloning not supported")},a}},["ktx2"],!1)),e.getManager()?.importer?.Importers.push(this._importer),e.getManager()?.exporter?.getExporter("gltf","glb")?.extensions?.push(Z)}async onDispose(e){this._importer=void 0}async onRemove(e){this._importer&&e.getManager()?.importer?.Importers&&e.getManager().importer.Importers.splice(e.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}Q.PluginType="KTX2LoadPlugin",Q.TRANSCODER_LIBRARY_PATH="https://cdn.jsdelivr.net/gh/BinomialLLC/basis_universal@master/webgl/transcoder/build/";const Z=e=>({writeTexture:(t,r)=>{if("image/ktx2"!==t.userData.mimeType)return;if(void 0!==r.source&&null!==r.source)return void console.warn("ktx2 export: source already set");const a=t.source._sourceImgBuffer||t.userData.__sourceBuffer;if(!a)return void console.warn("ktx2 export: no source buffer for ktx2");r.extensions=r.extensions||{};const i={},n=new Blob([a],{type:"image/ktx2"});i.source=e.processImageBlob(n,t),r.extensions[X]=i,e.extensionsUsed[X]=!0}});var K=r(9076),$=r(8041),Y=r(7398),J=r(3898),ee=r(7283),te=r(9923),re=r(1948),ae=r(1358),ie=r(9280),ne=r(6689),se=r(2295),oe=r(1744),le=r(8712);class ce extends a.o{constructor(e){super(e)}async initialize({caching:e=!0,ground:t=!0,bloom:r=!0,depthTonemap:a=!0,enableDrop:n=!1,importPopup:s=!1,debug:o=!1}={}){return o&&await this.addPlugin(Y.z),this.getPlugin(i.k)||this.addPluginSync(i.k,void 0,void 0,{storage:e&&window.caches?await caches.open("webgi-cache-storage"):void 0}),await this.addPlugin(K.S,!0),await ue(this,{ground:t,bloom:r,depthTonemap:a,enableDrop:n,importPopup:s}),await this.addPlugin(te.z),await this.addPlugin(re.e),await this.addPlugin(ae.M),this}}async function ue(e,{ground:t=!0,bloom:r=!0,depthTonemap:a=!0,enableDrop:V=!1,importPopup:W=!1}={}){await e.getOrAddPlugin(i.k),W&&await e.getOrAddPlugin($._),await e.getOrAddPlugin(N.m),await e.getOrAddPlugin(U.D),V&&await e.getOrAddPlugin(n.y),await e.addPlugin(new f.E(32)),await e.getOrAddPlugin(I.x),await e.getOrAddPlugin(o._),await e.addPlugin(new s.I(a||!e.useRgbm)),await e.getOrAddPlugin(O.v),await e.getOrAddPlugin(w.Q),await e.getOrAddPlugin(h.k),await e.getOrAddPlugin(k.s),await e.getOrAddPlugin(b.i),await e.getOrAddPlugin(l.i),await e.getOrAddPlugin(P.h),await e.getOrAddPlugin(j.$),await e.getOrAddPlugin(g.L),await e.getOrAddPlugin(x.$),await e.getOrAddPlugin(z.z),await e.getOrAddPlugin(d.w),await e.getOrAddPlugin(C.D),await e.getOrAddPlugin(F.T),await e.getOrAddPlugin(m.D),await e.getOrAddPlugin(G.w),await e.getOrAddPlugin(R.j),await e.getOrAddPlugin(E.l,!1),await e.getOrAddPlugin(L.N),await e.getOrAddPlugin(M.qK),await e.getOrAddPlugin(y.F,!1),await e.getOrAddPlugin(S.h,!1),await e.getOrAddPlugin(u.H,!1),await e.getOrAddPlugin(D.j,!1),await e.getOrAddPlugin(v.s,!1),await e.getOrAddPlugin(_.R,!1),await e.getOrAddPlugin(A.r,!1),await e.getOrAddPlugin(Q),await e.getOrAddPlugin(J.B),await e.getOrAddPlugin(ee.k),await e.getOrAddPlugin(se.P),await e.getOrAddPlugin(oe.v),await e.getOrAddPlugin(ne.O),await e.getOrAddPlugin(le.B),await e.getOrAddPlugin(p._),await e.getOrAddPlugin(T.E),await e.getOrAddPlugin(B.o),r&&await e.getOrAddPlugin(c.d),t&&await e.getOrAddPlugin(ie.C),e.renderer.refreshPipeline()}},1321:function(e,t,r){r.d(t,{w:function(){return c}});var a=r(3995),i=r(4821),n=r(4107),s=r(5551),o=r(2314),l=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let c=class extends a.Q{addClearcoatTint(e){return u(e.materialObject)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new d(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[i.k],this._defines={},this._uniforms={ccTintColor:{value:new o.I},ccThickness:{value:0},ccIor:{value:0}},this.materialExtension={parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData._clearcoatTint?.enableTint&&t.materialObject.clearcoat>0?"\nuniform vec3 ccTintColor;\nuniform float ccThickness;\nuniform float ccIor;\nvec3 clearcoatTint(const in float dotNV, const in float dotNL, const in float clearcoat) {\n    vec3 tint = ( ccThickness > 0. ? 1. - ccTintColor : ccTintColor); // Set thickness < 0 for glow.\n    tint = exp(tint * -(ccThickness * ((dotNL + dotNV) / max(dotNL * dotNV, 1e-3)))); // beer's law\n    return mix(vec3(1.0), tint, clearcoat);\n}\n        ":"",shaderExtender:(e,t,r)=>{if(!(this.enabled&&t?.materialObject.userData._clearcoatTint?.enableTint&&t.materialObject.clearcoat>0))return;const a="outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;",i="float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );";e.fragmentShader.includes(i)&&e.fragmentShader.includes(a)||console.error("ClearcoatTintPlugin: shaderExtender cannot patch shader, version changed?"),e.fragmentShader=e.fragmentShader.replace(i,"\n            float dotNVcc = saturate( dot( geometry.clearcoatNormal, -refract(geometry.viewDir, geometry.clearcoatNormal, 1./ccIor) ) );\n            "),e.fragmentShader=e.fragmentShader.replace(a,"\n            outgoingLight *= clearcoatTint(dotNVcc, dotNVcc, material.clearcoat);\n            "+a),e.defines.USE_UV=""},onObjectRender:(e,t)=>{const r=t.materialObject.userData?._clearcoatTint;if(!r?.enableTint)return;this._uniforms.ccTintColor.value.set(r.tintColor),this._uniforms.ccThickness.value=r.thickness,this._uniforms.ccIor.value=r.ior;const a=this.enabled?1:0;t.materialObject.defines.CLEARCOAT_TINT_ENABLED!==a&&(t.materialObject.defines.CLEARCOAT_TINT_ENABLED=a,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._clearcoatTint?.enableTint?"1":"0")+(e.materialObject.clearcoat>0?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:e=>{const t=this._viewer,r={type:"folder",label:"ClearcoatTint",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._clearcoatTint?.enableTint||!1},set value(a){a!==e.materialObject.userData._clearcoatTint?.enableTint&&(a?u(e.materialObject)||t.alert("Cannot add clearcoat tint."):e.materialObject.userData._clearcoatTint&&(e.materialObject.userData._clearcoatTint.enableTint=!1,e.materialObject.needsUpdate=!0),r.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"color",label:"Tint color",hidden:()=>!e.materialObject.userData._clearcoatTint?.enableTint,property:[e.materialObject.userData._clearcoatTint,"tintColor"],onChange:this.setDirty}),()=>({type:"input",label:"Thickness",hidden:()=>!e.materialObject.userData._clearcoatTint?.enableTint,property:[e.materialObject.userData._clearcoatTint,"thickness"],onChange:this.setDirty}),()=>({type:"slider",bounds:[.8,2.5],label:"IOR",hidden:()=>!e.materialObject.userData._clearcoatTint?.enableTint,property:[e.materialObject.userData._clearcoatTint,"ior"],onChange:this.setDirty})]};return r}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(i.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(p)}async onRemove(e){return e.getPlugin(i.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(i.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};function u(e){const t=e?.userData;if(!t)return!1;t._clearcoatTint||(t._clearcoatTint={});const r=t._clearcoatTint;return r.enableTint=!0,void 0===r.tintColor&&(r.tintColor=16777215),void 0===r.thickness&&(r.thickness=.1),void 0===r.ior&&(r.ior=1.5),e.isMaterial&&(e.needsUpdate=!0),!0}c.PluginType="ClearcoatTintPlugin",c.CLEARCOAT_TINT_GLTF_EXTENSION="WEBGI_materials_clearcoat_tint",l([(0,s.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,n.qC)()],c.prototype,"enabled",void 0),c=l([(0,s.Sp)("ClearcoatTint Materials")],c);class d{constructor(e){this.parser=e,this.name=c.CLEARCOAT_TINT_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];return t.userData||(t.userData={}),u(t),(0,n.Hx)(a,t.userData._clearcoatTint,!1,{}),Promise.resolve()}}const p=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._clearcoatTint)return;if(!t.userData._clearcoatTint.enableTint)return;r.extensions=r.extensions||{};const a=(0,n.HD)(t.userData._clearcoatTint,!1);r.extensions[c.CLEARCOAT_TINT_GLTF_EXTENSION]=a,e.extensionsUsed[c.CLEARCOAT_TINT_GLTF_EXTENSION]=!0}})},6667:function(e,t,r){r.d(t,{D:function(){return m}});var a,i=r(3995),n=r(2988),s=r(4821),o=r(2095),l=r(4107),c=r(5551),u=r(8670),d=r(6533),p=r(2860),h=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let m=a=class extends i.Q{enableCustomBump(e,t,r){const a=e.materialObject?.userData;if(!a)return!1;if(void 0===a._hasCustomBump){const e=a.__appliedMeshes;let t=!0;if(e)for(const{geometry:r}of e)!r||r.attributes.position&&r.attributes.normal&&r.attributes.uv||(t=!1);if(!t)return!1}return a._hasCustomBump=!0,a._customBumpScale=r??a._customBumpScale??.001,a._customBumpMap=t??a._customBumpMap,e.materialObject.needsUpdate=!0,!0}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new f(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[s.k],this.bicubicFiltering=!0,this._defines={CUSTOM_BUMP_MAP_DEBUG:!1,CUSTOM_BUMP_MAP_BICUBIC:!0},this._uniforms={customBumpUvTransform:{value:new n.Vkp},customBumpScale:{value:.001},customBumpMap:{value:null}},this.materialExtension={parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData._hasCustomBump?"#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0\n#if CUSTOM_BUMP_MAP_BICUBIC > 0  \nvec4 cubic_cb(float v){vec4 n=vec4(1.,2.,3.,4.)-v;vec4 s=n*n*n;float x=s.x;float y=s.y-4.*s.x;float z=s.z-4.*s.y+6.*s.x;float w=6.-x-y-z;return vec4(x,y,z,w)*(1./6.);}vec4 textureBicubic_cb(sampler2D sampler,vec2 texCoords){vec2 texSize=vec2(textureSize(sampler,0));vec2 invTexSize=1./texSize;texCoords=texCoords*texSize-0.5;vec2 fxy=fract(texCoords);texCoords-=fxy;vec4 xcubic=cubic_cb(fxy.x);vec4 ycubic=cubic_cb(fxy.y);vec4 c=texCoords.xxyy+vec2(-0.5,+1.5).xyxy;vec4 s=vec4(xcubic.xz+xcubic.yw,ycubic.xz+ycubic.yw);vec4 offset=c+vec4(xcubic.yw,ycubic.yw)/s;offset*=invTexSize.xxyy;vec4 sample0=texture(sampler,offset.xz);vec4 sample1=texture(sampler,offset.yz);vec4 sample2=texture(sampler,offset.xw);vec4 sample3=texture(sampler,offset.yw);float sx=s.x/(s.x+s.y);float sy=s.z/(s.z+s.w);return mix(mix(sample3,sample2,sx),mix(sample1,sample0,sx),sy);}\n#endif\nvarying vec2 vCustomBumpUv;uniform sampler2D customBumpMap;uniform float customBumpScale;vec2 dHdxy_fwd_cb(){vec2 dSTdx=dFdx(vCustomBumpUv);vec2 dSTdy=dFdy(vCustomBumpUv);\n#if CUSTOM_BUMP_MAP_BICUBIC > 0\nfloat Hll=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv).x;float dBx=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv+dSTdx).x-Hll;float dBy=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv+dSTdy).x-Hll;\n#else\nfloat Hll=customBumpScale*texture2D(customBumpMap,vCustomBumpUv).x;float dBx=customBumpScale*texture2D(customBumpMap,vCustomBumpUv+dSTdx).x-Hll;float dBy=customBumpScale*texture2D(customBumpMap,vCustomBumpUv+dSTdy).x-Hll;\n#endif\nreturn vec2(dBx,dBy);}\n#ifndef USE_BUMPMAP\nvec3 perturbNormalArb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=dFdx(surf_pos.xyz);vec3 vSigmaY=dFdy(surf_pos.xyz);vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}\n#endif\n#endif\n":"",shaderExtender:(e,t,r)=>{if(!this.enabled||!t.materialObject.userData._hasCustomBump)return;const a=t.materialObject.userData?._customBumpMap;a&&(e.fragmentShader=(0,u.p)(e.fragmentShader,"#glMarker beforeAccumulation","\n#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0\n    normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd_cb(), faceDirection );\n#endif\n                ",{prepend:!0}),e.vertexShader=(0,u.p)(e.vertexShader,"#include <uv_pars_vertex>","\n#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0\n                varying vec2 vCustomBumpUv;\n                uniform mat3 customBumpUvTransform;\n#endif\n                ",{prepend:!0}),e.vertexShader=(0,u.p)(e.vertexShader,"#include <uv_vertex>","\n#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0\n                vCustomBumpUv = ( customBumpUvTransform * vec3( uv, 1 ) ).xy;\n#endif\n                ",{prepend:!0}),e.defines.USE_UV="")},onObjectRender:(e,t)=>{const r=t.materialObject.userData;if(!r?._hasCustomBump)return;const a=e;if(!a.isMesh||!a.geometry)return;const i=r._customBumpMap?.isTexture?r._customBumpMap:null;this._uniforms.customBumpMap.value=i,this._uniforms.customBumpScale.value=i?r._customBumpScale:0,i&&(i.updateMatrix(),this._uniforms.customBumpUvTransform.value.copy(i.matrix));let n=this.enabled&&i?1:0;t.materialObject.defines.CUSTOM_BUMP_MAP_ENABLED!==n&&(t.materialObject.defines.CUSTOM_BUMP_MAP_ENABLED=n,t.materialObject.needsUpdate=!0),n=+this._defines.CUSTOM_BUMP_MAP_DEBUG,t.materialObject.defines.CUSTOM_BUMP_MAP_DEBUG!==n&&(t.materialObject.defines.CUSTOM_BUMP_MAP_DEBUG=n,t.materialObject.needsUpdate=!0),n=+this._defines.CUSTOM_BUMP_MAP_BICUBIC,t.materialObject.defines.CUSTOM_BUMP_MAP_BICUBIC!==n&&(t.materialObject.defines.CUSTOM_BUMP_MAP_BICUBIC=n,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._hasCustomBump?"1":"0")+e.materialObject.userData?._customBumpMap?.uuid,isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:e=>{const t=this._viewer,r=this.enableCustomBump,a={type:"folder",label:"CustomBumpMap",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._hasCustomBump||!1},set value(i){i!==e.materialObject.userData._hasCustomBump&&(i?r(e)||t.alert("One or more geometries cannot be made anisotropic."):(e.materialObject.userData._hasCustomBump=!1,e.materialObject.needsUpdate=!0),a.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},{type:"slider",label:"Bump Scale",bounds:[-1,1],hidden:()=>!e.materialObject.userData._hasCustomBump,property:[e.materialObject.userData,"_customBumpScale"],onChange:this.setDirty},{type:"image",label:"Bump Map",hidden:()=>!e.materialObject.userData._hasCustomBump,property:[e.materialObject.userData,"_customBumpMap"],onChange:()=>{e.materialObject.needsUpdate=!0,this.setDirty()}},(0,p.xX)(e.materialObject.userData,"_customBumpMap")]};return a}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this.enableCustomBumpSelected=()=>{const e=this._viewer?.getPlugin(o.l)?.getSelectedObject()?.material;return"material"===e?.assetType&&this.enableCustomBump(e)},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(s.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(g)}async onRemove(e){e.getPlugin(s.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(s.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate);const t=e.getPlugin(s.k)?.exporter?.getExporter("gltf","glb")?.extensions?.indexOf(g);return void 0!==t&&-1!==t&&e.getPlugin(s.k)?.exporter?.getExporter("gltf","glb")?.extensions?.splice(t,1),super.onRemove(e)}};m.PluginType="CustomBumpMapPlugin",m.CUSTOM_BUMP_MAP_GLTF_EXTENSION="WEBGI_materials_custom_bump_map",h([(0,c.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,l.qC)()],m.prototype,"enabled",void 0),h([(0,c.Q7)("Bicubic",(e=>({onChange:e.setDirty}))),(0,d.lD)("CUSTOM_BUMP_MAP_BICUBIC",void 0,!0,a.prototype.setDirty),(0,l.qC)()],m.prototype,"bicubicFiltering",void 0),h([(0,c.M)("Enable CustomBumpMap",(e=>({hidden:()=>!e._viewer?.getPlugin(o.l)})))],m.prototype,"enableCustomBumpSelected",void 0),m=a=h([(0,c.Sp)("CustomBumpMap Materials")],m);class f{constructor(e){this.parser=e,this.name=m.CUSTOM_BUMP_MAP_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser,a=r.json.materials[e];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();const i=[],s=a.extensions[this.name];t.userData||(t.userData={}),t.userData._hasCustomBump=!0,t.userData._customBumpScale=s.customBumpScale??0;const o=s.customBumpMap;return o&&i.push(r.assignTexture(t.userData,"_customBumpMap",o).then((e=>{e.encoding=n.knz}))),Promise.all(i)}}const g=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._hasCustomBump)return;if((t.userData._customBumpScale||0)<.001)return;r.extensions=r.extensions||{};const a={};if(a.customBumpScale=t.userData._customBumpScale||1,t.userData._customBumpMap){const r={index:e.processTexture(t.userData._customBumpMap)};e.applyTextureTransform(r,t.userData._customBumpMap),a.customBumpMap=r}r.extensions[m.CUSTOM_BUMP_MAP_GLTF_EXTENSION]=a,e.extensionsUsed[m.CUSTOM_BUMP_MAP_GLTF_EXTENSION]=!0}})},6882:function(e,t,r){r.d(t,{H:function(){return x}});var a=r(4895),i=r(2988),n=r(7245),s=r(2314),o=r(7320),l=r(9033),c=r(3198),u=r(9389),d=r(6533),p=r(4107),h=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};const m={uniforms:{colorTexture:{value:null},tNormalDepth:{value:null},blurTexture:{value:null},cocTexture:{value:null},cocTextureSize:{value:new i.FM8},cameraNearFar:{value:new i.FM8}},vertexShader:o.Z,fragmentShader:l.Z+"\n#include <common>\n#include <packing>\nvarying vec2 vUv;uniform vec2 cocTextureSize;uniform vec2 nearFarBlurScale;uniform vec2 cameraNearFar;uniform vec2 focalDepthRange;uniform vec2 crossCenter;uniform float crossRadius;uniform float crossAlpha;uniform vec3 crossColor;float smoothBoundary(float d,float smooothFactor){smooothFactor*=0.5;float value=smoothstep(-smooothFactor,smooothFactor,d);return value;}float circle(vec2 p,float r){return min((length(p)-r),-(length(p)-r-0.01));}float computeCoc(){float depth=getDepth(vUv);if(depth>1.-0.01)return max(nearFarBlurScale.x,nearFarBlurScale.y);depth=mix(cameraNearFar.x,cameraNearFar.y,depth);float coc=(depth-focalDepthRange.x)/focalDepthRange.y;coc=clamp(coc,-1.,1.);return(coc>0.?coc*nearFarBlurScale.y:coc*nearFarBlurScale.x);}void main(){vec4 blur=blurTextureTexelToLinear(texture2D(blurTexture,vUv));float scale=0.5;blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(1.,1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(-1.,1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(-1.,-1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(1.,-1.)/cocTextureSize));blur/=5.;vec2 uvNearest=(floor(vUv*cocTextureSize)+0.5)/cocTextureSize;float coc=abs(min(2.*cocTextureTexelToLinear(texture2D(cocTexture,uvNearest)).a-1.,computeCoc()));float cocLower=0.005;float cocHigher=0.3;vec4 outColor=vec4(mix(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,blur.rgb,smoothstep(cocLower,cocHigher,coc)),1.);vec2 d=vUv-crossCenter;if(length(d)>crossRadius+0.05){float dist=circle(d,crossRadius);gl_FragColor=outColor;}else{d.x*=cocTextureSize.x/cocTextureSize.y;float dist=circle(d,crossRadius);dist=smoothBoundary(dist,2.*fwidth(dist));vec4 color=outColor;vec3 dofCircleColor=mix(crossColor,color.rgb,1.-crossAlpha);gl_FragColor=vec4(mix(color.rgb,dofCircleColor,dist),color.a);}\n#include <encodings_fragment>\n}"},f=((0,n._y)({uniforms:{cocTexture:{value:null},colorTexture:{value:null},colorTextureSize:{value:new i.FM8},direction:{value:new i.FM8}},vertexShader:o.Z,fragmentShader:"#include <common>\nvarying vec2 vUv;uniform vec2 colorTextureSize;uniform vec2 direction;const float MAXIMUM_BLUR_SIZE=16.;const float SIGMA=5.;const int NUM_SAMPLES=4;float normpdf(in float x,in float sigma){return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;}vec3 weightedBlur(){float cocIn=2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv)).a-1.;float kernelRadius=MAXIMUM_BLUR_SIZE*cocIn;vec2 invSize=1./colorTextureSize;cocIn*=cocIn*cocIn;float centreSpaceWeight=normpdf(0.,SIGMA)*abs(cocIn);float weightSum=centreSpaceWeight;vec3 centreSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb;vec3 diffuseSum=centreSample*weightSum;vec2 delta=invSize*kernelRadius/float(NUM_SAMPLES);for(int i=1;i<=NUM_SAMPLES;i++){float spaceWeight=normpdf(float(i),SIGMA);vec2 texcoord=direction*delta*float(i);vec4 rightSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv+texcoord));vec4 leftSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv-texcoord));float leftCocWeight=abs(2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv-texcoord)).a-1.);float rightCocWeight=abs(2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv+texcoord)).a-1.);leftCocWeight*=leftCocWeight*leftCocWeight;rightCocWeight*=rightCocWeight*rightCocWeight;diffuseSum+=((leftSample.rgb*leftCocWeight)+(rightSample.rgb*rightCocWeight))*spaceWeight;weightSum+=(spaceWeight*(leftCocWeight+rightCocWeight));}return diffuseSum/weightSum;}void main(){gl_FragColor=vec4(weightedBlur(),1.);\n#include <encodings_fragment>\n}"},"colorTexture","cocTexture"),(0,n._y)({uniforms:{colorTexture:{value:null},colorTextureSize:{value:new i.FM8},direction:{value:new i.FM8},frameCount:{value:0},blurRadius:{value:16}},vertexShader:o.Z,fragmentShader:c.Z+"\n"+u.Z+"\n#include <common>\nvarying vec2 vUv;uniform vec2 colorTextureSize;uniform float blurRadius;vec4 CircularBlur(){vec4 color=colorTextureTexelToLinear(texture2D(colorTexture,vUv));\n#ifdef DOF_MODE\nfloat blurDist=blurRadius*(2.*color.a-1.);\n#else\nfloat blurDist=blurRadius*color.a;\n#endif\nfloat rnd=PI2*random3(vec3(vUv,frameCount*0.1));float costheta=cos(rnd);float sintheta=sin(rnd);vec4 rotationMatrix=vec4(costheta,-sintheta,sintheta,costheta);vec3 colorSum=vec3(0.);float weightSum=0.001;vec2 ofs;vec4 sampleColor;setPds();\n#pragma unroll_loop_start\nfor(int i=0;i<16;i++){ofs=poisson_disk_samples[UNROLLED_LOOP_INDEX];ofs=vec2(dot(ofs,rotationMatrix.xy),dot(ofs,rotationMatrix.zw));sampleColor=colorTextureTexelToLinear(texture2D(colorTexture,vUv+blurDist*ofs/colorTextureSize.xy));\n#ifdef DOF_MODE\nsampleColor.a=abs(sampleColor.a*2.-1.);sampleColor.a*=sampleColor.a*sampleColor.a;\n#endif\ncolorSum+=sampleColor.rgb*sampleColor.a;weightSum+=sampleColor.a;}\n#pragma unroll_loop_end\ncolorSum/=weightSum;return vec4(saturate(colorSum),1.);}void main(){gl_FragColor=CircularBlur();\n#include <encodings_fragment>\n}",defines:{DOF_MODE:1}},"colorTexture"));class g extends n.Hl{constructor(){super(m,"colorTexture","cocTexture","blurTexture"),this.dofBlurMaterial=f,this.nearFarBlurScale=new i.FM8(.25,.25),this.focalDepthRange=new i.FM8(.5,1.5),this.crossCenter=new i.FM8(.5,.5),this.crossRadius=.04,this.crossAlpha=1,this.crossColor=new s.I(16750848),this.uiConfig={type:"folder",label:"Depth of Field",children:[{type:"checkbox",label:"Enabled",limitedUi:!0,property:[this,"enabled"]},{type:"slider",label:"Depth Range",bounds:[.5,3],property:[this.focalDepthRange,"y"]},{type:"slider",label:"Near Blur scale",bounds:[0,1],property:[this.nearFarBlurScale,"x"]},{type:"slider",label:"Far Blur scale",bounds:[0,1],property:[this.nearFarBlurScale,"y"]}]},this.material.extensions.derivatives=!0,this.computeCocMaterial=(0,n._y)({uniforms:{colorTexture:{value:null},tNormalDepth:this.uniforms.tNormalDepth,cameraNearFar:this.uniforms.cameraNearFar,nearFarBlurScale:this.uniforms.nearFarBlurScale,focalDepthRange:this.uniforms.focalDepthRange},vertexShader:o.Z,fragmentShader:l.Z+"\n#include <common>\n#include <packing>\nvarying vec2 vUv;uniform vec2 nearFarBlurScale;uniform vec2 cameraNearFar;uniform vec2 focalDepthRange;float computeCoc(){float depth=getDepth(vUv);if(depth==1.)return max(nearFarBlurScale.x,nearFarBlurScale.y);depth=mix(cameraNearFar.x,cameraNearFar.y,depth);float coc=(depth-focalDepthRange.x)/focalDepthRange.y;coc=clamp(coc,-1.,1.);return(coc>0.?coc*nearFarBlurScale.y:coc*nearFarBlurScale.x);}void main(){gl_FragColor=vec4(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,0.5*computeCoc()+0.5);\n#include <encodings_fragment>\n}"},"colorTexture"),this.expandCocMaterial=(0,n._y)({uniforms:{colorTexture:{value:null},colorTextureSize:{value:new i.FM8},direction:{value:new i.FM8},tNormalDepth:this.uniforms.tNormalDepth,nearFarBlurScale:this.uniforms.nearFarBlurScale},vertexShader:o.Z,fragmentShader:l.Z+"\n#include <common>\nvarying vec2 vUv;uniform vec2 colorTextureSize;uniform vec2 direction;uniform vec2 nearFarBlurScale;const float MAXIMUM_BLUR_SIZE=4.;float expandNear(const in vec2 offset,const in bool isBackground){float coc=0.;vec2 sampleOffsets=MAXIMUM_BLUR_SIZE*offset/5.;float coc0=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv)).a-1.;float coc1=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-5.*sampleOffsets)).a-1.;float coc2=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-4.*sampleOffsets)).a-1.;float coc3=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-3.*sampleOffsets)).a-1.;float coc4=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-2.*sampleOffsets)).a-1.;float coc5=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-1.*sampleOffsets)).a-1.;float coc6=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+1.*sampleOffsets)).a-1.;float coc7=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+2.*sampleOffsets)).a-1.;float coc8=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+3.*sampleOffsets)).a-1.;float coc9=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+4.*sampleOffsets)).a-1.;float coc10=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+5.*sampleOffsets)).a-1.;if(isBackground){coc=abs(coc0)*0.095474+(abs(coc1)+abs(coc10))*0.084264+(abs(coc2)+abs(coc9))*0.088139+(abs(coc3)+abs(coc8))*0.091276+(abs(coc4)+abs(coc7))*0.093585+(abs(coc5)+abs(coc6))*0.094998;}else{coc=min(coc0,0.);coc=min(coc1*0.3,coc);coc=min(coc2*0.5,coc);coc=min(coc3*0.75,coc);coc=min(coc4*0.8,coc);coc=min(coc5*0.95,coc);coc=min(coc6*0.95,coc);coc=min(coc7*0.8,coc);coc=min(coc8*0.75,coc);coc=min(coc9*0.5,coc);coc=min(coc10*0.3,coc);if(abs(coc0)>abs(coc))coc=coc0;}return coc;}void main(){vec2 offset=2.*direction/colorTextureSize;bool isBackground=getDepth(vUv)>1.-0.001;float coc=expandNear(offset,isBackground);gl_FragColor=vec4(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,0.5*coc+0.5);\n#include <encodings_fragment>\n}"},"colorTexture")}render(e,t,r,a,n){if(!this.enabled)return;const s=e.baseRenderer,o={minFilter:i.TyD,magFilter:i.TyD,type:i.cLu,encoding:i.rnI,sizeMultiplier:.5,isAntialiased:!1,format:i.wk1,depthBuffer:!1,generateMipmaps:!1},l=s.getTempTarget(o),c=s.getTempTarget(o);if(this.computeCocMaterial.uniforms.colorTexture.value=r.texture,s.blit(void 0,l,{material:this.computeCocMaterial}),this.expandCocMaterial.uniforms.colorTexture.value=l.texture,this.expandCocMaterial.uniforms.direction.value.set(1,0),s.blit(void 0,c,{material:this.expandCocMaterial}),this.expandCocMaterial.uniforms.colorTexture.value=c.texture,this.expandCocMaterial.uniforms.direction.value.set(0,1),s.blit(void 0,l,{material:this.expandCocMaterial}),this.dofBlurMaterial.uniforms.frameCount)this.dofBlurMaterial.uniforms.colorTexture.value=l.texture,s.blit(void 0,c,{material:this.dofBlurMaterial});else{const e=s.getTempTarget(o);this.dofBlurMaterial.uniforms.cocTexture.value=l.texture,this.dofBlurMaterial.uniforms.colorTexture.value=l.texture,this.dofBlurMaterial.uniforms.direction.value.set(1,0),s.blit(void 0,e,{material:this.dofBlurMaterial}),this.dofBlurMaterial.uniforms.colorTexture.value=e.texture,this.dofBlurMaterial.uniforms.direction.value.set(0,1),s.blit(void 0,c,{material:this.dofBlurMaterial}),s.releaseTempTarget(e)}this.material.uniforms.blurTexture.value=c.texture,this.material.uniforms.cocTexture.value=l.texture,super.render(e,t,r,a,n),s.releaseTempTarget(l),s.releaseTempTarget(c)}}h([(0,p.qC)(),(0,d.e5)()],g.prototype,"nearFarBlurScale",void 0),h([(0,p.qC)(),(0,d.e5)()],g.prototype,"focalDepthRange",void 0),h([(0,d.e5)()],g.prototype,"crossCenter",void 0),h([(0,d.e5)()],g.prototype,"crossRadius",void 0),h([(0,d.e5)()],g.prototype,"crossAlpha",void 0),h([(0,d.e5)()],g.prototype,"crossColor",void 0);var v=r(6757),_=r(9008),y=r(1672),b=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};class x extends a.G{passCtor(e){return new g}constructor(e=!0,t=!1){super(),this.passId="depthOfField",this._beforeFilters=["progressive","tonemap","screen"],this._afterFilters=["render"],this._requiredFilters=["render"],this.dependencies=[v.m],this.enableEdit=!1,this._focalPointHit=new i.Pa4(0,0,0),this.crossFadeTime=200,this._focalPointHitTime=0,this._tempVec=new i.Pa4,this.enabled=e,this.enableEdit=t,this._onObjectHit=this._onObjectHit.bind(this),this.setDirty=this.setDirty.bind(this)}setFocalPoint(e,t=!0,r=!1){this._focalPointHit.copy(e),t&&this._viewer?.getPlugin(y.$)?.startTransition(this._frameFadeTime),r&&(this._focalPointHitTime=(0,_.now)()),this.setDirty()}getFocalPoint(){return this._focalPointHit}get depthRange(){return this.pass?.passObject.focalDepthRange.y??0}set depthRange(e){this.pass&&(this.pass.passObject.focalDepthRange.y=e),this.setDirty()}get nearBlurScale(){return this.pass?.passObject.nearFarBlurScale.x??0}set nearBlurScale(e){this.pass&&(this.pass.passObject.nearFarBlurScale.x=e),this.setDirty()}get farBlurScale(){return this.pass?.passObject.nearFarBlurScale.y??0}set farBlurScale(e){this.pass&&(this.pass.passObject.nearFarBlurScale.y=e),this.setDirty()}get _frameFadeTime(){return 2.5*this.crossFadeTime}_onObjectHit(e){this._pass&&e.intersects.intersect&&this.enabled&&this.enableEdit&&(this._focalPointHit.copy(e.intersects.intersect.point),this._focalPointHitTime=e.time,e.intersects.selectedObject=null,this._viewer?.getPlugin(y.$)?.startTransition(this._frameFadeTime),this.setDirty())}async onAdded(e){await super.onAdded(e),e.getPluginByType("Picking")?.addEventListener("hitObject",this._onObjectHit)}async onRemove(e){return e.getPluginByType("Picking")?.removeEventListener("hitObject",this._onObjectHit),super.onRemove(e)}setDirty(){this._viewer?.setDirty()}_update(e){if(!super._update(e))return!1;const t=this.pass?.passObject;if(!t)return!1;const r=e.getPlugin(v.m);r?.updateShaderProperties(t.material),t.dofBlurMaterial.uniforms.frameCount&&e.renderer?.updateShaderProperties(t.dofBlurMaterial);const a=e.scene.activeCamera;if(!a)return!1;a.cameraObject.updateMatrixWorld(!0),a.updateShaderProperties(t.material),a.cameraObject.getWorldPosition(this._tempVec),this._tempVec.subVectors(this._focalPointHit,this._tempVec),t.focalDepthRange.x=this._tempVec.length(),t.focalDepthRange.x*=a.cameraObject.getWorldDirection(new i.Pa4).dot(this._tempVec.normalize());let n=((0,_.now)()-this._focalPointHitTime)/this.crossFadeTime;if(n=1-Math.min(1,Math.max(0,n)),Math.abs(n-t.crossAlpha)>.01&&(t.crossAlpha=n,this.setDirty()),n>0){const e=this._tempVec.copy(this._focalPointHit).project(a.cameraObject).addScalar(1).divideScalar(2);t.crossCenter.set(e.x,e.y),t.computeCocMaterial.uniformsNeedUpdate=!0,t.expandCocMaterial.uniformsNeedUpdate=!0}return!0}get uiConfig(){if(this._uiConfig)return this._uiConfig;const e=this._pass?.passObject?.uiConfig;return e?(e.children?.map((e=>(0,_.getOrCall)(e)))?.flat(2).forEach((e=>e&&(e.onChange=this.setDirty))),e.children?.push({type:"checkbox",label:"Enable Edit",limitedUi:!0,property:[this,"enableEdit"]}),this._uiConfig=e,e):{}}}x.PluginType="DepthOfField",b([(0,p.qC)()],x.prototype,"enableEdit",void 0),b([(0,p.qC)("focalPoint")],x.prototype,"_focalPointHit",void 0),b([(0,p.qC)()],x.prototype,"crossFadeTime",void 0)},7256:function(e,t,r){r.d(t,{D:function(){return m}});var a,i=r(3995),n=r(2988),s=r(4821),o=r(4107),l=r(5551),c=r(9008),u=r(8670),d=r(5130),p=r(6757),h=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let m=a=class extends i.Q{static AddFragmentClipping(e,t,r,a,i){const n=e.materialObject?.userData;if(!n)return!1;n._fragmentClippingExt||(n._fragmentClippingExt={});const s=n._fragmentClippingExt;return s.clipEnabled=!0,void 0===s.clipPosition&&(s.clipPosition=t?.toArray()??[0,0,0,0]),void 0===s.clipParams&&(s.clipParams=r?.toArray()??[1,0,0,0]),void 0===s.clipMode&&(s.clipMode=a??f.Circle),void 0===s.clipInvert&&(s.clipInvert=i??!1),e.materialObject.isMaterial&&(e.needsUpdate=!0),!0}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new g(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[s.k,p.m],this._plane=new n.JOQ,this._viewNormalMatrix=new n.Vkp,this._defines={FRAG_CLIPPING_DEBUG:!1},this._uniforms={fragClippingPosition:{value:new n.Ltg},fragClippingParams:{value:new n.Ltg},fragClippingCamAspect:{value:1}},this.materialExtension={parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData._fragmentClippingExt?.clipEnabled?d.Z+c.glsl`
uniform vec4 fragClippingPosition;
uniform vec4 fragClippingParams;
uniform float fragClippingCamAspect;
#if FRAG_CLIPPING_MODE == ${f.Circle}
float fragClippingCircle(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    float radius = fragClippingParams.x;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length(pos - center) - radius;
}
#elif FRAG_CLIPPING_MODE == ${f.Ellipse}
float fragClippingEllipse(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    vec2 radius = fragClippingParams.xy;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length((pos - center) / radius) - 1.0;
}
#elif FRAG_CLIPPING_MODE == ${f.Rectangle}
float fragClippingRectangle(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    vec2 radius = fragClippingParams.xy;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    vec2 d = abs(pos - center) - radius;
    return min(max(d.x,d.y),0.0) + length(max(d,0.0));
}
#elif FRAG_CLIPPING_MODE == ${f.Plane}
float fragClippingPlane(){
    vec3 pos = vViewPosition.xyz;
    vec3 normal = fragClippingParams.xyz;
    float d = dot(pos, normal) - fragClippingParams.w;
    return d;
}
#elif FRAG_CLIPPING_MODE == ${f.Sphere}
float fragClippingSphere(){
    vec3 pos = vViewPosition.xyz;
    vec3 center = fragClippingPosition.xyz;
    float radius = fragClippingParams.x;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length(pos - center) - radius;
}
#endif
        `:"",shaderExtender:(e,t,r)=>{this.enabled&&t.materialObject.userData._fragmentClippingExt?.clipEnabled&&(e.fragmentShader=(0,u.p)(e.fragmentShader,"#glMarker mainStart",c.glsl`
    float fragClippingDist = 0.0;
    #if FRAG_CLIPPING_MODE == ${f.Circle}
    fragClippingDist = fragClippingCircle();
    #elif FRAG_CLIPPING_MODE == ${f.Ellipse}
    fragClippingDist = fragClippingEllipse();
    #elif FRAG_CLIPPING_MODE == ${f.Rectangle}
    fragClippingDist = fragClippingRectangle();
    #elif FRAG_CLIPPING_MODE == ${f.Plane}
    fragClippingDist = fragClippingPlane();
    #elif FRAG_CLIPPING_MODE == ${f.Sphere}
    fragClippingDist = fragClippingSphere();
    #endif
    #if FRAG_CLIPPING_DEBUG
    gl_FragColor = vec4(max(fragClippingDist, 0.0), 0.0, 0.0, 1.0); 
//    gl_FragColor = vec4(vViewPosition.xyz, 1.0);
    #include <encodings_fragment>
    return;
    #endif
    
    #if FRAG_CLIPPING_INVERSE == 1
    if (fragClippingDist > 0.0) discard;
    #else
    if (fragClippingDist < 0.0) discard;
    #endif
            `,{append:!0}))},onObjectRender:(e,t)=>{let r=t.materialObject.userData?._fragmentClippingExt;if(t.materialObject.userData.isGBufferMaterial&&e&&(r=e.material?.userData?._fragmentClippingExt),!r?.clipEnabled)return;if(this._uniforms.fragClippingPosition.value.fromArray(r.clipPosition),r.clipMode===f.Plane){const e=this._viewer?.scene.activeCamera.cameraObject.matrixWorldInverse;this._plane.normal.set(r.clipParams[0],r.clipParams[1],r.clipParams[2]),this._plane.constant=r.clipParams[3],this._viewNormalMatrix.getNormalMatrix(e),this._plane.applyMatrix4(e,this._viewNormalMatrix),this._uniforms.fragClippingParams.value.set(this._plane.normal.x,this._plane.normal.y,this._plane.normal.z,this._plane.constant)}else this._uniforms.fragClippingParams.value.fromArray(r.clipParams);this._viewer?.scene.activeCamera.cameraObject instanceof n.cPb?this._uniforms.fragClippingCamAspect.value=this._viewer?.scene.activeCamera.cameraObject.aspect:this._uniforms.fragClippingCamAspect.value=1;let a=this.enabled?1:0;a=+this._defines.FRAG_CLIPPING_DEBUG,t.materialObject.defines.FRAG_CLIPPING_DEBUG!==a&&(t.materialObject.defines.FRAG_CLIPPING_DEBUG=a,t.materialObject.needsUpdate=!0),a=+r.clipMode,t.materialObject.defines.FRAG_CLIPPING_MODE!==a&&(t.materialObject.defines.FRAG_CLIPPING_MODE=a,t.materialObject.needsUpdate=!0),a=+r.clipInvert,t.materialObject.defines.FRAG_CLIPPING_INVERSE!==a&&(t.materialObject.defines.FRAG_CLIPPING_INVERSE=a,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._fragmentClippingExt?.clipEnabled?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2||e.userData.isGBufferMaterial,updaters:()=>[],getUiConfig:e=>{const t=this._viewer,r={type:"folder",label:"FragmentClipping",children:[{type:"checkbox",label:"Enabled",getValue:()=>e.materialObject.userData._fragmentClippingExt?.clipEnabled||!1,setValue:i=>{i!==e.materialObject.userData._fragmentClippingExt?.clipEnabled&&(i?a.AddFragmentClipping(e.materialObject)||t.alert("Cannot add fragment clipping extension."):e.materialObject.userData._fragmentClippingExt&&(e.materialObject.userData._fragmentClippingExt.clipEnabled=!1,e.materialObject.needsUpdate=!0),r.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"dropdown",label:"Mode",children:Object.entries(f).map((e=>({label:e[0],value:e[1]}))),hidden:()=>!e.materialObject.userData._fragmentClippingExt?.clipEnabled,property:[e.materialObject.userData._fragmentClippingExt,"clipMode"],onChange:this.setDirty}),()=>({type:"vec4",label:"Position",bounds:[-1,1],hidden:()=>!e.materialObject.userData._fragmentClippingExt?.clipEnabled,property:[e.materialObject.userData._fragmentClippingExt,"clipPosition"],onChange:this.setDirty}),()=>({type:"vec4",label:"Params",bounds:[0,1],hidden:()=>!e.materialObject.userData._fragmentClippingExt?.clipEnabled,property:[e.materialObject.userData._fragmentClippingExt,"clipParams"],onChange:this.setDirty}),()=>({type:"toggle",label:"Invert",hidden:()=>!e.materialObject.userData._fragmentClippingExt?.clipEnabled,property:[e.materialObject.userData._fragmentClippingExt,"clipInvert"],onChange:this.setDirty})]};return r}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(s.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(v),e.getPlugin(p.m)?.material?.registerMaterialExtensions([this.materialExtension])}async onRemove(e){return e.getPlugin(s.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(s.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};var f;m.PluginType="FragmentClippingExtensionPlugin1",m.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION="WEBGI_materials_fragment_clipping_extension",h([(0,l.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,o.qC)()],m.prototype,"enabled",void 0),m=a=h([(0,l.Sp)("FragmentClipping Materials")],m),function(e){e[e.Circle=0]="Circle",e[e.Ellipse=1]="Ellipse",e[e.Rectangle=2]="Rectangle",e[e.Plane=3]="Plane",e[e.Sphere=4]="Sphere"}(f||(f={}));class g{constructor(e){this.parser=e,this.name=m.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];return t.userData||(t.userData={}),m.AddFragmentClipping(t),t.userData._fragmentClippingExt=(0,o.Hx)(a,t.userData._fragmentClippingExt,!1,{}),Promise.resolve()}}const v=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._fragmentClippingExt)return;if(!t.userData._fragmentClippingExt.clipEnabled)return;r.extensions=r.extensions||{};const a=(0,o.HD)(t.userData._fragmentClippingExt,!1);r.extensions[m.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION]=a,e.extensionsUsed[m.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION]=!0}})},1134:function(e,t,r){r.d(t,{D:function(){return s}});var a=r(3995),i=r(5551),n=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let s=class extends a.Q{constructor(){super(),this.toJSON=void 0,this.enabled=!0,this._lastSize=["100%","100%"],this._lastFsElement=null,this._fsChangeHandler=e=>{if(this.isFullScreen())this.dispatchEvent({type:"enter"});else{const e=this._lastFsElement||this._viewer?.canvas;e&&(e.style.width=this._lastSize[0],e.style.height=this._lastSize[1]),document.removeEventListener("webkitfullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("mozfullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("fullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("MSFullscreenChange",this._fsChangeHandler,!1),this.dispatchEvent({type:"exit"})}},this.enter=this.enter.bind(this),this.exit=this.exit.bind(this)}async enter(e){if(this.isFullScreen())return;const t=e||this._viewer?.canvas;return t?(this._lastFsElement=t,document.addEventListener&&(document.addEventListener("webkitfullscreenchange",this._fsChangeHandler,!1),document.addEventListener("mozfullscreenchange",this._fsChangeHandler,!1),document.addEventListener("fullscreenchange",this._fsChangeHandler,!1),document.addEventListener("MSFullscreenChange",this._fsChangeHandler,!1)),this._lastSize=[t.style.width,t.style.height],t.style.width="100%",t.style.height="100%",t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():void 0):void 0}async exit(){return document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():void 0}async toggle(e){return this.isFullScreen()?this.exit():this.enter(e)}isFullScreen(){return document.webkitIsFullScreen||document.mozFullScreen||void 0!==document.msFullscreenElement}};s.PluginType="FullScreenPlugin",n([(0,i.M)("Enter FullScreen")],s.prototype,"enter",null),n([(0,i.M)("Exit FullScreen")],s.prototype,"exit",null),n([(0,i.M)("Toggle FullScreen")],s.prototype,"toggle",null),s=n([(0,i.Sp)("Full Screen")],s)},8505:function(e,t,r){r.d(t,{T:function(){return u}});var a=r(3995),i=r(2988),n=r(4821),s=r(4107),o=r(5551),l=r(3198),c=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let u=class extends a.Q{addNoiseBumpMaterial(e){return d(e.materialObject)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new p(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[n.k],this._uniforms={noiseBumpParams:{value:new i.FM8},noiseBumpScale:{value:.05},noiseBumpFlakeScale:{value:1e3},noiseFlakeClamp:{value:1},noiseFlakeRadius:{value:.5},flakeParams:{value:new i.Ltg(0,1,3,0)},flakeFallOffParams:{value:new i.Pa4(0,1,0)},useColorFlakes:{value:!1}},this.materialExtension={parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData._noiseBumpMat?.hasBump?l.Z+"\n#ifndef VORONOI_HELPER\n#define VORONOI_HELPER \nfloat voronoi_distance(vec2 a,vec2 b,float metric){return distance(a,b);}float voronoi_f1_2d(in vec2 coord,in float randomness,in float flakeClamp,in float flakeRadius,inout vec3 outColor){vec2 cellPosition=floor(coord);vec2 localPosition=coord-cellPosition;float minDistance=8.;vec2 targetOffset,targetPosition;for(int j=-1;j<=1;j++){for(int i=-1;i<=1;i++){vec2 cellOffset=vec2(i,j);vec2 pointPosition=cellOffset+hash3(cellPosition+cellOffset).xy*randomness;float distanceToPoint=voronoi_distance(pointPosition,localPosition,1.);if(distanceToPoint<minDistance){targetOffset=cellOffset;minDistance=distanceToPoint;targetPosition=pointPosition;}}}float outDistance=minDistance;float dist=step(flakeRadius,outDistance);outColor=hash3(cellPosition+hash3(cellPosition+targetOffset).xy*randomness+targetOffset);vec3 outColor1=minDistance<flakeRadius?outColor:vec3(0.5,0.5,1.);outDistance=mix(dist,minDistance,flakeClamp);outColor=mix(outColor1,outColor,flakeClamp);return outDistance;}\n#endif\n\nuniform vec2 noiseBumpParams;uniform float noiseBumpScale;uniform float noiseBumpFlakeScale;uniform float noiseFlakeClamp;uniform float noiseFlakeRadius;uniform bool useColorFlakes;uniform vec4 flakeParams;uniform vec3 flakeFallOffParams;vec3 perturbNormalArb_nb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=dFdx(surf_pos.xyz);vec3 vSigmaY=dFdy(surf_pos.xyz);vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}\n":"",shaderExtender:(e,t,r)=>{if(!this.enabled||!t.materialObject.userData._noiseBumpMat?.hasBump)return;const a="#glMarker beforeAccumulation";e.fragmentShader=e.fragmentShader.replace(a,"vec3 outColor,outColor1,outColor2,outColor3,outColor4,outColor5;float distFac=length(vViewPosition.xyz);float level=1.;vec2 uvMod=noiseBumpFlakeScale*noiseBumpParams.xy*vUv*level;float voronoiDist=clamp(voronoi_f1_2d(uvMod,1.,noiseFlakeClamp,noiseFlakeRadius,outColor),0.,1.);vec3 oldNormal=normal;normal=perturbNormalArb_nb(-vViewPosition,normal,(2.*outColor.xy-1.)*noiseBumpScale,faceDirection);float oldRoughnessFactor=roughnessFactor;float oldMetalnessFactor=metalnessFactor;roughnessFactor=mix(roughnessFactor,flakeParams.x,1.-voronoiDist);metalnessFactor=mix(metalnessFactor,flakeParams.y,1.-voronoiDist);\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\nvec3 sparkleRadiance=getIBLRadiance(normalize(vViewPosition),normal,roughnessFactor);float sparkleIntensity=length(sparkleRadiance);float sparkleIntensityMultiplier=sparkleIntensity>1.3?flakeParams.z:1.;vec3 oldDiffuseColor=diffuseColor.rgb;vec2 cellPosition_=floor(uvMod);vec3 colorRGB=useColorFlakes?hash3(cellPosition_):vec3(1.);float fallOff_=mix(1.,1./(1.+flakeFallOffParams.y*distFac+flakeFallOffParams.z*distFac*distFac),flakeFallOffParams.x);diffuseColor.rgb*=mix(vec3(1.),sparkleIntensityMultiplier*colorRGB*fallOff_,vec3(1.-voronoiDist));if(sparkleIntensity<flakeParams.w){float mixFactor=1.;roughnessFactor=mix(roughnessFactor,oldRoughnessFactor,mixFactor);metalnessFactor=mix(metalnessFactor,oldMetalnessFactor,mixFactor);normal=normalize(mix(normal,oldNormal,mixFactor));diffuseColor.rgb=mix(diffuseColor.rgb,oldDiffuseColor,mixFactor);}\n#endif\n\n"+a),e.defines.USE_UV="",e.extensionDerivatives=!0},onObjectRender:(e,t)=>{const r=t.materialObject.userData?._noiseBumpMat;if(!r?.hasBump)return;this._uniforms.noiseBumpParams.value.fromArray(r.bumpNoiseParams),this._uniforms.noiseBumpScale.value=r.bumpScale,this._uniforms.noiseBumpFlakeScale.value=r.flakeScale,this._uniforms.noiseFlakeClamp.value=r.flakeClamp,this._uniforms.noiseFlakeRadius.value=r.flakeRadius,r.flakeParams&&this._uniforms.flakeParams.value.copy(r.flakeParams),r.flakeFallOffParams&&this._uniforms.flakeFallOffParams.value.copy(r.flakeFallOffParams),this._uniforms.useColorFlakes.value=r.useColorFlakes;const a=this.enabled?1:0;t.materialObject.defines.NOISE_BUMP_MATERIAL_ENABLED!==a&&(t.materialObject.defines.NOISE_BUMP_MATERIAL_ENABLED=a,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._noiseBumpMat?.hasBump?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:e=>{const t=this._viewer,r={type:"folder",label:"SparkleBump (NoiseBump)",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._noiseBumpMat?.hasBump||!1},set value(a){a!==e.materialObject.userData._noiseBumpMat?.hasBump&&(a?d(e.materialObject)||t.alert("Cannot add noise bump."):e.materialObject.userData._noiseBumpMat&&(e.materialObject.userData._noiseBumpMat.hasBump=!1,e.materialObject.needsUpdate=!0),r.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"vec4",label:"Bump Noise Params",bounds:[0,1],hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"bumpNoiseParams"],onChange:this.setDirty}),()=>({type:"slider",label:"Bump Scale",bounds:[0,.001],stepSize:1e-5,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"bumpScale"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Scale",bounds:[100,1e4],stepSize:1e-4,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"flakeScale"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Clamp",bounds:[0,1],stepSize:1,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"flakeClamp"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Radius",bounds:[.01,1],stepSize:.001,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"flakeRadius"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Roughness",bounds:[0,1],stepSize:.01,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeParams,"x"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Metalness",bounds:[0,1],stepSize:.01,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeParams,"y"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Strength",bounds:[0,100],stepSize:.001,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeParams,"z"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Threshold",bounds:[.1,10],stepSize:.001,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeParams,"w"],onChange:this.setDirty}),()=>({type:"slider",label:"Falloff",stepSize:1,bounds:[0,1],hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeFallOffParams,"x"],onChange:this.setDirty}),()=>({type:"slider",label:"Linear falloff factor",bounds:[0,10],stepSize:.001,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeFallOffParams,"y"],onChange:this.setDirty}),()=>({type:"slider",label:"Quadratic falloff factor",bounds:[0,10],stepSize:.001,hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat?.flakeFallOffParams,"z"],onChange:this.setDirty}),()=>({type:"checkbox",label:"Colored Flakes",hidden:()=>!e.materialObject.userData._noiseBumpMat?.hasBump,property:[e.materialObject.userData._noiseBumpMat,"useColorFlakes"],onChange:this.setDirty})]};return r}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(n.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(h)}async onRemove(e){return e.getPlugin(n.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(n.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};function d(e){const t=e?.userData;if(!t)return!1;t._noiseBumpMat||(t._noiseBumpMat={});const r=t._noiseBumpMat;return r.hasBump=!0,void 0===r.bumpNoiseParams&&(r.bumpNoiseParams=[.5,.5]),void 0===r.bumpScale&&(r.bumpScale=.05),void 0===r.flakeScale&&(r.flakeScale=.05),void 0===r.flakeClamp&&(r.flakeClamp=1),void 0===r.flakeRadius&&(r.flakeRadius=.3),void 0===r.useColorFlakes&&(r.useColorFlakes=!1),void 0===r.flakeParams&&(r.flakeParams=new i.Ltg(0,1,3,0)),void 0===r.flakeFallOffParams&&(r.flakeFallOffParams=new i.Pa4(0,1,0)),e.isMaterial&&(e.needsUpdate=!0),!0}u.PluginType="NoiseBumpMaterialPlugin",u.NOISE_BUMP_MATERIAL_GLTF_EXTENSION="WEBGI_materials_noise_bump",c([(0,o.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,s.qC)()],u.prototype,"enabled",void 0),u=c([(0,o.Sp)("NoiseBumpMaterial Materials")],u);class p{constructor(e){this.parser=e,this.name=u.NOISE_BUMP_MATERIAL_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];return t.userData||(t.userData={}),d(t),t.userData._noiseBumpMat=(0,s.Hx)(a,t.userData._noiseBumpMat,!1,{}),Promise.resolve()}}const h=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._noiseBumpMat)return;if(!t.userData._noiseBumpMat.hasBump)return;r.extensions=r.extensions||{};const a=(0,s.HD)(t.userData._noiseBumpMat,!1);r.extensions[u.NOISE_BUMP_MATERIAL_GLTF_EXTENSION]=a,e.extensionsUsed[u.NOISE_BUMP_MATERIAL_GLTF_EXTENSION]=!0}})},1531:function(e,t,r){r.d(t,{R:function(){return d}});var a=r(2988),i=r(4895),n=r(6533),s=r(4915),o=r(2314),l=r(5551);let c=class extends s.C{constructor(e,t,r){super(e,t,r??new u,new o.I(0,0,0),1),this.enabled=!0,this._firstCall=!0}render(e,t,r,a,i){this.enabled&&super.render(e,t,r,a,i)}};c=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s}([(0,l.Sp)("High precision Normal Buffer")],c);class u extends a.RSm{constructor(){super()}onBeforeRender(e,t,r,i,n){let s=n.material;Array.isArray(s)&&(s=s[0]),this.normalMap=s?.normalMap??null,this.bumpMap=s?.bumpMap??null,this.bumpScale=s?.bumpScale,s?.normalScale&&this.normalScale.copy(s?.normalScale),this.needsUpdate=!0,this.side=s.side??a.ehD}}class d extends i.G{passCtor(e){this._normalTarget=e.renderer.createTarget({depthBuffer:!0,type:a.cLu,minFilter:a.TyD,magFilter:a.TyD,generateMipmaps:!1}),this._normalTarget.texture.name="normalBuffer",this._normalTarget.texture.generateMipmaps=!1;const t=this._normalTarget,r=new Set,i=new Set;return new class extends c{render(e,a,s,o,l){const c=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel();this.scene&&(this.scene.traverse((({material:e})=>{e&&((e.transparent&&e.userData.renderToDepth||!e.transparent&&0===e.transmission&&!1===e.userData.renderToDepth)&&(r.add(e),e.transparent=!e.transparent),Math.abs(e.transmission||0)>0&&e.userData.renderToDepth&&(i.add([e,e.transmission]),e.transmission=0))})),(0,n.of)(e,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},(()=>super.render(e,a,t,o,l))),r.forEach((e=>e.transparent=!e.transparent)),r.clear(),i.forEach((([e,t])=>e.transmission=t)),i.clear(),e.setRenderTarget(c,u,d))}}}_update(e){if(!super._update(e))return!1;const t=this.pass.passObject;return t.scene=e.scene.modelObject,t.camera=e.scene.activeCamera.cameraObject,!0}constructor(e=!0){super(),this.passId="normalBuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this.enabled=e}getNormalBuffer(){return this._normalTarget}async onDispose(e){}async onRemove(e){return e.renderer.disposeTarget(this._normalTarget?.dispose?.()),super.onRemove(e)}updateShaderProperties(e){return e.uniforms.tNormalBuffer?e.uniforms.tNormalBuffer.value=this.enabled?this.getNormalBuffer()?.texture??null:null:console.warn("BaseRenderer: no uniform: tNormalBuffer"),this}get uiConfig(){return this.pass?.passObject.uiConfig}}d.PluginType="NormalBufferPlugin"},529:function(e,t,r){r.d(t,{o:function(){return p}});var a=r(2988),i=r(3995);class n{constructor(e){this._zee=new a.Pa4(0,0,1),this._euler=new a.USm,this._q0=new a._fP,this._q1=new a._fP(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._q2=new a._fP,this._initQuaternionDest=new a._fP,this.onScreenOrientationChangeEvent=()=>{this.screenOrientation=screen.orientation},this.onDeviceOrientationChangeEvent=e=>{this.deviceOrientation=e},this._isConnected=!1,this._viewer=e}getOffsetFromCenter(e=!0){if(!this.deviceOrientation)return new a.FM8;this.getQuaternion(e,this._q2);const t=new a.Pa4(0,0,1);return t.applyQuaternion(this._q2),new a.FM8(t.x,t.y)}getQuaternion(e,t){if(t||(t=new a._fP),!this.deviceOrientation)return t.identity();const r=this.deviceOrientation,i=null!==r.alpha?a.M8C.degToRad(r.alpha):0,n=null!==r.beta?a.M8C.degToRad(r.beta):0,s=null!==r.gamma?a.M8C.degToRad(r.gamma):0,o=this.screenOrientation?a.M8C.degToRad(this.screenOrientation.angle):0;return this._toQuaternion(t,i,n,s,o,e),t}_toQuaternion(e,t,r,a,i,n){this._euler.set(r,t,-a,"YXZ"),e.setFromEuler(this._euler),e.multiply(this._q1);const s=document.getElementById("debug");return s&&(s.textContent=i+""),e.multiply(this._q0.setFromAxisAngle(this._zee,-i)),this._initQuaternionDest.__init||(this._initQuaternionDest.copy(e).invert(),this._initQuaternionDest.__init=!0),n&&e.premultiply(this._initQuaternionDest),e}static IsCompatible(){return void 0!==window.DeviceOrientationEvent&&"ontouchstart"in window}addPermissionMessage(){this.permissionMessage=document.createElement("div"),this.permissionMessage.innerHTML="Tap on the screen to allow gyroscope",this.permissionMessage.style.visibility="visible",this.permissionMessage.style.width="100%",this.permissionMessage.style.height="40px",this.permissionMessage.style.color="black",this.permissionMessage.style.position="absolute",this.permissionMessage.style.textAlign="center",this.permissionMessage.style.fontSize="12px",this.permissionMessage.style.bottom="20%",this._viewer.container.appendChild(this.permissionMessage)}connect(){if(!this._isConnected)return this._isConnected=!0,this.onScreenOrientationChangeEvent(),!!window.DeviceOrientationEvent&&(this.askPermission(),this._viewer?.renderer.rendererObject.domElement.addEventListener("click",this.askPermission.bind(this)),window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),!0)}askPermission(){this.onScreenOrientationChangeEvent(),"function"==typeof DeviceMotionEvent.requestPermission&&(this.addPermissionMessage(),DeviceOrientationEvent.requestPermission().then((e=>{"granted"==e&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this._viewer.container.removeChild(this.permissionMessage))})).catch((e=>{console.error("DeviceOrientationControls2: Unable to use DeviceOrientation API:",e)})))}disconnect(){this._isConnected&&(this._isConnected=!1,window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this._initQuaternionDest=new a._fP)}}var s=r(4107),o=r(5551),l=r(9008);class c{constructor(){this._mousePos=new a.FM8(0,0),this._isConnected=!1}getOffsetFromCenter(){return new a.FM8(this._mousePos.x/window.innerWidth*2-1,-(this._mousePos.y/window.innerHeight*2-1))}connect(){this._isConnected||(this._isConnected=!0,window.addEventListener("mousemove",this._onMouseMove.bind(this)))}disconnect(){this._isConnected&&(this._isConnected=!1,window.removeEventListener("mousemove",this._onMouseMove.bind(this)))}_onMouseMove(e){this._mousePos.set(e.clientX,e.clientY)}}var u,d=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let p=u=class extends i.Q{constructor(){super(),this.enabled=!1,this.enableEdit=!1,this.invert=!1,this.sensitivity=.5,this.focalPointHit=new a.Pa4(0,0,0),this.damping=.5,this.cameraView="",this._target=new a.Pa4,this._center=new a.Pa4,this._pointerDown=!1,this._focalDistance=100,this._updateProjectionMatrix=()=>{if(!this.enabled)return void this._object._updateProjectionMatrixParallax?.();const e=this._object,t=e.near;let r=t*Math.tan(.5*a.M8C.DEG2RAD*e.fov)/e.zoom,i=2*r,n=e.aspect*i,s=-.5*n;if(null!==e.view&&e.view.enabled){const t=e.view.fullWidth,a=e.view.fullHeight;s+=e.view.offsetX*n/t,r-=e.view.offsetY*i/a,n*=e.view.width/t,i*=e.view.height/a}s-=this._offX*t/this._focalDistance,r-=this._offY*t/this._focalDistance;const o=e.filmOffset;0!==o&&(s+=t*o/e.getFilmWidth()),e.projectionMatrix.makePerspective(s,s+n,r,r-i,t,e.far),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()},this._preFrame=e=>{this.update(e.deltaTime)},this._offX=0,this._offY=0,this._xDamper=new l.Damper,this._yDamper=new l.Damper,this._onEnabledChange=this._onEnabledChange.bind(this),this._onDampingChange=this._onDampingChange.bind(this),this._onObjectHit=this._onObjectHit.bind(this),this._onActiveCameraChange=this._onActiveCameraChange.bind(this)}async onAdded(e){await super.onAdded(e),n.IsCompatible()?this._input=new n(e):this._input=new c,e.scene.addEventListener("activeCameraChange",this._onActiveCameraChange),this.addIndicator(),e.addEventListener("preFrame",this._preFrame),this._viewer?.container.addEventListener("pointerdown",this.onPointerDown.bind(this)),this._viewer?.container.addEventListener("pointerup",this.onPointerUp.bind(this)),e.getPluginByType("Picking")?.addEventListener("hitObject",this._onObjectHit),this._onEnabledChange()}_onActiveCameraChange(){this._object&&this._object?._updateProjectionMatrixParallax&&(this._object.updateProjectionMatrix=this._object._updateProjectionMatrixParallax,delete this._object._updateProjectionMatrixParallax),this._focalDistance=.01,this._object=this._viewer?.scene.activeCamera.cameraObject,this._object?.isOrthographicCamera?this._viewer?.console.warn("ParallaxCameraControllerPlugin: Orthographic camera is not supported"):this.enabled&&(this._object._updateProjectionMatrixParallax=this._object.updateProjectionMatrix,this._object.updateProjectionMatrix=this._updateProjectionMatrix)}addIndicator(){this._viewer&&(this._indicator&&this._indicator.remove(),this._indicator=document.createElement("div"),this._indicator.style.width="40px",this._indicator.style.height="40px",this._indicator.style.borderRadius="100%",this._indicator.style.border="4px solid #ff4444",this._indicator.style.transform="translate(-50%, -50%)",this._indicator.style.position="absolute",this._indicator.style.top="0",this._indicator.style.left="0",this._indicator.style.zIndex="10000",this._indicator.style.opacity="0",this._indicator.style.transition="opacity 0.5s",this._indicator.style.pointerEvents="none",this._viewer?.container.appendChild(this._indicator))}onPointerDown(e){this.enabled&&this._viewer&&(this._pointerDown=!0,this.enableEdit&&this._indicator&&(this._indicator.style.top=e.clientY-this._viewer.container.offsetTop+"px",this._indicator.style.left=e.clientX-this._viewer.container.offsetLeft+"px"))}onPointerUp(){this._pointerDown=!1}update(e){if(!this.enabled||this._pointerDown||!this._input||!this._object||!this._viewer)return;this._viewer.scene.activeCamera.interactionsEnabled=!1,this._updateFocalDistance();const t=this._object.matrixWorld.elements,r=new a.Pa4(t[0],t[1],t[2]),i=new a.Pa4(t[4],t[5],t[6]);this._object.position.copy(this._center),this._viewer.scene.activeCamera.positionUpdated();let n=this.sensitivity;this.invert&&(n*=-1),this._offX=this._xDamper.update(this._offX,this._input.getOffsetFromCenter().x*n,e,1),this._offY=this._yDamper.update(this._offY,this._input.getOffsetFromCenter().y*n,e,1);const s=this._object;s.position.add(i.multiplyScalar(this._offY)).add(r.multiplyScalar(this._offX)),s.updateProjectionMatrix(),s.updateMatrixWorld(),this._dirty=!0}_onObjectHit(e){e.intersects.intersect&&this.enableEdit&&(this.focalPointHit.copy(e.intersects.intersect.point),e.intersects.selectedObject=null,this.uiConfig?.uiRefresh?.("postFrame",!0),this._indicator&&(this._indicator.style.display="block",this._indicator.style.opacity="1",setTimeout((()=>{this._indicator.style.opacity="0",setTimeout((()=>this._indicator.style.display="none"),600),this.uiConfig?.uiRefresh?.("postFrame",!0)}),200)))}_updateFocalDistance(){if(!this._object)return;const e=this._object,t=new a.Pa4;e.getWorldDirection(t),t.normalize(),this._focalDistance=this.focalPointHit.clone().sub(e.position).dot(t)}_onEnabledChange(){if(this._viewer){if(this.enabled){if(this._input?.connect(),this._onActiveCameraChange(),!this._object)return;this._viewer.scene.activeCamera.interactionsEnabled=!1;const e=this._viewer.getPluginByType("CameraViews"),t=e?.camViews.find((e=>e.name===this.cameraView));e&&t&&e.setCurrentCameraView(t),this._updateFocalDistance(),this._center.copy(this._object.position),this._object.lookAt(this._viewer.scene.activeCamera.target)}else if(this._object){this._onActiveCameraChange(),this._viewer.scene.activeCamera.interactionsEnabled=!0,this._object.position.copy(this._center),this._object.lookAt(this._viewer.scene.activeCamera.target);const e=this._object;e.updateProjectionMatrix(),e.updateMatrixWorld()}this.uiConfig?.uiRefresh?.("postFrame",!0)}}_onDampingChange(){this._xDamper&&this._yDamper&&(this._xDamper.setDecayTime(100*this.damping),this._yDamper.setDecayTime(100*this.damping))}dispose(){this._input?.disconnect()}};p.PluginType="ParallaxCameraControllerPlugin",d([(0,l.onChange)(u.prototype._onEnabledChange),(0,s.qC)(),(0,o.Q7)("Enabled")],p.prototype,"enabled",void 0),d([(0,s.qC)(),(0,o.Q7)("enableEdit")],p.prototype,"enableEdit",void 0),d([(0,s.qC)(),(0,o.Q7)("Invert")],p.prototype,"invert",void 0),d([(0,s.qC)(),(0,o.t8)("Sensitivity",[.1,2],.01)],p.prototype,"sensitivity",void 0),d([(0,s.qC)("focalPoint"),(0,o.KG)("Focal Point Hit",void 0,.001)],p.prototype,"focalPointHit",void 0),d([(0,l.onChange)(u.prototype._onDampingChange),(0,s.qC)(),(0,o.t8)("Damping",[0,1],.001)],p.prototype,"damping",void 0),d([(0,s.qC)(),(0,o.ri)("Camera View")],p.prototype,"cameraView",void 0),p=u=d([(0,o.Sp)("Parallax Camera Controller")],p)},6695:function(e,t,r){r.d(t,{_:function(){return p}});var a=r(3995),i=r(9008),n=r(2988);class s{async apply(e,t,r){if(!t)return void(this.selected=void 0);let a=this.presets.find((e=>function(e,t){return("string"==typeof e?e:e.path)===("string"==typeof t?t:t.path)}(e,t)));return a||(this.presets.push(t),a=t),this.selected=a,"string"!=typeof a?e.getManager()?.importer?.importAsset(a,r):e.getManager()?.importer?.importPath(a,r)}constructor(e){this.presets=[],this.name="",this.selected=void 0,e&&(this.name=e)}}class o extends s{constructor(){super(...arguments),this.name="Background"}async apply(e,t){const r=await super.apply(e,t),a=r?.[0];return a&&(a.colorSpace=n.KI_,e.scene.background=a),a}}class l extends s{constructor(){super(...arguments),this.name="Environment"}async apply(e,t){const r=await super.apply(e,t),a=r?.[0];return a&&(e.scene.environment=a),a}}class c extends s{constructor(){super(...arguments),this.name="GemEnvironment"}async apply(e,t){const r=await super.apply(e,t),a=r?.[0];return(0,i.safeSetProperty)(e.getPluginByType("Diamond"),"envMap",a),a}}class u extends s{async apply(e,t){const r=await super.apply(e,t,{processImported:!1});return r?e.getManager()?.importer?.processImported(r):void 0}}class d extends u{constructor(){super(...arguments),this.name="MaterialLibraries"}async apply(e,t){const r=await super.apply(e,t);return r&&await e.alert("Material Library successfully imported."),r}}class p extends a.Q{constructor(){super(...arguments),this.toJSON=null,this.enabled=!0,this.presetGroups=[],this.uiConfig={type:"folder",label:"Presets",expanded:!0,limitedUi:!0,children:[()=>this.presetGroups.map((e=>({type:"dropdown",label:e.name,limitedUi:!0,children:[{value:"",label:"none"},...e.presets.map((e=>({label:h(e)?.split("/").pop()||"",value:h(e)})))],getValue:()=>h(e.selected)||"",setValue:t=>{e.apply(this._viewer,e.presets.find((e=>h(e)===t)))}}))),{type:"button",label:"Download Selection",limitedUi:!0,value:()=>{const e=this.exportPresets();(0,i.downloadFile)(new File([JSON.stringify(e,null,2)],"preset.template.json",{type:"application/json"}))}},{type:"button",label:"Export Preset Groups",limitedUi:!1,value:()=>{const e=this.exportPresetGroups();(0,i.downloadFile)(new File([JSON.stringify(e,null,2)],"presetGroups.json",{type:"application/json"}))}}]}}async onAdded(e){await super.onAdded(e),this.presetGroups.push(new o),this.presetGroups.push(new l),this.presetGroups.push(new c),this.presetGroups.push(new u("Ground")),this.presetGroups.push(new u("CameraViews")),this.presetGroups.push(new u("MaterialConfiguration")),this.presetGroups.push(new d),this.uiConfig.uiRefresh?.("postFrame",!0)}exportPresets(){const e=Object.fromEntries(this.presetGroups.map((e=>[e.name,h(e.selected)||void 0])).filter((([,e])=>e)));return e.type=p.PluginType,e}async fromJSON(e,t){if(!super.fromJSON(e,t))return null;const r={...e};delete r.type;const a=[];for(const[e,t]of Object.entries(r)){const r=this.presetGroups.find((t=>t.name===e)),i=r?.presets;if(!r||!i)continue;const n="string"==typeof t?{path:t}:t;a.push(r.apply(this._viewer,n))}return await Promise.all(a),this.uiConfig.uiRefresh?.("postFrame",!0),this}async loadPresetGroups(e){"string"==typeof e&&e.startsWith("http")&&(e=await fetch(e).then((async e=>e.json())));for(const[t,r]of Object.entries(e)){const e=this.presetGroups.find((e=>e.name===t))?.presets;e?.push(...r)}}exportPresetGroups(){return Object.fromEntries(this.presetGroups.map((e=>[e.name,e.presets.map(h)])).filter((([,e])=>e.length>0)))}}function h(e){return e&&"string"!=typeof e?e.path:e}p.PluginType="PresetLibraryPlugin"},4388:function(e,t,r){r.d(t,{F:function(){return l}});var a=r(2988),i=r(8160),n=r(4107),s=r(3995),o=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};class l extends s.Q{get cameraHelper(){return this._cameraHelper}constructor(e=!0){super(),this.enabled=!0,this.light=new i.B("#cceeff",1),this.lightLayers=1,this._preRender=()=>{if(!this.enabled)return void(this.light.layers.mask=0);const e=this._viewer?.renderer.frameCount??0;this.light.randomizePosition(e<5?0:e),this.light.layers.mask=this.lightLayers,this.light.updateShadowParams(),this._cameraHelper?.update()},this._setDirty=this._setDirty.bind(this),this.enabled=e}async onAdded(e){await super.onAdded(e),this._cameraHelper=new a.Rki(this.light.shadow.camera),this._cameraHelper.visible=!1,this._cameraHelper.userData.bboxVisible=!1,e.scene.add(this._cameraHelper),e.scene.addLight(this.light,{addToRoot:!0}),e.addEventListener("preRender",this._preRender)}async onRemove(e){return e.removeEventListener("preRender",this._preRender),this.light.removeFromParent(),super.onRemove(e)}_setDirty(e=!1){e?this._viewer?.scene.setDirty():this._viewer?.setDirty()}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Progressive Shadow",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"],onChange:this._setDirty},{type:"folder",label:"Directional Light",children:[{type:"checkbox",label:"Visible",property:[this.light,"visible"],onChange:this._setDirty},{type:"slider",label:"Intensity",bounds:[0,10],property:[this.light,"intensity"],onChange:this._setDirty},{type:"color",label:"Color",property:[this.light,"color"],onChange:this._setDirty},{type:"checkbox",label:"Shadow Enabled",property:[this.light.shadowParams,"enabled"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[0,1],property:[this.light.randomParams,"focus"],onChange:this._setDirty},{type:"slider",bounds:[0,1],property:[this.light.randomParams,"spread"],onChange:this._setDirty},{type:"slider",bounds:[.01,60],property:[this.light.randomParams,"distanceScale"],onChange:this._setDirty},{type:"vec3",bounds:[-5,5],property:[this.light.randomParams,"direction"],onChange:this._setDirty},{type:"slider",bounds:[.01,10],property:[this.light.shadowParams,"radius"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[.01,30],property:[this.light.shadowParams,"frustumSize"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[-.01,.01],property:[this.light.shadowParams,"bias"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[-.05,.05],property:[this.light.shadowParams,"normalBias"],onChange:[this.light.updateShadowParams,this._setDirty]}]}]}}}l.PluginType="RandomizedDirectionalLight",o([(0,n.qC)()],l.prototype,"enabled",void 0),o([(0,n.qC)("rdLight")],l.prototype,"light",void 0),o([(0,n.qC)()],l.prototype,"lightLayers",void 0)},5454:function(e,t,r){r.d(t,{r:function(){return y}});var a=r(6757),i=r(7245),n=r(2988),s=r(7320),o=r(3198),l=r(5130),c=r(9008),u=r(1531),d=r(5551),p=r(8670);function h(e){const t=e?.userData;if(!t)return!1;t._ssBevel||(t._ssBevel={});const r=t._ssBevel;return r.hasSSBevel=!0,void 0===r.radius&&(r.radius=0),e.isMaterial&&(e.needsUpdate=!0),!0}let m=class extends i.Hl{constructor(e,t,r,a){super({defines:{NUM_SAMPLES:16},uniforms:{tNormalDepth:{value:null},tNormalBuffer:{value:null},tGBufferFlags:{value:null},edgeMaskBuffer:{value:null},screenSize:{value:new n.FM8},radius:{value:1},samples:{value:null},frameCount:{value:0},cameraPositionWorld:{value:new n.Pa4(1,1,1)}},vertexShader:s.Z,fragmentShader:`\n\n            ${r}\n\n            ${o.Z}\n\n            uniform sampler2D tNormalBuffer;uniform sampler2D edgeMaskBuffer;uniform vec2 screenSize;const float depthStep=0.02;uniform vec2 samples[NUM_SAMPLES];uniform vec3 cameraPositionWorld;varying vec2 vUv;\n#include <common>\nfloat getBevelRadius(in float number){return floor(number/8.);}vec3 smoothNormal(){vec2 uv=gl_FragCoord.xy/screenSize;vec4 texel=texture2D(tNormalDepth,uv);vec4 edgeMask=texture2D(edgeMaskBuffer,uv);vec3 avgNormal=2.*texture2D(tNormalBuffer,uv).rgb-1.;float depth=pow(unpack16(texel.xy),2.);vec2 invScreenSize=vec2(1.)/screenSize;vec4 mask=texture2D(tGBufferFlags,uv);float weightSum=0.;float radius=getBevelRadius(mask.g*255.)*2.;float randomAngle=6.2*random(frameCount*0.1);float theta=randomAngle;float snTheta=sin(theta);float csTheta=cos(theta);mat2 randomRotationMatrix=mat2(csTheta,snTheta,-snTheta,csTheta);float d_=dot(cameraPositionWorld,cameraPositionWorld);float radiusModifier=clamp(1./(1.+pow(d_,0.5)),0.,1.);for(int i=0;i<5;i++){float x=float(i)-2.;for(int j=0;j<5;j++){float y=float(j)-2.;vec2 offset=randomRotationMatrix*vec2(x,y)*radius*radiusModifier*invScreenSize;vec4 texel=texture2D(tNormalDepth,uv+offset);float offsetDepth=pow(unpack16(texel.xy),2.);float depthWeight=abs(offsetDepth-depth);depthWeight=(1.-step(depthStep,depthWeight));vec3 offsetNormal=2.*texture2D(tNormalBuffer,uv+offset).rgb-1.;if(dot(offsetNormal,offsetNormal)>0.){avgNormal+=offsetNormal*depthWeight;}}}return normalize(avgNormal);}void main(){vec2 uv=gl_FragCoord.xy/screenSize;vec4 edgeMask=texture2D(edgeMaskBuffer,uv);vec3 normal=vec3(0.);if(edgeMask.x>0.){normal=smoothNormal();}else{normal=2.*texture2D(tNormalBuffer,uv).rgb-1.;}gl_FragColor=vec4(vec3(0.5*normal+0.5),1.);}\n            \n            `},"tDiffuse"),this.uiConfig=void 0,this.materialExtension={shaderExtender:(e,t,r)=>{this.enabled&&t.materialObject.userData?._ssBevel?.hasSSBevel&&(e.fragmentShader=(0,p.p)(e.fragmentShader,"#include <normal_fragment_maps>"," \n                normal = 2. * texture2D(tSSBevelMap, viewToScreen(vViewPosition.xyz).xy).rgb - 1.;\n                normal = normalize(normal);\n                //geometryNormal = normal;\n            "))},onObjectRender:(e,t,r)=>{if(!this.enabled||!t.materialObject.userData?._ssBevel?.hasSSBevel)return;const a=t.materialObject,i=this._target.texture;this.materialExtension.extraUniforms.tSSBevelMap.value!==i&&(this.materialExtension.extraUniforms.tSSBevelMap.value=i,a.needsUpdate=!0)},getUiConfig:e=>{const t={type:"folder",label:"SSBevel (Dev)",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._ssBevel?.hasSSBevel||!1},set value(r){r!==e.materialObject.userData._ssBevel?.hasSSBevel&&(r?h(e.materialObject)||alert("Cannot add screen space bevel."):e.materialObject.userData._ssBevel&&(e.materialObject.userData._ssBevel.hasSSBevel=!1,e.materialObject.needsUpdate=!0),t.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[0,8],label:"radius",hidden:()=>!e.materialObject.userData._ssBevel?.hasSSBevel,property:[e.materialObject.userData._ssBevel,"radius"],onChange:this.setDirty})]};return t},parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData?._ssBevel?.hasSSBevel?c.glsl`
            uniform sampler2D tSSBevelMap;
            ${l.Z}
            `:"",extraUniforms:{tSSBevelMap:{value:null}},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._ssBevel?.hasSSBevel?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2},this._target=t,this.needsSwap=!1,this.clear=!0,this._viewerApp=a,this._edgeMaterial=new i.mT({uniforms:{tNormalDepth:{value:null},tNormalBuffer:{value:null},tGBufferFlags:{value:null},screenSize:{value:null},radius:{value:10},cameraNearFar:{value:new n.FM8(1,1)},cameraPositionWorld:{value:new n.Pa4(1,1,1)}},vertexShader:s.Z,fragmentShader:"uniform vec2 screenSize;uniform sampler2D tNormalDepth;uniform sampler2D tNormalBuffer;uniform sampler2D tGBufferFlags;uniform float radius;uniform vec2 cameraNearFar;uniform vec3 cameraPositionWorld;const float depthStep=0.2;const float normalThreshold=0.9;float unpack16(vec2 value){return(value.x*0.996108949416342426275150501169264316558837890625+value.y*0.00389105058365758760263730664519243873655796051025390625);}vec3 unpackNormal(vec2 enc){vec2 fenc=enc*4.-2.;float f=dot(fenc,fenc);float g=sqrt(1.-f/4.);return vec3(fenc*g,1.-f/2.);}void lookupNormalDepth(out float depth,out vec3 normal,vec2 off){vec2 uv=(gl_FragCoord.st+off)/screenSize;vec4 texel=texture2D(tNormalDepth,uv);depth=mix(cameraNearFar.x,cameraNearFar.y,pow(unpack16(texel.xy),2.));normal=2.*texture2D(tNormalBuffer,uv).rgb-1.;}float getBorderWeight(){float depth1,depth2,depth3,depth4;vec3 normal1,normal2,normal3,normal4;float d_=dot(cameraPositionWorld,cameraPositionWorld);float radiusModifier=clamp(3./(1.+pow(d_,0.5)),0.,1.);float modRad=radius;lookupNormalDepth(depth1,normal1,vec2(0.,modRad));lookupNormalDepth(depth2,normal2,vec2(0.,-modRad));lookupNormalDepth(depth3,normal3,vec2(modRad,0.));lookupNormalDepth(depth4,normal4,vec2(-modRad,0.));vec2 uv=(gl_FragCoord.st)/screenSize;float mask=step(0.0001,texture2D(tGBufferFlags,uv).g);float mask1=texture2D(tGBufferFlags,uv+vec2(0.,modRad)/screenSize).b*255.;float mask2=texture2D(tGBufferFlags,uv+vec2(0.,-modRad)/screenSize).b*255.;float mask3=texture2D(tGBufferFlags,uv+vec2(modRad,0.)/screenSize).b*255.;float mask4=texture2D(tGBufferFlags,uv+vec2(-modRad,0.)/screenSize).b*255.;float maskWeight=max(abs(mask1-mask2),abs(mask3-mask4))*255.;maskWeight=(step(maskWeight,0.01));float a1=dot(normal1,normal2);float a2=dot(normal3,normal4);float normalWeight=min(abs(a1),abs(a2));normalWeight=1.-step(normalThreshold,normalWeight);float depthWeight=max(abs(depth1-depth2),abs(depth3-depth4));depthWeight=(step(depthWeight,depthStep));return normalWeight*depthWeight*maskWeight*mask;}void main(){float weight=getBorderWeight();vec2 uv=gl_FragCoord.st/screenSize;vec4 texel=texture2D(tNormalDepth,uv);float depth=pow(unpack16(texel.xy),2.);vec3 outColor=vec3(0.);if(depth>0.999){weight=0.;}else{outColor=vec3(weight);}gl_FragColor=vec4(outColor,1.);}"}),this._separableBlurMaterial=new i.mT({defines:{KERNEL_RADIUS:3,SIGMA:3},uniforms:{colorTexture:{value:null},maskTexture:{value:null},texSize:{value:new n.FM8(.5,.5)},direction:{value:new n.FM8(.5,.5)}},vertexShader:s.Z,fragmentShader:"varying vec2 vUv;uniform sampler2D colorTexture;uniform sampler2D maskTexture;uniform vec2 texSize;uniform vec2 direction;float gaussianPdf(in float x,in float sigma){return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;}void main(){vec2 invSize=1./texSize;float fSigma=float(SIGMA);float weightSum=gaussianPdf(0.,fSigma);vec4 mask=texture2D(maskTexture,vUv);vec3 diffuseSum=texture2D(colorTexture,vUv).rgb*weightSum;for(int i=1;i<KERNEL_RADIUS;i++){float x=float(i);float w=gaussianPdf(x,fSigma);vec2 uvOffset=direction*invSize*x;vec3 sample1=texture2D(colorTexture,vUv+uvOffset).rgb;vec3 sample2=texture2D(colorTexture,vUv-uvOffset).rgb;diffuseSum+=(sample1+sample2)*w;weightSum+=2.*w;}gl_FragColor=vec4(diffuseSum/weightSum,1.);}"})}render(e,t,r,i,s){if(!this.enabled)return;const o=e.baseRenderer,l={minFilter:n.wem,magFilter:n.wem,isAntialiased:!1,format:n.wk1,depthBuffer:!1,generateMipmaps:!1},c=o.getTempTarget(l);this._renderEdges(o,c),this._blurEdges(o,c),this._viewerApp.scene.activeCamera.updateShaderProperties(this.material),this._viewerApp.getPlugin(a.m)?.updateShaderProperties(this.material),this._viewerApp.getPlugin(u.R)?.updateShaderProperties(this.material),this._viewerApp.renderer.updateShaderProperties(this.material),this.uniforms.edgeMaskBuffer.value=c.texture,super.render(e,this._target,c,i,s),o.releaseTempTarget(c)}_initsamples(){const e=[],t=1/8;return e.push(new n.FM8(-8,0).multiplyScalar(t)),e.push(new n.FM8(-6,-4).multiplyScalar(t)),e.push(new n.FM8(-3,-2).multiplyScalar(t)),e.push(new n.FM8(-2,-6).multiplyScalar(t)),e.push(new n.FM8(1,-1).multiplyScalar(t)),e.push(new n.FM8(2,-5).multiplyScalar(t)),e.push(new n.FM8(6,-7).multiplyScalar(t)),e.push(new n.FM8(5,-3).multiplyScalar(t)),e.push(new n.FM8(4,1).multiplyScalar(t)),e.push(new n.FM8(7,4).multiplyScalar(t)),e.push(new n.FM8(3,5).multiplyScalar(t)),e.push(new n.FM8(0,7).multiplyScalar(t)),e.push(new n.FM8(-1,3).multiplyScalar(t)),e.push(new n.FM8(-4,6).multiplyScalar(t)),e.push(new n.FM8(-7,8).multiplyScalar(t)),e.push(new n.FM8(-5,2).multiplyScalar(t)),e}_blurEdges(e,t){const r={minFilter:n.wem,magFilter:n.wem,isAntialiased:!1,format:n.wk1,depthBuffer:!1,generateMipmaps:!1,sizeMultiplier:.5},a=e.getTempTarget(r),i=t.texture.image?.width||1,s=t.texture.image?.height||1;this._separableBlurMaterial.uniforms.texSize.value=new n.FM8(i,s),this._separableBlurMaterial.uniforms.colorTexture.value=t.texture,this._separableBlurMaterial.uniforms.direction.value=new n.FM8(1,0),e.blit(void 0,a,{material:this._separableBlurMaterial}),this._separableBlurMaterial.uniforms.texSize.value=new n.FM8(i/2,s/2),this._separableBlurMaterial.uniforms.colorTexture.value=a.texture,this._separableBlurMaterial.uniforms.direction.value=new n.FM8(0,1),e.blit(void 0,t,{material:this._separableBlurMaterial}),e.releaseTempTarget(a)}_renderEdges(e,t){const r=t.texture.image?.width||1,i=t.texture.image?.height||1;this._edgeMaterial.uniforms.screenSize.value=new n.FM8(r,i),this._viewerApp.scene.activeCamera.updateShaderProperties(this._edgeMaterial),this._viewerApp.getPlugin(a.m)?.updateShaderProperties(this._edgeMaterial),this._viewerApp.getPlugin(u.R)?.updateShaderProperties(this._edgeMaterial),e.blit(void 0,t,{material:this._edgeMaterial})}};m=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s}([(0,d.Sp)("SSBevel")],m);var f=r(4821),g=r(4895),v=r(4107),_=r(9354);class y extends g.G{get bevelTarget(){return this._bevelTarget}constructor(e=!0){super(),this.passId="ssBevel",this._beforeFilters=["render"],this._afterFilters=["gbuffer","normalBuffer"],this._requiredFilters=["render","gbuffer","normalBuffer"],this._lastEnabled=!1,this.dependencies=[f.k,a.m,u.R],this.enabled=e,this.setDirty=this.setDirty.bind(this),this._loaderCreate=this._loaderCreate.bind(this),this.updateGBuffer=this.updateGBuffer.bind(this)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new b(e)))}passCtor(e){this._bevelTarget=e.renderer.createTarget({depthBuffer:!0,type:n.cLu,minFilter:n.TyD,magFilter:n.TyD,generateMipmaps:!1}),this._bevelTarget.texture.name="bevelBuffer",this._bevelTarget.texture.generateMipmaps=!1;const t=e.getPluginByType("debug");return t&&t.addTexture("tempBuffer",(()=>this._bevelTarget.texture),[440,50,400,200]),new m(e.renderer,this._bevelTarget,e.getPlugin(a.m)?.getUnpackSnippet()??"",e)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(f.k);return this.pass?.passObject.materialExtension&&t?.materials?.registerMaterialExtension(this.pass?.passObject.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(x),e.getPlugin(a.m)?.registerGBufferUpdater(this.updateGBuffer),super.onAdded(e)}async onRemove(e){return e.renderer.disposeTarget(this._bevelTarget),super.onRemove(e)}setDirty(){this._viewer?.setDirty(),this.pass?.passObject.materialExtension.setDirty?.()}_update(e){let t=this.enabled;if(t&&!this._lastEnabled){const e=this._viewer?.getPluginByType("NormalBufferPlugin");e&&!e.enabled&&(e.enabled=!0),e||this._viewer?.console.error("SSBevelPlugin needs NormalBufferPlugin")}return this._lastEnabled=t,t}get uiConfig(){const e=this.pass?.passObject?.uiConfig??{};return e.children?.map((e=>(0,c.getOrCall)(e)))?.flat(2).forEach((e=>e&&(e.onChange=this.setDirty))),e}updateGBuffer(e,t){if(e instanceof n.Kj0&&e.material?.userData){for(let e=3;e<8;e++)t.y=(0,_.o)(t.y,e);let r=e.material?.userData._ssBevel?e.material?.userData._ssBevel.radius:0;r=Math.min(r,31),r<<=3,t.y=t.y|r}}}y.PluginType="SSBevelPlugin",y.SSBEVEL_GLTF_EXTENSION="WEBGI_materials_ssbevel";class b{constructor(e){this.parser=e,this.name=y.SSBEVEL_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];return t.userData||(t.userData={}),h(t),t.userData._ssBevel=(0,v.Hx)(a,t.userData._ssBevel,!1,{}),Promise.resolve()}}const x=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._ssBevel)return;if(!t.userData._ssBevel.hasSSBevel)return;r.extensions=r.extensions||{};const a=(0,v.HD)(t.userData._ssBevel,!1);r.extensions[y.SSBEVEL_GLTF_EXTENSION]=a,e.extensionsUsed[y.SSBEVEL_GLTF_EXTENSION]=!0}})},2875:function(e,t,r){r.d(t,{j:function(){return b}});var a,i=r(3995),n=r(2988),s=r(9008),o=r(5804),l=r(3138),c=r(9033),u=r(3198),d=r(7337),p=r(6757),h=r(439),m=r(4821),f=r(6533),g=r(4107),v=r(5551),_=r(8670),y=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let b=a=class extends i.Q{constructor(e=!0){super(),this.enabled=!0,this.radius=.015,this.intensity=1,this.tolerance=1.5,this._defines={},this.onlySSCSDebug=!1,this.stepCount=2,this.dependencies=[p.m,m.k],this.materialExtension={shaderExtender:(e,t,r)=>{if(!e.defines.SSCS_ENABLED)return;const a=s.glsl`
                #ifndef D_sceneBoundingRadius
                #define D_sceneBoundingRadius
                uniform float sceneBoundingRadius;
                #endif
                float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, vec3 lightDirection ) {
                    vec3 ray_origin_view = -vViewPosition;
                    float rnd = interleavedGradientNoise(gl_FragCoord.xy, frameCount+34.);
                    float cameraDist = length(cameraPositionWorld);
//                    float radius = mix((cameraNearFar.y) + ray_origin_view.z, -ray_origin_view.z - cameraNearFar.x, rnd * 0.5 + 0.5)*sscsRadius;
                    float radius = mix((cameraDist + sceneBoundingRadius) + ray_origin_view.z, -ray_origin_view.z - max(0.0, cameraDist - sceneBoundingRadius), rnd * 0.5 + 0.5)*sscsRadius;
                    vec3 state = vec3(1.,(rnd+0.5)/float(SSCS_STEP_COUNT),2.);
                    traceRay(ray_origin_view, normalize(lightDirection) * radius, sscsTolerance * radius * 2., state, SSCS_STEP_COUNT);
                    state.z = state.z > 0.99 ? 1. : max(0.,min(state.z * state.z * (1.-sscsIntensity), 1.));
                    
                #if defined(SSCS_DEBUG) && SSCS_DEBUG > 0
                    return state.z;
                #endif
            `,i=`\n#if SSCS_ENABLED\n\n    uniform float sscsIntensity;\n    uniform float sscsRadius;\n    uniform float sscsTolerance;\n\n    ${o.Z}\n    \n    #define THREE_PACKING_INCLUDED\n    ${l.Z}\n    \n    ${c.Z}\n    ${u.Z}\n    \n    ${d.Z}\n\n#endif\n            \n            `+n.WdD.shadowmap_pars_fragment.replace("float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {",`${a}\n`).replace("return shadow;","return min(shadow, state.z);");e.fragmentShader=e.fragmentShader.replace("#include <shadowmap_pars_fragment>",i),e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",n.WdD.lights_fragment_begin),e.fragmentShader=(0,_.p)(e.fragmentShader,"directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ], directLight.direction ) : 1.0;"),e.fragmentShader=(0,_.p)(e.fragmentShader,"directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;","directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ], directLight.direction ) : 1.0;")},onObjectRender:(e,t,r)=>{const a=t.materialObject;let i=this.enabled&&!1!==r.userData.screenSpaceRendering&&!a.userData?.sscsDisabled?1:0;a.defines.SSCS_ENABLED!==i&&(a.defines.SSCS_ENABLED=i,a.needsUpdate=!0),i=this._defines.SSCS_STEP_COUNT,a.defines.SSCS_STEP_COUNT!==i&&(a.defines.SSCS_STEP_COUNT=i,a.needsUpdate=!0),i=+this._defines.SSCS_DEBUG,a.defines.SSCS_DEBUG!==i&&(a.defines.SSCS_DEBUG=i,a.needsUpdate=!0)},parsFragmentSnippet:()=>"\n",extraUniforms:{...a._uniforms},computeCacheKey:e=>this.enabled?"1":"0",isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[this._viewer?.getPlugin(p.m),this._viewer?.getPlugin(h.E),this._viewer?.scene.activeCamera,this._viewer?.renderer,this._viewer?.scene]},this.enabled=e,this.userData={setDirty:()=>{this._viewer?.setDirty()}}}async onAdded(e){await super.onAdded(e),e.getPlugin(m.k)?.materials?.registerMaterialExtension(this.materialExtension)}async onRemove(e){return e.getPlugin(m.k)?.materials?.unregisterMaterialExtension(this.materialExtension),super.onRemove(e)}};b.PluginType="SSContactShadows",b._uniforms={tNormalDepth:{value:null},frameCount:{value:0},projection:{value:new n.yGw},cameraPositionWorld:{value:new n.Pa4},cameraNearFar:{value:new n.FM8(.1,1e3)},sceneBoundingRadius:{value:0}},y([(0,v.Q7)("Enabled"),(0,g.qC)()],b.prototype,"enabled",void 0),y([(0,f.e5)({uniforms:a._uniforms,propKey:"sscsRadius"}),(0,v.t8)("Radius",[1e-4,.1],1e-4),(0,g.qC)()],b.prototype,"radius",void 0),y([(0,f.e5)({uniforms:a._uniforms,propKey:"sscsIntensity"}),(0,v.t8)("Intensity",[1e-4,1],1e-4),(0,g.qC)()],b.prototype,"intensity",void 0),y([(0,f.e5)({uniforms:a._uniforms,propKey:"sscsTolerance"}),(0,v.t8)("Tolerance",[.1,5]),(0,g.qC)()],b.prototype,"tolerance",void 0),y([(0,f.lD)("SSCS_DEBUG",void 0,!0),(0,v.Q7)("Debug only SSCS"),(0,g.qC)()],b.prototype,"onlySSCSDebug",void 0),y([(0,f.lD)("SSCS_STEP_COUNT",void 0,!0),(0,v.t8)("Step count",[1,8],1),(0,g.qC)()],b.prototype,"stepCount",void 0),b=a=y([(0,v.Sp)("Screen Space Contact Shadows")],b)},922:function(e,t,r){r.d(t,{s:function(){return D}});var a=r(6757),i=r(3415),n=r(439),s=r(7245),o=r(7320),l=r(3138),c=r(3198),u=r(9698),d=r(7337),p=r(5804),h=r(5130),m=r(2988),f=r(9008),g=r(6533),v=r(5551),_=r(4107),y=r(8284),b=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};class x extends s.Hl{get ssgiEnabled(){return parseInt(this.material.defines.SSGI_ENABLED)>.5}set ssgiEnabled(e){e=e&&this._giActivated,this.material.defines.SSGI_ENABLED=e?1:0,this.material.needsUpdate=!0}constructor(e,t,r,a=!1){super({vertexShader:o.Z,fragmentShader:`\n\n${p.Z}\n${l.Z}\n${c.Z}\n${u.Z}\n${r}\n\n${d.Z}\n\nvarying vec2 vUv;uniform float frameCount2;uniform float intensity;uniform float objectRadius;uniform float rayCount;uniform float power;uniform float bias;uniform float falloff;uniform float tolerance;uniform bool autoRadius;uniform vec2 screenSize;vec3 ComputeUniformL(vec3 N,vec2 E){vec3 L;L.xy=E;L.z=interleavedGradientNoise(gl_FragCoord.xy,frameCount2*5.);L=L*2.-1.;return L;}vec2 GetRandomE(float seed){vec2 rand_e;rand_e.x=random3(vec3(gl_FragCoord.xy,frameCount2+seed));rand_e.y=random3(vec3(gl_FragCoord.yx,rand_e.x+(frameCount2)*7.));return rand_e;}vec4 calculateGI(in float seed,in vec3 screenPos,in vec3 normal,in float radiusFactor){vec3 viewPos=screenToView(screenPos.xy,screenPos.z);normal=normalize(normal);vec2 E=GetRandomE(seed);vec3 L=ComputeUniformL(normal,E);L=normalize(L);L*=sign(dot(L,normal));float cameraDist=length(cameraPositionWorld);float rayLen=autoRadius?length(viewPos-screenToView(screenPos.xy+objectRadius/10.,screenPos.z)):mix((cameraNearFar.y)+viewPos.z,-viewPos.z-cameraNearFar.x,L.z*0.5+0.5)*objectRadius;rayLen*=radiusFactor;float r=interleavedGradientNoise(gl_FragCoord.xy,frameCount2*14.+seed)+0.05;rayLen=max(rayLen,0.001);vec3 state=vec3(1.,(r+0.5)/float(RTAO_STEP_COUNT),2.);viewPos+=normal*max(-0.01*viewPos.z,0.001);vec3 screenHitP=traceRay(viewPos,L*rayLen,tolerance*rayLen,state,RTAO_STEP_COUNT);vec3 viewHitP=screenToView(screenHitP.xy,screenHitP.z);vec3 LRes=viewHitP-viewPos;if(state.z>1.)LRes=vec3(9999999.);float dist=length(LRes)*falloff;float EPS=0.01;float zBias=(viewPos.z)*bias;float ao=(max(dot(normal,L)+zBias,0.))/(dist*dist+EPS);\n#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0\nvec3 hitColor=tLastFrameTexelToLinear(texture2D(tLastFrame,screenHitP.xy)).rgb;vec3 hitNormal=getViewNormal(screenHitP.xy);float giWeight=1.;giWeight=saturate2(giWeight/(dist+EPS),1.);giWeight*=saturate2((dot(normal,L)),1.);giWeight*=saturate2((dot(hitNormal,-L)),1.);return vec4(hitColor*giWeight,ao);\n#endif\nreturn vec4(0,0,0,ao);}float normpdf(in float x,in float sigma){return exp(-0.5*x*x/(sigma*sigma));}vec4 getLastThis(sampler2D tex,float depth,vec3 normal){vec2 direction=vec2(1,1);vec4 color=clamp(tLastThisTexelToLinear(texture2D(tex,vUv.xy)),0.,5.);return color;}void main(){float depth;vec3 normal;getDepthNormal(vUv,depth,normal);if(depth>0.99){discard;gl_FragColor=getLastThis(tLastThis,depth,normal);return;}float viewZ=depthToViewZ(depth);vec3 screenPos=vec3(vUv.x,vUv.y,viewZ);vec4 gi=vec4(0.);gi+=calculateGI(8.,screenPos,normal,1.);if(rayCount>1.5)gi=max(gi,calculateGI(2.,screenPos,normal,0.4));if(rayCount>2.5)gi=max(gi,calculateGI(3.,screenPos,normal,1.5));if(rayCount>3.5)gi=max(gi,calculateGI(1.,screenPos,normal,0.6));if(rayCount>4.5)gi=max(gi,calculateGI(3.,screenPos,normal,1.));gi.a=min(1.,gi.a);gi.a=max(0.,gi.a);gi.rgb=min(vec3(3.),gi.rgb);gi.rgb=max(vec3(0.),gi.rgb);if(frameCount2<3.){gl_FragColor=gi;return;}gl_FragColor=(texture2D(tLastThis,vUv));gl_FragColor=((gi+(gl_FragColor)*frameCount2)/(frameCount2+1.));}\n\n            `,uniforms:{tLastThis:{value:null},tDiffuse:{value:null},tNormalDepth:{value:null},tLastFrame:{value:null},opacity:{value:1},intensity:{value:2.14},rayCount:{value:.1},objectRadius:{value:1},autoRadius:{value:!a},power:{value:1.1},bias:{value:.015},falloff:{value:.7},tolerance:{value:1.5},frameCount:{value:0},frameCount2:{value:0},projection:{value:new m.yGw},screenSize:{value:new m.FM8},cameraPositionWorld:{value:new m.Pa4},cameraNearFar:{value:new m.FM8(.1,1e3)}},defines:{PERSPECTIVE_CAMERA:1,SSGI_ENABLED:a?1:0}},"tDiffuse","tLastFrame","tLastThis"),this.materialExtension={shaderExtender:(e,t,r)=>{if(!e.defines.SSRTAO_ENABLED)return;this.materialExtension.extraUniforms.tSSGIMap.value=this._target?.texture;const a=t.materialObject;let i=this.material.defines.SSGI_ENABLED;a.defines.SSGI_ENABLED!==i&&(a.defines.SSGI_ENABLED=i,a.needsUpdate=!0),i=this._target.texture,this.materialExtension.extraUniforms.tSSGIMap.value!==i&&(this.materialExtension.extraUniforms.tSSGIMap.value=i,a.needsUpdate=!0);const n="vec3 totalDiffuse =";e.fragmentShader=e.fragmentShader.replace(n,`\n\n            \n            #if defined(SSRTAO_ENABLED) && SSRTAO_ENABLED > 0\nvec4 ssgi=tSSGIMapTexelToLinear(texture2D(tSSGIMap,viewToScreen(vViewPosition.xyz).xy));float ambientOcclusion=1.-ssgi.a;ambientOcclusion=max(0.,ambientOcclusion);ambientOcclusion=pow(ambientOcclusion,ssaoPower);ambientOcclusion=min(1.,ambientOcclusion);reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0\nvec3 ssgiColor=ssgi.rgb*ssgiIntensity;reflectedLight.indirectDiffuse+=ssgiColor*(material.diffuseColor.rgb);\n#endif\n#if defined( USE_ENVMAP )\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));float specularOcclusion=saturate(pow(dotNV+ambientOcclusion,exp2(-16.*material.roughness-1.))-1.+ambientOcclusion);reflectedLight.indirectSpecular*=specularOcclusion;\n#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0\n#if !defined(SSR_ENABLED) || SSR_ENABLED < 1\nreflectedLight.indirectSpecular+=ssgiColor*material.specularColor;\n#endif\n#endif\n#endif\n#endif\n\n            \n            // reflectedLight.directDiffuse = vec3(0.);\n            // reflectedLight.indirectDiffuse = vec3(0.);\n            // reflectedLight.directSpecular = vec3(0.);\n            // reflectedLight.indirectSpecular = vec3(0.);\n            \n            \n${n}`),e.fragmentShader=e.fragmentShader.replace("#include <aomap_fragment>",""),e.defines.USE_UV=""},onObjectRender:(e,t,r)=>{const a=t.materialObject,i=!a.transparent&&a.transmission<.001,n=this.enabled&&i&&(this.renderWithCamera||this._renderer.frameCount>1)&&!1!==r.userData.screenSpaceRendering&&!a.userData?.ssrtaoDisabled&&!a.userData?.ssaoDisabled?1:0;a.defines.SSRTAO_ENABLED!==n&&(a.defines.SSRTAO_ENABLED=n,a.needsUpdate=!0)},parsFragmentSnippet:e=>f.glsl`
            uniform float ssaoPower;
            uniform float ssgiIntensity;
            uniform sampler2D tSSGIMap;
            ${(0,g.N6)("tSSGIMap",this._target?.texture,e.capabilities.isWebGL2)}

            ${h.Z}

        `,extraUniforms:{tSSGIMap:{value:null},ssaoPower:this.material.uniforms.power,ssgiIntensity:this.material.uniforms.intensity},computeCacheKey:e=>this.enabled?"1":"0"+this._target?.texture?.colorSpace+this._target?.texture?.uuid+this.material.defines.SSGI_ENABLED,isCompatible:e=>!e.materialObject.userData?.ssaoDisabled&&e.isMeshStandardMaterial2},this.intensity=2,this.power=1.1,this.autoRadius=!0,this.objectRadius=2,this.tolerance=1,this.bias=.15,this.falloff=.7,this.rayCount=2,this.stepCount=4,this.smoothEnabled=!0,this.renderWithCamera=!0,this.uiConfig={type:"folder",label:"SS Global illumination (Dev)",children:[...(0,v._t)(this),{type:"checkbox",label:"GI Enabled",hidden:()=>!this._giActivated,property:[this,"ssgiEnabled"]}]},this._renderer=e,this._target=t,this.needsSwap=!0,this._giActivated=a,this.ssgiEnabled=a,this.bilateralPass=new y.$(this._target,r,"rgba")}render(e,t,r,a,i){this.needsSwap=!1,!this.renderWithCamera&&this._renderer.frameCount<2||(this._renderer.blit(this._target.texture,t),this.uniforms.tLastThis.value=t.texture,super.render(e,this._target,r,a,i),this.smoothEnabled&&this.bilateralPass.render(e,t,r,a,i))}}b([(0,_.qC)()],x.prototype,"bilateralPass",void 0),b([(0,v.t8)("Intensity",[0,4]),(0,_.qC)(),(0,g.e5)()],x.prototype,"intensity",void 0),b([(0,v.t8)("Power",[0,3]),(0,_.qC)(),(0,g.e5)()],x.prototype,"power",void 0),b([(0,v.Q7)("Auto radius"),(0,_.qC)(),(0,g.e5)()],x.prototype,"autoRadius",void 0),b([(0,v.t8)("Object Radius",[.01,10]),(0,_.qC)(),(0,g.e5)()],x.prototype,"objectRadius",void 0),b([(0,v.t8)("Tolerance",[.1,5]),(0,_.qC)(),(0,g.e5)()],x.prototype,"tolerance",void 0),b([(0,v.t8)("Bias",[-.3,.3]),(0,_.qC)(),(0,g.e5)()],x.prototype,"bias",void 0),b([(0,v.t8)("Falloff",[1e-4,4]),(0,_.qC)(),(0,g.e5)()],x.prototype,"falloff",void 0),b([(0,v.t8)("Ray Count",[1,5],1),(0,_.qC)(),(0,g.e5)()],x.prototype,"rayCount",void 0),b([(0,v.t8)("Step count",[1,16],1),(0,_.qC)(),(0,g.lD)("RTAO_STEP_COUNT")],x.prototype,"stepCount",void 0),b([(0,v.Q7)("Smooth Enabled"),(0,_.qC)()],x.prototype,"smoothEnabled",void 0),b([(0,v.Q7)("Render with Camera")],x.prototype,"renderWithCamera",void 0);var C=r(4821),S=r(3995);class D extends i.q{get rtgiTarget(){return this._rtgiTarget}constructor(e=!0){super(),this.dependencies=[C.k,a.m,n.E],this._initEnabled=!1,this.setDirty=this.setDirty.bind(this),this._initEnabled=e}async onAdded(e){await super.onAdded(e),this.enabled=this._initEnabled,this.uiConfig.uiRefresh?.("postFrame",!0)}get enabled(){return this.passes.ssrtgi?.passObject?.enabled||!1}set enabled(e){this.passes.ssrtgi?.passObject&&(this.passes.ssrtgi.passObject.enabled=e)}createPasses(e){return this._rtgiTarget=e.renderer.createTarget({sizeMultiplier:1}),this._viewer?.getPluginByType("debug"),[(0,S.M)(e,{passId:"ssrtgi",after:["gbuffer"],before:["render"],required:["render","gbuffer","progressive"],passObject:new x(e.renderer,this._rtgiTarget,e.getPlugin(a.m)?.getUnpackSnippet()??"",!0),update:()=>{const t=this.enabled;if(t){const e=this._viewer?.getPluginByType("SSAO");e?.enabled&&(e.enabled=!1)}t&&this.passes.ssrtgi.passObject.bilateralPass.updateShaderProperties([e.getPlugin(a.m)])}},(()=>[e.getPlugin(a.m),e.getPlugin(n.E),e.scene.activeCamera,e.renderer]))]}async onRemove(e){return e.renderer.disposeTarget(this._rtgiTarget),super.onRemove(e)}setDirty(){this._viewer?.setDirty()}get uiConfig(){const e=this.passes.ssrtgi?.passObject?.uiConfig??{};return e.children?.map((e=>(0,f.getOrCall)(e)))?.flat(2).forEach((e=>e&&(e.onChange=this.setDirty))),e}}D.PluginType="SSGI"},3316:function(e,t,r){r.d(t,{E:function(){return d}});var a=r(3995),i=r(4821),n=r(743),s=r(5551),o=r(9008),l=r(2354),c=r(6420),u=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let d=class extends a.Q{constructor(){super(),this.enabled=!0,this.dependencies=[i.k],this.scenes=[],this.assets={},this.toJSON=void 0,this._isPlaying=!1,this._isPlayingLoop=!1,this._options={},this.minSceneTime=2e3,this.loadScenes=this.loadScenes.bind(this),this.play=this.play.bind(this),this.stop=this.stop.bind(this),this.downloadScenes=this.downloadScenes.bind(this),this.promptLoadScenes=this.promptLoadScenes.bind(this)}get loadedScenes(){return this.scenes.length}async promptLoadScenes(){const e=await(0,o.uploadFile)(!0,!1,"model/gltf");await this.loadScenes(e)}async loadScenes(e){const t=await Promise.all(e.map((async e=>await e.arrayBuffer())));for(let r=0;r<e.length;r++){const a=e[r];this.scenes.push({[a.name]:new Uint8Array(t[r])}),this.assets[a.name]={path:a.name,file:a}}this.uiConfig?.uiRefresh?.()}async play(){if(!this._viewer)return;if(this._isPlaying||this._isPlayingLoop)return;this._isPlaying=!0,this._isPlayingLoop=!0;const e=this._viewer.getPluginByType("AssetManagerBasicPopupPlugin");e?.enabled,e&&(e.enabled=!1);const t=this._viewer.getPluginByType("FrameFade"),r=this._viewer.getPluginByType("GLTFAnimation"),a=this._viewer.getPluginByType("CameraViews");for(;this._isPlaying;)for(const i of this.scenes){if(!this._isPlaying)break;const n=Object.keys(i);r?.stopAnimation(!1),await(a?.stopAllAnimations()),this._viewer.scene.removeSceneModels(),this._viewer.renderEnabled=!1;for(const e of n){let t=this.assets[e];t||(t={path:e,file:new File([i[e]],e)},this.assets[e]=t),await(this._viewer.getManager()?.addAssetSingle(t,this._options))}if(!this._isPlaying)break;this._viewer.renderEnabled=!0,e&&(e.enabled=!1),t&&(t.enabled=!0,await t.startTransition(1e3));const s=[(0,o.timeout)(this.minSceneTime)];r&&s.push(r.playAnimation()),a&&s.push(a.animateAllViews()),await Promise.all(s)}this._isPlayingLoop=!1}stop(){this._isPlaying=!1}async downloadScenes(){const e={};for(const t of this.scenes)for(const r of Object.keys(t)){const a=e[r]?r+"_":r;e[a]=t[a]}const t=(0,n.Xo)(e),r=new Blob([t],{type:"application/zip"});(0,o.downloadBlob)(r,"scenes.glbloop")}async onAdded(e){await super.onAdded(e);const t=this;e.getManager()?.importer?.Importers.push(new l.q(class extends c.s{load(e,r,a,i){super.load(e,(e=>{t.loadScenes([...e.values()]),r?.(null),(0,o.timeout)(100).then(t.play)}),a,i)}},["glbloop"],!0))}};d.PluginType="SceneLoopPlugin",u([(0,s.Kb)("Loaded scenes")],d.prototype,"loadedScenes",null),u([(0,s.M)("Load Scenes")],d.prototype,"promptLoadScenes",null),u([(0,s.Kb)("Playing")],d.prototype,"_isPlaying",void 0),u([(0,s.ri)("Min Scene Time")],d.prototype,"minSceneTime",void 0),u([(0,s.M)("Play")],d.prototype,"play",null),u([(0,s.M)("Stop")],d.prototype,"stop",null),u([(0,s.M)("Download Scenes")],d.prototype,"downloadScenes",null),d=u([(0,s.Sp)("Scene Loop")],d)},5220:function(e,t,r){r.d(t,{w:function(){return u}});var a=r(3995),i=r(2988),n=r(4821),s=r(4107),o=r(5551),l=r(3198),c=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let u=class extends a.Q{addThinFilmLayer(e){return d(e.materialObject)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new p(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[n.k],this._defines={},this._uniforms={thinBaseLayerFactors:{value:new i.Ltg},thinNoiseLayerFactors:{value:new i.Ltg},thinColorNoiseParams:{value:new i.Ltg},thinFilmFactor:{value:.8}},this.materialExtension={parsFragmentSnippet:(e,t)=>this.enabled&&t?.materialObject.userData._thinFilmLayer?.hasThinFilm?l.Z+"\n#ifndef VORONOISE_HELPER\n#define VORONOISE_HELPER \nfloat voronoise(in vec2 p,float u,float v){float k=1.+63.*pow(1.-v,6.);vec2 i=floor(p);vec2 f=fract(p);vec2 a=vec2(0.,0.);for(int y=-2;y<=2;y++)for(int x=-2;x<=2;x++){vec2 g=vec2(x,y);vec3 o=hash3(i+g)*vec3(u,u,1.);vec2 d=g-f+o.xy;float w=pow(1.-smoothstep(0.,1.414,length(d)),k);a+=vec2(o.z*w,w);}return a.x/a.y;}vec3 voronoise3(vec2 p,float u,float v){return vec3(voronoise(p,u,v),voronoise(p+vec2(0.435,0.23),u,v),voronoise(p-vec2(0.83,0.45),u,v));}vec3 voronoiseNormal(vec2 p,float u,float v){return vec3(voronoise(p,u,v),voronoise(p+vec2(0.435,0.23),u,v),1.);}\n#endif\n\n#ifndef HSV_HELPERS\n#define HSV_HELPERS \nvec3 hsv2rgb(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=c.g<c.b?vec4(c.bg,K.wz):vec4(c.gb,K.xy);vec4 q=c.r<p.x?vec4(p.xyw,c.r):vec4(c.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}\n#endif \n\nuniform vec4 thinBaseLayerFactors;\nuniform vec4 thinNoiseLayerFactors;\nuniform vec4 thinColorNoiseParams;\nuniform float thinFilmFactor;\n        ":"",shaderExtender:(e,t,r)=>{if(!this.enabled||!t.materialObject.userData._thinFilmLayer?.hasThinFilm)return;const a="#glMarker beforeAccumulation";e.fragmentShader=e.fragmentShader.replace(a,"vec3 incident=normalize(vViewPosition.xyz);float hWeight=1.-dot(normal,incident);vec3 noiseV=voronoise3(vUv.xy*thinColorNoiseParams.xy*60.,thinColorNoiseParams.z,thinColorNoiseParams.w);float hWeight2=1.-dot(normalize(noiseV),incident);vec3 film=hsv2rgb(vec3(fract(hWeight+thinBaseLayerFactors.x),thinBaseLayerFactors.y,thinBaseLayerFactors.z))*thinBaseLayerFactors.a;vec3 film2=hsv2rgb(vec3(fract(hWeight2+thinNoiseLayerFactors.x),thinNoiseLayerFactors.y,thinNoiseLayerFactors.z))*thinNoiseLayerFactors.a;film=(film+film2)/(thinBaseLayerFactors.a+thinNoiseLayerFactors.a);diffuseColor.rgb=mix(diffuseColor.rgb,film,thinFilmFactor);"+a),e.defines.USE_UV=""},onObjectRender:(e,t)=>{const r=t.materialObject.userData?._thinFilmLayer;if(!r?.hasThinFilm)return;this._uniforms.thinBaseLayerFactors.value.fromArray(r.baseLayerFactors),this._uniforms.thinNoiseLayerFactors.value.fromArray(r.noiseLayerFactors),this._uniforms.thinColorNoiseParams.value.fromArray(r.colorNoiseParams),this._uniforms.thinFilmFactor.value=r.filmFactor;const a=this.enabled?1:0;t.materialObject.defines.THIN_FILM_LAYER_ENABLED!==a&&(t.materialObject.defines.THIN_FILM_LAYER_ENABLED=a,t.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._thinFilmLayer?.hasThinFilm?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2||e.isDiamondMaterial,updaters:()=>[],getUiConfig:e=>{const t=this._viewer,r={type:"folder",label:"ThinFilmLayer",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._thinFilmLayer?.hasThinFilm||!1},set value(a){a!==e.materialObject.userData._thinFilmLayer?.hasThinFilm&&(a?d(e.materialObject)||t.alert("Cannot add thin film."):e.materialObject.userData._thinFilmLayer&&(e.materialObject.userData._thinFilmLayer.hasThinFilm=!1,e.materialObject.needsUpdate=!0),r.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[0,1],label:"Intensity",hidden:()=>!e.materialObject.userData._thinFilmLayer?.hasThinFilm,property:[e.materialObject.userData._thinFilmLayer,"filmFactor"],onChange:this.setDirty}),()=>({type:"vec4",label:"Base Layer",bounds:[0,1],hidden:()=>!e.materialObject.userData._thinFilmLayer?.hasThinFilm,property:[e.materialObject.userData._thinFilmLayer,"baseLayerFactors"],onChange:this.setDirty}),()=>({type:"vec4",label:"Noise Layer",bounds:[0,1],hidden:()=>!e.materialObject.userData._thinFilmLayer?.hasThinFilm,property:[e.materialObject.userData._thinFilmLayer,"noiseLayerFactors"],onChange:this.setDirty}),()=>({type:"vec4",label:"Noise Params",bounds:[0,1],hidden:()=>!e.materialObject.userData._thinFilmLayer?.hasThinFilm,property:[e.materialObject.userData._thinFilmLayer,"colorNoiseParams"],onChange:this.setDirty})]};return r}},this.setDirty=()=>{this._viewer?.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(n.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(h)}async onRemove(e){return e.getPlugin(n.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(n.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};function d(e){const t=e?.userData;if(!t)return!1;t._thinFilmLayer||(t._thinFilmLayer={});const r=t._thinFilmLayer;return r.hasThinFilm=!0,void 0===r.baseLayerFactors&&(r.baseLayerFactors=[.3,.6,1,.9]),void 0===r.noiseLayerFactors&&(r.noiseLayerFactors=[.7,.5,.9,.7]),void 0===r.colorNoiseParams&&(r.colorNoiseParams=[.5,.5,.5,.7]),void 0===r.filmFactor&&(r.filmFactor=.3),e.isMaterial&&(e.needsUpdate=!0),!0}u.PluginType="ThinFilmLayerPlugin",u.THIN_FILM_LAYER_GLTF_EXTENSION="WEBGI_materials_thin_film_layer",c([(0,o.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,s.qC)()],u.prototype,"enabled",void 0),u=c([(0,o.Sp)("ThinFilmLayer Materials")],u);class p{constructor(e){this.parser=e,this.name=u.THIN_FILM_LAYER_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];return t.userData||(t.userData={}),d(t),t.userData._thinFilmLayer=(0,s.Hx)(a,t.userData._thinFilmLayer,!1,{}),Promise.resolve()}}const h=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._thinFilmLayer)return;if(!t.userData._thinFilmLayer.hasThinFilm)return;r.extensions=r.extensions||{};const a=(0,s.HD)(t.userData._thinFilmLayer,!1);r.extensions[u.THIN_FILM_LAYER_GLTF_EXTENSION]=a,e.extensionsUsed[u.THIN_FILM_LAYER_GLTF_EXTENSION]=!0}})},2714:function(e,t,r){r.d(t,{z:function(){return d}});var a=r(3995),i=r(2988),n=r(9008),s=r(4821),o=r(4107),l=r(5551),c=r(8670),u=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let d=class extends a.Q{addTriplanarMapping(e){const t=e.materialObject?.userData;return!!t&&(t._triplanarMapping||(t._triplanarMapping={}),t._triplanarMapping.enable=!0,void 0===t._triplanarMapping.scaleFactor&&(t._triplanarMapping.scaleFactor=1),void 0===t._triplanarMapping.blendFactor&&(t._triplanarMapping.blendFactor=1),void 0===t._triplanarMapping.offsetFactor&&(t._triplanarMapping.offsetFactor=0),e.materialObject.needsUpdate=!0,!0)}_loaderCreate({loader:e}){e.isGLTFLoader2&&e.register((e=>new p(e)))}constructor(){super(),this.enabled=!0,this.dependencies=[s.k],this._uniforms={triplanarScale:{value:1},triplanarBlend:{value:1},triplanarOffset:{value:0}},this.materialExtension={shaderExtender:(e,t,r)=>{if(!this.enabled||!t.materialObject.userData?._triplanarMapping?.enable)return;const a=n.glsl`
                #ifndef USE_TRANSMISSION
                    varying vec3 vWorldPosition;
                #endif
                varying vec3 vWorldNormal;
            `;e.vertexShader=(0,c.p)(e.vertexShader,"#include <common>",a,{prepend:!0});const s=n.glsl`
                #ifndef USE_TRANSMISSION
                    vWorldPosition = worldPosition.xyz;
                #endif
                vWorldNormal = normalize((modelMatrix * vec4(objectNormal, 0.)).xyz);
            `;e.vertexShader=(0,c.p)(e.vertexShader,"#include <worldpos_vertex>",s,{append:!0});const o=n.glsl`
                ${"struct TriplanarUV{vec2 x;vec2 y;vec2 z;};uniform float triplanarScale;uniform float triplanarBlend;uniform float triplanarOffset;vec3 getTriplanarWeights(in vec3 position,in vec3 normal){vec3 triW=abs(normal);triW=clamp(triW-vec3(triplanarOffset),vec3(0.),vec3(1.));triW=pow(triW,vec3(triplanarBlend));return triW/(triW.x+triW.y+triW.z);}TriplanarUV getTriplanarUV(in vec3 position,in vec3 normal){TriplanarUV triUV;triUV.x=position.zy*triplanarScale;triUV.y=position.xz*triplanarScale;triUV.z=position.xy*triplanarScale;if(normal.x<0.){triUV.x.x=-triUV.x.x;}if(normal.y<0.){triUV.y.x=-triUV.y.x;}if(normal.z>=0.){triUV.z.x=-triUV.z.x;}return triUV;}vec4 textureTriplanar(in sampler2D tex,in vec3 position,in vec3 normal){TriplanarUV triUV=getTriplanarUV(position,normal);vec4 texX=texture2D(tex,triUV.x);vec4 texY=texture2D(tex,triUV.y);vec4 texZ=texture2D(tex,triUV.z);vec3 triW=getTriplanarWeights(position,normal);return texX*triW.x+texY*triW.y+texZ*triW.z;}"}
                #ifndef USE_TRANSMISSION
                    varying vec3 vWorldPosition;
                #endif
                varying vec3 vWorldNormal;
            `;e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <common>",o,{prepend:!0});const l=n.glsl`

            #ifdef USE_BUMPMAP

            uniform sampler2D bumpMap;
            uniform float bumpScale;

            // Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen
            // https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf

            // Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)

            vec2 dHdxy_fwd() {

                vec3 dSTdx = dFdx( vWorldPosition );
                vec3 dSTdy = dFdy( vWorldPosition );

                vec3 normal_ = normalize(vWorldNormal);
                float Hll = bumpScale * textureTriplanar( bumpMap, vWorldPosition, normal_ ).x;
                float dBx = bumpScale * textureTriplanar( bumpMap, vWorldPosition + dSTdx, normal_ ).x - Hll;
                float dBy = bumpScale * textureTriplanar( bumpMap, vWorldPosition + dSTdy, normal_ ).x - Hll;

                return vec2( dBx, dBy );

            }

            vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {

                vec3 vSigmaX = dFdx( surf_pos.xyz );
                vec3 vSigmaY = dFdy( surf_pos.xyz );
                vec3 vN = surf_norm; // normalized

                vec3 R1 = cross( vSigmaY, vN );
                vec3 R2 = cross( vN, vSigmaX );

                float fDet = dot( vSigmaX, R1 ) * faceDirection;

                vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
                return normalize( abs( fDet ) * surf_norm - vGrad );

            }

        #endif
            `;e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <bumpmap_pars_fragment>",l);let u=(0,c.p)(i.WdD.map_fragment,"texture2D( map, vMapUv );","textureTriplanar( map, vWorldPosition, normalize(vWorldNormal) );");e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <map_fragment>",u),u=(0,c.p)(i.WdD.roughnessmap_fragment,"texture2D( roughnessMap, vRoughnessMapUv );","textureTriplanar( roughnessMap, vWorldPosition, normalize(vWorldNormal));"),e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <roughnessmap_fragment>",u),u=(0,c.p)(i.WdD.metalnessmap_fragment,"texture2D( metalnessMap, vMetalnessMapUv );","textureTriplanar( metalnessMap, vWorldPosition, normalize(vWorldNormal));"),e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <metalnessmap_fragment>",u),u=(0,c.p)(i.WdD.normal_fragment_maps,"vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;","vec3 mapN = textureTriplanar( normalMap, vWorldPosition, normalize(vWorldNormal) ).xyz * 2.0 - 1.0;"),e.fragmentShader=(0,c.p)(e.fragmentShader,"#include <normal_fragment_maps>",u),e.defines.USE_UV=""},onObjectRender:(e,t)=>{const r=t.materialObject.userData;if(!r?._triplanarMapping?.enable)return;const a=e;a.isMesh&&a.geometry&&(this._uniforms.triplanarScale.value=r._triplanarMapping?.scaleFactor,this._uniforms.triplanarBlend.value=r._triplanarMapping?.blendFactor,this._uniforms.triplanarOffset.value=r._triplanarMapping?.offsetFactor)},extraUniforms:{...this._uniforms},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData?._triplanarMapping?.enable?"1":"0"),isCompatible:e=>e.isMeshStandardMaterial2,updaters:()=>[this._viewer?.renderer],getUiConfig:e=>{const t=this._viewer,r=this.addTriplanarMapping,a={type:"folder",label:"Triplanar",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData._triplanarMapping?.enable||!1},set value(i){i!==e.materialObject.userData._triplanarMapping?.enable&&(i?r(e)||t.alert("Cannot add Triplanar mapping."):e.materialObject.userData._triplanarMapping&&(e.materialObject.userData._triplanarMapping.enable=!1,e.materialObject.needsUpdate=!0),a.uiRefresh?.("postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[.1,10],label:"Scale",hidden:()=>!e.materialObject.userData._triplanarMapping?.enable,property:[e.materialObject.userData._triplanarMapping,"scaleFactor"],onChange:this.setDirty}),()=>({type:"slider",bounds:[1,10],label:"Blend",hidden:()=>!e.materialObject.userData._triplanarMapping?.enable,property:[e.materialObject.userData._triplanarMapping,"blendFactor"],onChange:this.setDirty}),()=>({type:"slider",bounds:[0,.5],stepSize:.01,label:"Offset",hidden:()=>!e.materialObject.userData._triplanarMapping?.enable,property:[e.materialObject.userData._triplanarMapping,"offsetFactor"],onChange:this.setDirty})]};return a}},this.setDirty=()=>{this.materialExtension.setDirty?.(),this._viewer?.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(e){await super.onAdded(e);const t=e.getPlugin(s.k);t?.materials?.registerMaterialExtension(this.materialExtension),t?.importer?.addEventListener("loaderCreate",this._loaderCreate),t?.exporter?.getExporter("gltf","glb")?.extensions?.push(h)}async onRemove(e){return e.getPlugin(s.k)?.materials?.unregisterMaterialExtension(this.materialExtension),e.getPlugin(s.k)?.importer?.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(e)}};d.PluginType="TriplanarUVMappingPlugin",d.TRIPLANAR_GLTF_EXTENSION="WEBGI_materials_triplanar",u([(0,l.Q7)("Enabled",(e=>({onChange:e.setDirty}))),(0,o.qC)()],d.prototype,"enabled",void 0),d=u([(0,l.Sp)("Triplanar Mapping")],d);class p{constructor(e){this.parser=e,this.name=d.TRIPLANAR_GLTF_EXTENSION}async extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=r.extensions[this.name];t.userData||(t.userData={});const i=t.userData;return i._triplanarMapping||(i._triplanarMapping={}),i._triplanarMapping.enable=!0,void 0===i._triplanarMapping.scaleFactor&&(i._triplanarMapping.scaleFactor=1),void 0===i._triplanarMapping.blendFactor&&(i._triplanarMapping.blendFactor=1),void 0===i._triplanarMapping.offsetFactor&&(i._triplanarMapping.offsetFactor=0),t.userData._triplanarMapping=(0,o.Hx)(a,t.userData._triplanarMapping,!1,{}),Promise.resolve()}}const h=e=>({writeMaterial:(t,r)=>{if(!t.isMeshStandardMaterial||!t.userData._triplanarMapping?.enable)return;r.extensions=r.extensions||{};const a=(0,o.HD)(t.userData._triplanarMapping,!1);r.extensions[d.TRIPLANAR_GLTF_EXTENSION]=a,e.extensionsUsed[d.TRIPLANAR_GLTF_EXTENSION]=!0}})},5133:function(e,t,r){r.d(t,{l:function(){return d}});var a=r(2988),i=r(4915),n=r(5551),s=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let o=class extends i.C{constructor(e,t,r){super(e,t,r??new l,new a.Ilk(0,0,0),1),this.enabled=!0,this._firstCall=!0}render(e,t,r,a,i){if(!this.enabled||!this.camera)return;const n=this.overrideMaterial;n.uniforms.currentProjectionViewMatrix.value.copy(this.camera.projectionMatrix).multiply(this.camera.matrixWorldInverse),this._firstCall&&(n.uniforms.lastProjectionViewMatrix.value.copy(n.uniforms.currentProjectionViewMatrix.value),this._firstCall=!1),super.render(e,t,r,a,i),n.uniforms.lastProjectionViewMatrix.value.copy(n.uniforms.currentProjectionViewMatrix.value)}};s([(0,n.Q7)("Enabled")],o.prototype,"enabled",void 0),o=s([(0,n.Sp)("Velocity Buffer (TAA)")],o);class l extends a.jyz{constructor(){super({vertexShader:"#ifdef USE_ALPHAMAP\n#define USE_UV \n#endif\n#include <uv_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec3 vWorldPosition;varying vec3 vWorldPositionPrevious;uniform mat4 modelMatrixPrevious;void main(){\n#include <uv_vertex>\n#include <skinbase_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\nvec4 mvPosition=vec4(transformed,1.);\n#ifdef USE_INSTANCING\nmvPosition=instanceMatrix*mvPosition;\n#endif\nvWorldPosition=(modelMatrix*mvPosition).xyz;vWorldPositionPrevious=(modelMatrixPrevious*mvPosition).xyz;mvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n}",fragmentShader:"varying vec3 vWorldPosition;varying vec3 vWorldPositionPrevious;uniform mat4 currentProjectionViewMatrix;uniform mat4 lastProjectionViewMatrix;vec2 computeScreenSpaceVelocity2(){vec4 currentPositionClip=currentProjectionViewMatrix*vec4(vWorldPosition,1.);vec4 prevPositionClip=lastProjectionViewMatrix*vec4(vWorldPositionPrevious,1.);vec2 currentPositionNDC=currentPositionClip.xy/currentPositionClip.w;vec2 prevPositionNDC=prevPositionClip.xy/prevPositionClip.w;if(prevPositionNDC.x>=1.||prevPositionNDC.x<=-1.||prevPositionNDC.x>=1.||prevPositionNDC.y<=-1.){return vec2(0.);}return 0.5*(currentPositionNDC-prevPositionNDC);}void main(){vec2 velocity=clamp(computeScreenSpaceVelocity2(),-1.,1.);velocity=sign(velocity)*pow(abs(velocity),vec2(1./4.));velocity=velocity*0.5+0.5;gl_FragColor=vec4(velocity.x,velocity.y,1.,1.);}",uniforms:{cameraNearFar:{value:new a.FM8(.1,1e3)},alphaMap:{value:null},alphaTest:{value:null},alphaMapTransform:{value:new a.Vkp},currentProjectionViewMatrix:{value:new a.yGw},lastProjectionViewMatrix:{value:new a.yGw}}}),this.extraUniformsToUpload={modelMatrixPrevious:{value:(new a.yGw).identity()}},this._previousWorldMatrices={}}onBeforeRender(e,t,r,i,n){const s=this._previousWorldMatrices[n.uuid];this.extraUniformsToUpload.modelMatrixPrevious.value.copy(s??n.matrixWorld),s?s.copy(n.matrixWorld):this._previousWorldMatrices[n.uuid]=n.matrixWorld.clone();let o=n.material;Array.isArray(o)&&(o=o[0]),this.uniforms.alphaMap.value=o?.alphaMap??null,this.uniforms.alphaTest.value=!o||!o.alphaTest||o.alphaTest<1e-7?.001:o.alphaTest;let l=this.uniforms.alphaMap.value?1:void 0;l!==this.defines.USE_ALPHAMAP&&(void 0===l?delete this.defines.USE_ALPHAMAP:this.defines.USE_ALPHAMAP=l,this.needsUpdate=!0),l=o.userData.ALPHA_I_RGBA_PACKING?1:void 0,l!==this.defines.ALPHA_I_RGBA_PACKING&&(void 0===l?delete this.defines.ALPHA_I_RGBA_PACKING:this.defines.ALPHA_I_RGBA_PACKING=l,this.needsUpdate=!0),this.side=o.side??a.ehD}}var c=r(4895),u=r(6533);class d extends c.G{passCtor(e){const t=e.renderer.createTarget({depthBuffer:!0,type:a.ywz});t.texture.name="velocityBuffer",this._velocityBuffers.push(t),e.getPluginByType("debug");const r=new Set,i=new Set;return new class extends o{render(a,n,s,o,l){if(e.renderer.frameCount>0)return;const c=a.getRenderTarget(),d=a.getActiveCubeFace(),p=a.getActiveMipmapLevel();this.scene?.traverse((({material:e})=>{e&&((e.transparent&&e.userData.renderToDepth||!e.transparent&&0===e.transmission&&!1===e.userData.renderToDepth)&&(r.add(e),e.transparent=!e.transparent),Math.abs(e.transmission||0)>0&&e.userData.renderToDepth&&(i.add([e,e.transmission]),e.transmission=0))})),(0,u.of)(a,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},(()=>super.render(a,n,t,o,l))),r.forEach((e=>e.transparent=!e.transparent)),r.clear(),i.forEach((([e,t])=>e.transmission=t)),i.clear(),a.setRenderTarget(c,d,p)}}}_update(e){if(!super._update(e))return!1;if(e.renderer.frameCount>0)return!1;const t=this.pass.passObject;return t.scene=e.scene.modelObject,e.scene.activeCamera.updateShaderProperties(t.overrideMaterial),t.camera=e.scene.activeCamera.cameraObject,!0}constructor(e=!0){super(),this.passId="velocityBuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this._velocityBuffers=[],this.enabled=e}getVelocityBuffer(){return this._velocityBuffers.length>0?this._velocityBuffers[0]:void 0}async onDispose(e){}async onRemove(e){return this._velocityBuffers.forEach((t=>e.renderer.disposeTarget(t?.dispose?.()))),super.onRemove(e)}updateShaderProperties(e){return e.uniforms.tVelocity?e.uniforms.tVelocity.value=this.enabled?this.getVelocityBuffer()?.texture??null:null:console.warn("BaseRenderer: no uniform: tVelocity"),this}get uiConfig(){return this.pass?.passObject.uiConfig}}d.PluginType="VelocityBuffer"},5571:function(e,t,r){r.d(t,{_:function(){return p}});var a,i=r(5551),n=r(4107),s=r(9008),o=r(8670),l=r(3278),c=r(5008),u=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let d=a=class{constructor(e){this.enabled=!1,this.aberrationIntensity=.01,this.extraUniforms={aberrationIntensity:{value:1}},this.parsFragmentSnippet=(e,t)=>this.enabled?s.glsl`
            uniform float aberrationIntensity;
            ${"vec4 chromaticAberration(){vec2 distFromCenter=vUv-0.5;vec2 aberrated=aberrationIntensity*pow(distFromCenter,vec2(2.));vec4 color=tDiffuseTexelToLinear(texture2D(tDiffuse,vUv));vec4 outColor=vec4(tDiffuseTexelToLinear(texture2D(tDiffuse,vUv+aberrated)).r,color.g,tDiffuseTexelToLinear(texture2D(tDiffuse,vUv-aberrated)).b,color.a);return outColor;}"}
        `:"",this._combinedPostPlugin=e.getPlugin(c.x),this._setDirty=this._setDirty.bind(this)}shaderExtender(e,t,r){this.enabled&&(e.fragmentShader=(0,o.p)(e.fragmentShader,"#glMarker"," \n            gl_FragColor = chromaticAberration();\n            #glMarker\n        "))}onObjectRender(e,t,r){this.enabled&&(t.materialObject.uniforms.aberrationIntensity.value=this.aberrationIntensity)}getUiConfig(){return this.uiConfig}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this.__setDirty?.(),this._setDirty()}};d.PluginType="ChromaticAberration",u([(0,s.onChange)(a.prototype._setDirty),(0,i.Q7)("Enable"),(0,n.qC)()],d.prototype,"enabled",void 0),u([(0,s.onChange)(a.prototype._setDirty),(0,i.t8)("Intensity",[0,.1],.001,{limitedUi:!0}),(0,n.qC)()],d.prototype,"aberrationIntensity",void 0),d=a=u([(0,i.Sp)("ChromaticAberration")],d);class p extends l.a{constructor(){super()}generateExtension(e){return new d(e)}get intensity(){return this._extension?.aberrationIntensity??1}set intensity(e){this._extension&&(this._extension.aberrationIntensity=e,this._extension.setDirty())}}p.PluginType="ChromaticAberration"},7821:function(e,t,r){r.d(t,{k:function(){return p}});var a,i=r(5551),n=r(4107),s=r(9008),o=r(8670),l=r(3278),c=r(5008),u=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let d=a=class{constructor(e){this.enabled=!1,this.grainMultiply=!1,this.grainIntensity=10,this.extraUniforms={grainIntensity:{value:1},grainMultiply:{value:1}},this.parsFragmentSnippet=(e,t)=>this.enabled?s.glsl`
            uniform float grainIntensity;
            uniform bool grainMultiply;
            ${"vec4 grain(in vec4 color){float x=(vUv.x+4.)*(vUv.y+4.)*(10.);vec4 grain=vec4(mod((mod(x,13.)+1.)*(mod(x,123.)+1.),0.01)-0.005)*grainIntensity;vec4 outColor=color;if(grainMultiply){grain=1.-grain;outColor.rgb=color.rgb*vec3(grain);}else{outColor.rgb=color.rgb+vec3(grain);}return outColor;}"}
        `:"",this._combinedPostPlugin=e.getPlugin(c.x),this._setDirty=this._setDirty.bind(this)}shaderExtender(e,t,r){this.enabled&&(e.fragmentShader=(0,o.p)(e.fragmentShader,"#glMarker"," \n            gl_FragColor = grain(gl_FragColor);\n            #glMarker\n        "))}onObjectRender(e,t,r){this.enabled&&(t.materialObject.uniforms.grainIntensity.value=this.grainIntensity,t.materialObject.uniforms.grainMultiply.value=this.grainMultiply)}getUiConfig(){return this.uiConfig}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this.__setDirty?.(),this._setDirty()}};u([(0,s.onChange)(a.prototype._setDirty),(0,i.Q7)("Enable"),(0,n.qC)()],d.prototype,"enabled",void 0),u([(0,s.onChange)(a.prototype._setDirty),(0,i.Q7)("Multiply"),(0,n.qC)()],d.prototype,"grainMultiply",void 0),u([(0,s.onChange)(a.prototype._setDirty),(0,i.t8)("Intensity",[0,20],.01,{limitedUi:!0}),(0,n.qC)()],d.prototype,"grainIntensity",void 0),d=a=u([(0,i.Sp)("FilmicGrain")],d);class p extends l.a{constructor(){super()}generateExtension(e){return new d(e)}get intensity(){return this._extension?.grainIntensity??1}set intensity(e){this._extension&&(this._extension.grainIntensity=e,this._extension.setDirty())}get multiply(){return this._extension?.grainMultiply??!1}set multiply(e){this._extension&&(this._extension.grainMultiply=e,this._extension.setDirty())}}p.PluginType="FilmicGrain"},1755:function(e,t,r){r.d(t,{v:function(){return _}});var a,i=r(2988),n=r(5551),s=r(4107),o=r(9008),l=r(8670),c=r(3278),u=r(5008),d=r(9354),p=r(6757),h=r(4821),m=r(8570),f=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let g=a=class{constructor(e){this.enabled=!1,this.lutBackground=!0,this.intensity=1,this.lutMap=void 0,this.lutMap1=void 0,this.lutMap2=void 0,this.extraUniforms={intensity:{value:1},lutSize:{value:1},lutSize1:{value:1},lutSize2:{value:1},lut3d:{value:null},lut3d1:{value:null},lut3d2:{value:null},lut2d:{value:null},lut2d1:{value:null},lut2d2:{value:null}},this.extraDefines={USE_LUT:0,USE_LUT1:0,USE_LUT2:0,USE_3DTEXTURE:0,LUT_BACKGROUND:0},this.parsFragmentSnippet=(e,t)=>this.enabled?"#if (USE_LUT == 1 || USE_LUT1 == 1 || USE_LUT2 == 1)\nuniform float lutSize;uniform float lutSize1;uniform float lutSize2;uniform float intensity;\n#if USE_3DTEXTURE == 1\nprecision highp sampler3D;\n#if USE_LUT == 1\nuniform sampler3D lut3d;\n#endif\n#if USE_LUT1 == 1\nuniform sampler3D lut3d1;\n#endif\n#if USE_LUT2 == 1\nuniform sampler3D lut3d2;\n#endif\n#else\n#if USE_LUT == 1\nuniform sampler2D lut2d;\n#endif\n#if USE_LUT1 == 1\nuniform sampler2D lut2d1;\n#endif\n#if USE_LUT2 == 1\nuniform sampler2D lut2d2;\n#endif\nvec3 lutLookup(sampler2D tex,float size,vec3 rgb){float sliceHeight=1./size;float yPixelHeight=1./(size*size);float slice=rgb.b*size;float interp=fract(slice);float slice0=slice-interp;float centeredInterp=interp-0.5;float slice1=slice0+sign(centeredInterp);float greenOffset=clamp(rgb.g*sliceHeight,yPixelHeight*0.5,sliceHeight-yPixelHeight*0.5);vec2 uv0=vec2(rgb.r,slice0*sliceHeight+greenOffset);vec2 uv1=vec2(rgb.r,slice1*sliceHeight+greenOffset);vec3 sample0=texture2D(tex,uv0).rgb;vec3 sample1=texture2D(tex,uv1).rgb;return mix(sample0,sample1,abs(centeredInterp));}\n#endif\nint getLUTBit(in int number){\n#ifdef WebGL2Context\nreturn number%2;\n#else\nreturn int(mod(float(number),2.));\n#endif\n}int getLUTIndex(in int number){\n#ifdef WebGL2Context\nreturn number%8;\n#else\nreturn int(mod(float(number),8.));\n#endif\n}vec3 getUVW(in float lutSize,in vec4 color){float pixelWidth=1./lutSize;float halfPixelWidth=0.5/lutSize;vec3 uvw=vec3(halfPixelWidth)+color.rgb*(1.-pixelWidth);return uvw;}vec4 colorLookUp(in vec4 color){vec4 outColor;float lutFac=float(getLUTBit(getGBufferFlags(vUv).a));float lutIndex=float(getLUTIndex(getGBufferFlags(vUv).g));\n#if USE_3DTEXTURE == 1\nif(lutIndex==0.){\n#if USE_LUT == 1\noutColor=vec4(texture(lut3d,getUVW(lutSize,color)).rgb,color.a);\n#endif\n}else if(lutIndex==1.){\n#if USE_LUT1 == 1\noutColor=vec4(texture(lut3d1,getUVW(lutSize1,color)).rgb,color.a);\n#endif\n}else if(lutIndex==2.){\n#if USE_LUT2 == 1\noutColor=vec4(texture(lut3d2,getUVW(lutSize2,color)).rgb,color.a);\n#endif\n}else{\n#if USE_LUT == 1\noutColor=vec4(texture(lut3d,getUVW(lutSize,color)).rgb,color.a);\n#endif\n}\n#else\nif(lutIndex==0.){outColor=vec4(lutLookup(lut2d,lutSize,getUVW(lutSize,color)),color.a);}else if(lutIndex==1.){\n#if USE_LUT1 == 1\noutColor=vec4(lutLookup(lut2d1,lutSize,getUVW(lutSize1,color)),color.a);\n#endif\n}else if(lutIndex==2.){\n#if USE_LUT2 == 1\noutColor=vec4(lutLookup(lut2d2,lutSize,getUVW(lutSize2,color)),color.a);\n#endif\n}else{outColor=vec4(lutLookup(lut2d,lutSize,getUVW(lutSize,color)),color.a);}\n#endif\noutColor=mix(color,outColor,lutFac);return vec4(mix(color,outColor,intensity));}\n#endif\n":"",this._viewer=e,this._combinedPostPlugin=e.getPlugin(u.x),this._setDirty=this._setDirty.bind(this),this.setDirty=this.setDirty.bind(this)}_updateParams(){if(!this.enabled)return;const e=this._viewer.renderer.rendererObject.capabilities.isWebGL2?1:0;let t=e?this.extraUniforms.lut3d:this.extraUniforms.lut2d;this._updateLUTMap(this.lutMap,t,this.extraUniforms.lutSize,e),this.extraDefines.USE_LUT=this.lutMap?1:0,t=e?this.extraUniforms.lut3d1:this.extraUniforms.lut2d1,this._updateLUTMap(this.lutMap1,t,this.extraUniforms.lutSize1,e),this.extraDefines.USE_LUT1=this.lutMap1?1:0,t=e?this.extraUniforms.lut3d2:this.extraUniforms.lut2d2,this._updateLUTMap(this.lutMap2,t,this.extraUniforms.lutSize2,e),this.extraDefines.USE_LUT2=this.lutMap2?1:0,this.extraUniforms.intensity.value=this.intensity,this.extraDefines.LUT_BACKGROUND=this.lutBackground?1:0,this.extraDefines.USE_3DTEXTURE=e,this._setDirty()}_updateLUTMap(e,t,r,a){if(e){let i=1;1==a?(t.value=e.texture3D,i=e.texture3D.image.width):e.texture&&(t.value=e.texture,i=e.texture.image.width),t.value.needsUpdate=!0,r.value=i}}shaderExtender(e,t,r){this.enabled&&(e.fragmentShader=(0,l.p)(e.fragmentShader,"#glMarker"," \n            #if USE_LUT == 1\n                bool isBackground = getDepth(vUv)>0.9999;\n                #if LUT_BACKGROUND == 1\n                    gl_FragColor = colorLookUp(gl_FragColor);\n                #else\n                    gl_FragColor = isBackground ? gl_FragColor : colorLookUp(gl_FragColor);\n                #endif\n            #endif\n            #glMarker\n        "))}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}_setDirty(){this.__setDirty?.(),this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this._setDirty()}};function v(e){const t=e?.userData;if(!t)return!1;t[_.PluginType]||(t[_.PluginType]={});const r=t[_.PluginType];return r.enable=!0,void 0===r.index&&(r.index=0),e.isMaterial&&(e.needsUpdate=!0),!0}f([(0,s.qC)(),(0,o.onChange)(a.prototype._updateParams),(0,n.Q7)("Enable")],g.prototype,"enabled",void 0),f([(0,s.qC)(),(0,o.onChange)(a.prototype._updateParams),(0,n.Q7)("LUT Background")],g.prototype,"lutBackground",void 0),f([(0,s.qC)(),(0,o.onChange)(a.prototype._updateParams),(0,n.t8)("Intensity")],g.prototype,"intensity",void 0),f([(0,o.onChange)(a.prototype._updateParams),(0,n.w8)("LUT"),(0,s.qC)()],g.prototype,"lutMap",void 0),f([(0,o.onChange)(a.prototype._updateParams),(0,n.w8)("LUT1"),(0,s.qC)()],g.prototype,"lutMap1",void 0),f([(0,o.onChange)(a.prototype._updateParams),(0,n.w8)("LUT2"),(0,s.qC)()],g.prototype,"lutMap2",void 0),g=a=f([(0,n.Sp)("LUT")],g);class _ extends c.a{_getUiConfig(e){const t={type:"folder",label:"LUT",children:[{type:"checkbox",label:"Enabled",get value(){return e.materialObject.userData[_.PluginType]?.enable??!0},set value(r){const a=e.materialObject.userData[_.PluginType];r!==a?.enable&&(a||v(e.materialObject),e.materialObject.userData[_.PluginType].enable=r,t.uiRefresh?.("postFrame",!0))},onChange:this._extension?.setDirty},{type:"dropdown",children:[["LUT 0",0],["LUT 1",1],["LUT 2",2]].map((e=>({label:e[0],value:e[1]}))),label:"index",hidden:()=>{const t=e.materialObject.userData[_.PluginType];return!!t&&!t.enable},get value(){return e.materialObject.userData[_.PluginType]?.index??0},set value(r){e.materialObject.userData[_.PluginType]||v(e.materialObject),e.materialObject.userData[_.PluginType].index=r,t.uiRefresh?.("postFrame",!0)},onChange:this._extension?.setDirty}]};return t}constructor(){super(),this.materialExtension={uuid:(0,m.Z)(),getUiConfig:e=>{if(e.__uiConfigs||(e.__uiConfigs={}),e.__uiConfigs[this.materialExtension.uuid])return e.__uiConfigs[this.materialExtension.uuid];const t=this._getUiConfig(e);return e.__uiConfigs[this.materialExtension.uuid]=t,t},computeCacheKey:e=>(this.enabled?"1":"0")+(e.materialObject.userData[_.PluginType]?.enable?"1":"0"),isCompatible:e=>!0},this.updateGBuffer=this.updateGBuffer.bind(this)}async onAdded(e){await super.onAdded(e),e.getPlugin(p.m)?.registerGBufferUpdater(this.updateGBuffer);const t=e.getPlugin(h.k);t?.materials?.registerMaterialExtension(this.materialExtension)}generateExtension(e){return new g(e)}updateGBuffer(e,t){if(e instanceof i.Kj0&&e.material?.userData){const r=e.material?.userData[_.PluginType];if(r){const e=!1===r.enable?0:1;t.w=(0,d.s)(t.w,0,e);for(let e=0;e<3;e++)t.y=(0,d.o)(t.y,e);let a=r.enable?r.index:0;a=Math.min(a,7),t.y=t.y|a}else t.w=(0,d.s)(t.w,0,1)}}}_.PluginType="LUTPlugin1"},9483:function(e,t,r){r.d(t,{Q:function(){return h}});var a,i=r(2988),n=r(5551),s=r(4107),o=r(9008),l=r(8670),c=r(3278),u=r(5008),d=function(e,t,r,a){var i,n=arguments.length,s=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s};let p=a=class{constructor(e){this.enabled=!1,this.power=.5,this.bgcolor=new i.Ilk(0),this.extraUniforms={power:{value:1},bgcolor:{value:new i.Ilk}},this.parsFragmentSnippet=(e,t)=>this.enabled?o.glsl`
            uniform float power;
            uniform vec3 bgcolor;
            ${"vec4 Vignette(in vec4 color){vec2 uv=vUv*(1.-vUv);float vig=uv.x*uv.y*16.;vig=pow(vig,power);return vec4(mix(color.rgb,vec3(bgcolor),1.-vig),color.a);}"}
        `:"",this._combinedPostPlugin=e.getPlugin(u.x),this._setDirty=this._setDirty.bind(this)}shaderExtender(e,t,r){this.enabled&&(e.fragmentShader=(0,l.p)(e.fragmentShader,"#glMarker"," \n            gl_FragColor = Vignette(gl_FragColor);\n            #glMarker\n        "))}onObjectRender(e,t,r){this.enabled&&(t.materialObject.uniforms.power.value=this.power,t.materialObject.uniforms.bgcolor.value.copy(this.bgcolor))}getUiConfig(){return this.uiConfig}computeCacheKey(e){return this.enabled?"1":"0"}isCompatible(e){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this.__setDirty?.(),this._setDirty()}};p.PluginType="Vignette",d([(0,o.onChange)(a.prototype._setDirty),(0,n.Q7)("Enable"),(0,s.qC)()],p.prototype,"enabled",void 0),d([(0,o.onChange)(a.prototype._setDirty),(0,n.t8)("Power",[.1,4],.01,{limitedUi:!0}),(0,s.qC)()],p.prototype,"power",void 0),d([(0,o.onChange)(a.prototype._setDirty),(0,n.s4)("Color"),(0,s.qC)()],p.prototype,"bgcolor",void 0),p=a=d([(0,n.Sp)("Vignette")],p);class h extends c.a{constructor(){super()}generateExtension(e){return new p(e)}get power(){return this._extension?.power??1}set power(e){this._extension&&(this._extension.power=e,this._extension.setDirty())}get color(){return this._extension?.bgcolor??new i.Ilk}set color(e){this._extension&&(this._extension.bgcolor.copy(e),this._extension.setDirty())}}h.PluginType="Vignette"}}]);
//# sourceMappingURL=412.7a00a396.js.map