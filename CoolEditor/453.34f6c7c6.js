"use strict";(self.webpackChunkwebgi=self.webpackChunkwebgi||[]).push([[453],{4330:function(e,t,s){s.d(t,{Accessor:function(){return ee},Zt:function(){return se},BD:function(){return re},oY:function(){return M},i5:function(){return C},hj:function(){return Ae},eY:function(){return oe},aw:function(){return g},Pp:function(){return v},MathUtils:function(){return P},WV:function(){return de},uS:function(){return p},fC:function(){return Re},TextureChannel:function(){return x},lO:function(){return ae},WC:function(){return Le},qi:function(){return _e},zX:function(){return b}});class r{constructor(){this._listeners={}}addEventListener(e,t){const s=this._listeners;return void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t),this}removeEventListener(e,t){if(void 0===this._listeners)return this;const s=this._listeners[e];if(void 0!==s){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}return this}dispatchEvent(e){if(void 0===this._listeners)return this;const t=this._listeners[e.type];if(void 0!==t){const s=t.slice(0);for(let t=0,r=s.length;t<r;t++)s[t].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class n extends r{constructor(e,t,s,r={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=s,this._attributes=r,!t.isOnGraph(s))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}}class i extends r{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){return this.listParentEdges(e).map((e=>e.getParent()))}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){return this.listChildEdges(e).map((e=>e.getChild()))}disconnectParents(e,t){let s=this.listParentEdges(e);return t&&(s=s.filter((e=>t(e.getParent())))),s.forEach((e=>e.dispose())),this}createEdge(e,t,s,r){return this._registerEdge(new n(e,t,s,r))}_registerEdge(e){this._edges.add(e);const t=e.getParent();this._parentEdges.has(t)||this._parentEdges.set(t,new Set),this._parentEdges.get(t).add(e);const s=e.getChild();return this._childEdges.has(s)||this._childEdges.set(s,new Set),this._childEdges.get(s).add(e),e.addEventListener("dispose",(()=>this._removeEdge(e))),e}_removeEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},o.apply(this,arguments)}function a(e){return e instanceof n}function c(e){return Array.isArray(e)&&e[0]instanceof n}function u(e){return!!(function(e){return Boolean(e)&&Object.getPrototypeOf(e)===Object.prototype}(e)&&function(e){for(const t in e)return e[t]}(e)instanceof n)}const h=Symbol("attributes"),l=Symbol("immutableKeys");class f extends r{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[h]=void 0,this[l]=void 0,this.graph=e,this[l]=new Set,this[h]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const s in e){const r=e[s];if(r instanceof f){const e=this.graph.createEdge(s,this,r);e.addEventListener("dispose",(()=>r.dispose())),this[l].add(s),t[s]=e}else t[s]=r}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach((e=>e.dispose())),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const s in this[h]){const r=this[h][s];if(a(r)){const n=r;n.getChild()===e&&this.setRef(s,t,n.getAttributes())}else if(c(r)){const n=r.find((t=>t.getChild()===e));if(n){const r=n.getAttributes();this.removeRef(s,e).addRef(s,t,r)}}else if(u(r)){const n=r;for(const r in n){const i=n[r];i.getChild()===e&&this.setRefMap(s,r,t,i.getAttributes())}}}return this}get(e){return this[h][e]}set(e,t){return this[h][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[h][e];return t?t.getChild():null}setRef(e,t,s){if(this[l].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const r=this[h][e];if(r&&r.dispose(),!t)return this;const n=this.graph.createEdge(e,this,t,s);return n.addEventListener("dispose",(()=>{delete this[h][e],this.dispatchEvent({type:"change",attribute:e})})),this[h][e]=n,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this[h][e].map((e=>e.getChild()))}addRef(e,t,s){const r=this.graph.createEdge(e,this,t,s),n=this[h][e];return n.push(r),r.addEventListener("dispose",(()=>{const t=n.filter((e=>e!==r));n.length=0;for(const e of t)n.push(e);this.dispatchEvent({type:"change",attribute:e})})),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){return this[h][e].filter((e=>e.getChild()===t)).forEach((e=>e.dispose())),this}listRefMapKeys(e){return Object.keys(this[h][e])}listRefMapValues(e){return Object.values(this[h][e]).map((e=>e.getChild()))}getRefMap(e,t){const s=this[h][e];return s[t]?s[t].getChild():null}setRefMap(e,t,s,r){const n=this[h][e],i=n[t];if(i&&i.dispose(),!s)return this;r=Object.assign(r||{},{key:t});const a=this.graph.createEdge(e,this,s,o({},r,{key:t}));return a.addEventListener("dispose",(()=>{delete n[t],this.dispatchEvent({type:"change",attribute:e,key:t})})),n[t]=a,this.dispatchEvent({type:"change",attribute:e,key:t})}dispatchEvent(e){return super.dispatchEvent(o({},e,{target:this})),this.graph.dispatchEvent(o({},e,{target:this,type:`node:${e.type}`})),this}}const g="@glb.bin";var p,d,m,x,T,E;(E=p||(p={})).ACCESSOR="Accessor",E.ANIMATION="Animation",E.ANIMATION_CHANNEL="AnimationChannel",E.ANIMATION_SAMPLER="AnimationSampler",E.BUFFER="Buffer",E.CAMERA="Camera",E.MATERIAL="Material",E.MESH="Mesh",E.PRIMITIVE="Primitive",E.PRIMITIVE_TARGET="PrimitiveTarget",E.NODE="Node",E.ROOT="Root",E.SCENE="Scene",E.SKIN="Skin",E.TEXTURE="Texture",E.TEXTURE_INFO="TextureInfo",function(e){e.INTERLEAVED="interleaved",e.SEPARATE="separate"}(d||(d={})),function(e){e.ARRAY_BUFFER="ARRAY_BUFFER",e.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",e.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",e.OTHER="OTHER",e.SPARSE="SPARSE"}(m||(m={})),function(e){e[e.R=4096]="R",e[e.G=256]="G",e[e.B=16]="B",e[e.A=1]="A"}(x||(x={})),function(e){e.GLTF="GLTF",e.GLB="GLB"}(T||(T={}));const y={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var R,I,A="undefined"!=typeof Float32Array?Float32Array:Array;function S(e){return Math.hypot(e[0],e[1],e[2])}function N(e,t,s){var r=t[0],n=t[1],i=t[2],o=s[3]*r+s[7]*n+s[11]*i+s[15];return e[0]=(s[0]*r+s[4]*n+s[8]*i+s[12])/(o=o||1),e[1]=(s[1]*r+s[5]*n+s[9]*i+s[13])/o,e[2]=(s[2]*r+s[6]*n+s[10]*i+s[14])/o,e}function b(e){const t={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},s=e.propertyType===p.NODE?[e]:e.listChildren();for(const e of s)e.traverse((e=>{const s=e.getMesh();if(!s)return;const r=w(s,e.getWorldMatrix());_(r.min,t),_(r.max,t)}));return t}function w(e,t){const s={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const r of e.listPrimitives()){const e=r.getAttribute("POSITION");if(!e)continue;let n=[0,0,0],i=[0,0,0];for(let r=0;r<e.getCount();r++)n=e.getElement(r,n),i=N(i,n,t),_(i,s)}return s}function _(e,t){for(let s=0;s<3;s++)t.min[s]=Math.min(e[s],t.min[s]),t.max[s]=Math.max(e[s],t.max[s])}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),R=new A(3),A!=Float32Array&&(R[0]=0,R[1]=0,R[2]=0);class M{static createBufferFromDataURI(e){if("undefined"==typeof Buffer){const t=atob(e.split(",")[1]),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}{const t=e.split(",")[1],s=e.indexOf("base64")>=0;return Buffer.from(t,s?"base64":"utf8")}}static encodeText(e){return"undefined"!=typeof TextEncoder?(new TextEncoder).encode(e):Buffer.from(e)}static decodeText(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}static concat(e){let t=0;for(const s of e)t+=s.byteLength;const s=new Uint8Array(t);let r=0;for(const t of e)s.set(t,r),r+=t.byteLength;return s}static pad(e,t=0){const s=this.padNumber(e.byteLength);if(s===e.byteLength)return e;const r=new Uint8Array(s);if(r.set(e),0!==t)for(let n=e.byteLength;n<s;n++)r[n]=t;return r}static padNumber(e){return 4*Math.ceil(e/4)}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let s=e.byteLength;for(;s--;)if(e[s]!==t[s])return!1;return!0}static toView(e,t=0,s=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,s))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class C{static hexToFactor(e,t){e=Math.floor(e);const s=t;return s[0]=(e>>16&255)/255,s[1]=(e>>8&255)/255,s[2]=(255&e)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[s,r,n]=this.convertLinearToSRGB(e,t);return 255*s<<16^255*r<<8^255*n<<0}static convertSRGBToLinear(e,t){const s=e,r=t;for(let e=0;e<3;e++)r[e]=s[e]<.04045?.0773993808*s[e]:Math.pow(.9478672986*s[e]+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const s=e,r=t;for(let e=0;e<3;e++)r[e]=s[e]<.0031308?12.92*s[e]:1.055*Math.pow(s[e],.41666)-.055;return t}}class O{match(e){return e.length>=8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return M.decodeText(e.slice(12,16))===O.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}O.PNG_FRIED_CHUNK_NAME="CgBI";class v{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let s=0;const r=this.getSize(e,t);if(!r)return null;for(;r[0]>1||r[1]>1;)s+=r[0]*r[1]*4,r[0]=Math.max(Math.floor(r[0]/2),1),r[1]=Math.max(Math.floor(r[1]/2),1);return s+=4,s}static mimeTypeToExtension(e){return"image/jpeg"===e?"jpg":e.split("/").pop()}static extensionToMimeType(e){return"jpg"===e?"image/jpeg":e?`image/${e}`:""}}function D(e,t){if(t>e.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(255!==e.getUint8(t))throw new TypeError("Invalid JPG, marker table corrupted");return e}v.impls={"image/jpeg":new class{match(e){return e.length>=3&&255===e[0]&&216===e[1]&&255===e[2]}getSize(e){let t,s,r=new DataView(e.buffer,e.byteOffset+4);for(;r.byteLength;){if(t=r.getUint16(0,!1),D(r,t),s=r.getUint8(t+1),192===s||193===s||194===s)return[r.getUint16(t+7,!1),r.getUint16(t+5,!1)];r=new DataView(e.buffer,r.byteOffset+t+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}},"image/png":new O};class F{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return v.mimeTypeToExtension(t)}return e.startsWith("data:model/gltf+json")?"gltf":e.startsWith("data:model/gltf-binary")?"glb":e.startsWith("data:application/")?"bin":e.split(/[\\/]/).pop().split(/[.]/).pop()}}function U(e){return"[object Object]"===Object.prototype.toString.call(e)}function B(e){if(!1===U(e))return!1;const t=e.constructor;if(void 0===t)return!0;const s=t.prototype;return!1!==U(s)&&!1!==Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")}!function(e){e[e.SILENT=4]="SILENT",e[e.ERROR=3]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=1]="INFO",e[e.DEBUG=0]="DEBUG"}(I||(I={}));class L{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=L.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=L.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=L.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=L.Verbosity.ERROR&&console.error(e)}}function j(e,t,s){var r=t[0],n=t[1],i=t[2],o=t[3],a=t[4],c=t[5],u=t[6],h=t[7],l=t[8],f=t[9],g=t[10],p=t[11],d=t[12],m=t[13],x=t[14],T=t[15],E=s[0],y=s[1],R=s[2],I=s[3];return e[0]=E*r+y*a+R*l+I*d,e[1]=E*n+y*c+R*f+I*m,e[2]=E*i+y*u+R*g+I*x,e[3]=E*o+y*h+R*p+I*T,e[4]=(E=s[4])*r+(y=s[5])*a+(R=s[6])*l+(I=s[7])*d,e[5]=E*n+y*c+R*f+I*m,e[6]=E*i+y*u+R*g+I*x,e[7]=E*o+y*h+R*p+I*T,e[8]=(E=s[8])*r+(y=s[9])*a+(R=s[10])*l+(I=s[11])*d,e[9]=E*n+y*c+R*f+I*m,e[10]=E*i+y*u+R*g+I*x,e[11]=E*o+y*h+R*p+I*T,e[12]=(E=s[12])*r+(y=s[13])*a+(R=s[14])*l+(I=s[15])*d,e[13]=E*n+y*c+R*f+I*m,e[14]=E*i+y*u+R*g+I*x,e[15]=E*o+y*h+R*p+I*T,e}L.Verbosity=I,L.DEFAULT_INSTANCE=new L(L.Verbosity.INFO);class P{static identity(e){return e}static eq(e,t,s=1e-5){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(Math.abs(e[r]-t[r])>s)return!1;return!0}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static denormalize(e,t){return P.decodeNormalizedInt(e,t)}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(65535*e);case 5121:return Math.round(255*e);case 5122:return Math.round(32767*e);case 5120:return Math.round(127*e);default:throw new Error("Invalid component type.")}}static normalize(e,t){return P.encodeNormalizedInt(e,t)}static decompose(e,t,s,r){let n=S([e[0],e[1],e[2]]);const i=S([e[4],e[5],e[6]]),o=S([e[8],e[9],e[10]]);var a,c,u,h,l,f,g,p,d,m,x,T,E,y,R,I,N;((c=(a=e)[0])*(g=a[5])-(u=a[1])*(f=a[4]))*((T=a[10])*(N=a[15])-(E=a[11])*(I=a[14]))-(c*(p=a[6])-(h=a[2])*f)*((x=a[9])*N-E*(R=a[13]))+(c*(d=a[7])-(l=a[3])*f)*(x*I-T*R)+(u*p-h*g)*((m=a[8])*N-E*(y=a[12]))-(u*d-l*g)*(m*I-T*y)+(h*d-l*p)*(m*R-x*y)<0&&(n=-n),t[0]=e[12],t[1]=e[13],t[2]=e[14];const b=e.slice(),w=1/n,_=1/i,M=1/o;b[0]*=w,b[1]*=w,b[2]*=w,b[4]*=_,b[5]*=_,b[6]*=_,b[8]*=M,b[9]*=M,b[10]*=M,function(e,t){var s=new A(3);!function(e,t){var s=t[4],r=t[5],n=t[6],i=t[8],o=t[9],a=t[10];e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(s,r,n),e[2]=Math.hypot(i,o,a)}(s,t);var r=1/s[0],n=1/s[1],i=1/s[2],o=t[0]*r,a=t[1]*n,c=t[2]*i,u=t[4]*r,h=t[5]*n,l=t[6]*i,f=t[8]*r,g=t[9]*n,p=t[10]*i,d=o+h+p,m=0;d>0?(m=2*Math.sqrt(d+1),e[3]=.25*m,e[0]=(l-g)/m,e[1]=(f-c)/m,e[2]=(a-u)/m):o>h&&o>p?(m=2*Math.sqrt(1+o-h-p),e[3]=(l-g)/m,e[0]=.25*m,e[1]=(a+u)/m,e[2]=(f+c)/m):h>p?(m=2*Math.sqrt(1+h-o-p),e[3]=(f-c)/m,e[0]=(a+u)/m,e[1]=.25*m,e[2]=(l+g)/m):(m=2*Math.sqrt(1+p-o-h),e[3]=(a-u)/m,e[0]=(f+c)/m,e[1]=(l+g)/m,e[2]=.25*m)}(s,b),r[0]=n,r[1]=i,r[2]=o}static compose(e,t,s,r){const n=r,i=t[0],o=t[1],a=t[2],c=t[3],u=i+i,h=o+o,l=a+a,f=i*u,g=i*h,p=i*l,d=o*h,m=o*l,x=a*l,T=c*u,E=c*h,y=c*l,R=s[0],I=s[1],A=s[2];return n[0]=(1-(d+x))*R,n[1]=(g+y)*R,n[2]=(p-E)*R,n[3]=0,n[4]=(g-y)*I,n[5]=(1-(f+x))*I,n[6]=(m+T)*I,n[7]=0,n[8]=(p+E)*A,n[9]=(m-T)*A,n[10]=(1-(f+d))*A,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}}function V(e,t){if(!!e!=!!t)return!1;const s=e.getChild(),r=t.getChild();return s===r||s.equals(r)}function k(e,t){if(!!e!=!!t)return!1;if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++){const r=e[s],n=t[s];if(r.getChild()!==n.getChild()&&!r.getChild().equals(n.getChild()))return!1}return!0}function G(e,t){if(!!e!=!!t)return!1;const s=Object.keys(e),r=Object.keys(t);if(s.length!==r.length)return!1;for(const s in e){const r=e[s],n=t[s];if(!!r!=!!n)return!1;const i=r.getChild(),o=n.getChild();if(i!==o&&!i.equals(o))return!1}return!0}function H(e,t){if(e===t)return!0;if(!!e!=!!t||!e||!t)return!1;if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}function z(e,t){if(e===t)return!0;if(!!e!=!!t)return!1;if(!B(e)||!B(t))return e===t;const s=e,r=t;let n,i=0,o=0;for(n in s)i++;for(n in r)o++;if(i!==o)return!1;for(n in s){const e=s[n],t=r[n];if(X(e)&&X(t)){if(!H(e,t))return!1}else if(B(e)&&B(t)){if(!z(e,t))return!1}else if(e!==t)return!1}return!0}function X(e){return Array.isArray(e)||ArrayBuffer.isView(e)}const Y="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",K=new Set,q=function(){let e="";for(let t=0;t<6;t++)e+=Y.charAt(Math.floor(Math.random()*Y.length));return e};class W{static dirname(e){const t=e.lastIndexOf("/");return-1===t?"./":e.substring(0,t+1)}static basename(e){return F.basename(new URL(e,"https://null.example").pathname)}static extension(e){return F.extension(new URL(e,"https://null.example").pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const s=e.split("/"),r=t.split("/");s.pop();for(let e=0;e<r.length;e++)"."!==r[e]&&(".."===r[e]?s.pop():s.push(r[e]));return s.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}W.DEFAULT_INIT={},W.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const $=e=>e,J=new Set;class Z extends f{constructor(e,t=""){super(e),this[h].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){return new(0,this.constructor)(this.graph).copy(this,$)}copy(e,t=$){for(const e in this[h]){const t=this[h][e];if(t instanceof n)this[l].has(e)||t.dispose();else if(c(t))for(const e of t)e.dispose();else if(u(t))for(const e in t)t[e].dispose()}for(const s in e[h]){const r=this[h][s],i=e[h][s];if(i instanceof n)this[l].has(s)?r.getChild().copy(t(i.getChild()),t):this.setRef(s,t(i.getChild()),i.getAttributes());else if(c(i))for(const e of i)this.addRef(s,t(e.getChild()),e.getAttributes());else if(u(i))for(const e in i){const r=i[e];this.setRefMap(s,e,t(r.getChild()),r.getAttributes())}else this[h][s]=B(i)?JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.slice():i}return this}equals(e,t=J){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const s in this[h]){if(t.has(s))continue;const r=this[h][s],n=e[h][s];if(a(r)||a(n)){if(!V(r,n))return!1}else if(c(r)||c(n)){if(!k(r,n))return!1}else if(u(r)||u(n)){if(!G(r,n))return!1}else if(B(r)||B(n)){if(!z(r,n))return!1}else if(X(r)||X(n)){if(!H(r,n))return!1}else if(r!==n)return!1}return!0}detach(){return this.graph.disconnectParents(this,(e=>"Root"!==e.propertyType)),this}listParents(){return this.graph.listParents(this)}}class Q extends Z{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t.t(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class ee extends Q{constructor(...e){super(...e),this.i=P.identity,this.o=P.identity}init(){this.propertyType=p.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:ee.Type.SCALAR,componentType:ee.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}copy(e,t=$){return super.copy(e,t),this.i=e.i,this.o=e.o,this}static getElementSize(e){switch(e){case ee.Type.SCALAR:return 1;case ee.Type.VEC2:return 2;case ee.Type.VEC3:return 3;case ee.Type.VEC4:case ee.Type.MAT2:return 4;case ee.Type.MAT3:return 9;case ee.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case ee.ComponentType.BYTE:case ee.ComponentType.UNSIGNED_BYTE:return 1;case ee.ComponentType.SHORT:case ee.ComponentType.UNSIGNED_SHORT:return 2;case ee.ComponentType.UNSIGNED_INT:case ee.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getElementSize();this.getMin(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMin(e){const t=this.get("array"),s=this.getCount(),r=this.getElementSize();for(let t=0;t<r;t++)e[t]=1/0;for(let n=0;n<s*r;n+=r)for(let s=0;s<r;s++){const r=t[n+s];Number.isFinite(r)&&(e[s]=Math.min(e[s],r))}return e}getMaxNormalized(e){const t=this.getElementSize();this.getMax(e);for(let s=0;s<t;s++)e[s]=this.o(e[s]);return e}getMax(e){const t=this.get("array"),s=this.getCount(),r=this.getElementSize();for(let t=0;t<r;t++)e[t]=-1/0;for(let n=0;n<s*r;n+=r)for(let s=0;s<r;s++){const r=t[n+s];Number.isFinite(r)&&(e[s]=Math.max(e[s],r))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return ee.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e),e?(this.o=e=>P.decodeNormalizedInt(e,this.get("componentType")),this.i=e=>P.encodeNormalizedInt(e,this.get("componentType"))):(this.o=P.identity,this.i=P.identity),this}getScalar(e){const t=this.getElementSize();return this.o(this.get("array")[e*t])}setScalar(e,t){return this.get("array")[e*this.getElementSize()]=this.i(t),this}getElement(e,t){const s=this.getElementSize(),r=this.get("array");for(let n=0;n<s;n++)t[n]=this.o(r[e*s+n]);return t}setElement(e,t){const s=this.getElementSize(),r=this.get("array");for(let n=0;n<s;n++)r[e*s+n]=this.i(t[n]);return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?function(e){switch(e.constructor){case Float32Array:return ee.ComponentType.FLOAT;case Uint32Array:return ee.ComponentType.UNSIGNED_INT;case Uint16Array:return ee.ComponentType.UNSIGNED_SHORT;case Uint8Array:return ee.ComponentType.UNSIGNED_BYTE;case Int16Array:return ee.ComponentType.SHORT;case Int8Array:return ee.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(e):ee.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}ee.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},ee.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};class te extends Q{init(){this.propertyType=p.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}class se extends Q{init(){this.propertyType=p.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}se.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class re extends Q{init(){this.propertyType=p.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:re.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:m.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:m.OTHER})}}re.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class ne extends Q{init(){this.propertyType=p.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}class ie extends Q{init(){this.propertyType=p.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:ie.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}ie.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class oe extends Z{t(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}oe.EXTENSION_NAME=void 0;class ae extends Q{init(){this.propertyType=p.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:ae.WrapMode.REPEAT,wrapT:ae.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}ae.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},ae.MagFilter={NEAREST:9728,LINEAR:9729},ae.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:ce,G:ue,B:he,A:le}=x;class fe extends Q{init(){this.propertyType=p.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:fe.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new ae(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new ae(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new ae(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new ae(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new ae(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorHex(){return C.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(e){const t=this.get("baseColorFactor").slice();return this.set("baseColorFactor",C.hexToFactor(e,t))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:ce|ue|he|le})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveHex(){return C.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(e){const t=this.get("emissiveFactor").slice();return this.set("emissiveFactor",C.hexToFactor(e,t))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:ce|ue|he})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:ce|ue|he})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:ce})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ue|he})}}fe.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class ge extends Q{init(){this.propertyType=p.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class pe extends Q{constructor(...e){super(...e),this.u=null}init(){this.propertyType=p.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(e,t=$){if(t===$)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return P.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),s=this.get("rotation").slice(),r=this.get("scale").slice();return P.decompose(e,t,s,r),this.set("translation",t).set("rotation",s).set("scale",r)}getWorldTranslation(){const e=[0,0,0];return P.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return P.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return P.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let t=this;null!=t;t=t.u)e.push(t);let t;const s=e.pop().getMatrix();for(;t=e.pop();)j(s,s,t.getMatrix());return s}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.u=this;const t=this[h].children;return t[t.length-1].addEventListener("dispose",(()=>e.u=null)),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParent(){return this.u?this.u:this.listParents().find((e=>e.propertyType===p.SCENE))||null}getParentNode(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}class de extends Q{init(){this.propertyType=p.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:de.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:m.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:m.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}de.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class me extends Z{init(){this.propertyType=p.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:m.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function xe(){return(xe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}class Te extends Q{init(){this.propertyType=p.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(e,t=$){if(t===$)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class Ee extends Q{init(){this.propertyType=p.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:m.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class ye extends Q{init(){this.propertyType=p.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||v.extensionToMimeType(F.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=v.extensionToMimeType(F.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",M.assertView(e))}getSize(){const e=this.get("image");return e?v.getSize(e,this.getMimeType()):null}}class Re extends Q{init(){this.propertyType=p.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:"glTF-Transform v3.2.1",version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(e){super(e),this.h=new Set,e.addEventListener("node:create",(e=>{this.l(e.target)}))}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=$){if(t===$)throw new Error("Root cannot be copied.");this.set("asset",xe({},e.get("asset"))),this.setName(e.getName()),this.setExtras(xe({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const s of e.listRefMapKeys("extensions")){const r=e.getExtension(s);this.setExtension(s,t(r))}return this}l(e){return e instanceof Te?this.addRef("scenes",e):e instanceof pe?this.addRef("nodes",e):e instanceof ie?this.addRef("cameras",e):e instanceof Ee?this.addRef("skins",e):e instanceof ge?this.addRef("meshes",e):e instanceof fe?this.addRef("materials",e):e instanceof ye?this.addRef("textures",e):e instanceof te?this.addRef("animations",e):e instanceof ee?this.addRef("accessors",e):e instanceof ne&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.h)}listExtensionsRequired(){return this.listExtensionsUsed().filter((e=>e.isRequired()))}g(e){return this.h.add(e),this}p(e){return this.h.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class Ie{static fromGraph(e){return Ie.m.get(e)||null}constructor(){this.v=new i,this.T=new Re(this.v),this.M=L.DEFAULT_INSTANCE,Ie.m.set(this.v,this)}getRoot(){return this.T}getGraph(){return this.v}getLogger(){return this.M}setLogger(e){return this.M=e,this}clone(){return(new Ie).setLogger(this.M).merge(this)}merge(e){for(const t of e.getRoot().listExtensionsUsed()){const e=this.createExtension(t.constructor);t.isRequired()&&e.setRequired(!0)}const t=new Set,s=new Map;t.add(e.T),s.set(e.T,this.T);for(const r of e.v.listEdges())for(const e of[r.getParent(),r.getChild()]){if(t.has(e))continue;let r;r=e.propertyType===p.TEXTURE_INFO?e:new(0,e.constructor)(this.v),s.set(e,r),t.add(e)}const r=e=>{const t=s.get(e);if(!t)throw new Error("Could resolve property.");return t};for(const e of t){const t=s.get(e);if(!t)throw new Error("Could resolve property.");t.propertyType!==p.TEXTURE_INFO&&t.copy(e,r)}return this}async transform(...e){const t=e.map((e=>e.name));for(const s of e)await s(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find((e=>e.extensionName===t))||new e(this)}createScene(e=""){return new Te(this.v,e)}createNode(e=""){return new pe(this.v,e)}createCamera(e=""){return new ie(this.v,e)}createSkin(e=""){return new Ee(this.v,e)}createMesh(e=""){return new ge(this.v,e)}createPrimitive(){return new de(this.v)}createPrimitiveTarget(e=""){return new me(this.v,e)}createMaterial(e=""){return new fe(this.v,e)}createTexture(e=""){return new ye(this.v,e)}createAnimation(e=""){return new te(this.v,e)}createAnimationChannel(e=""){return new se(this.v,e)}createAnimationSampler(e=""){return new re(this.v,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new ee(this.v,e).setBuffer(t)}createBuffer(e=""){return new ne(this.v,e)}}Ie.m=new WeakMap;class Ae{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.S=void 0,this.document=e,e.getRoot().g(this),this.S=e=>{const t=e,s=t.target;s instanceof oe&&s.extensionName===this.extensionName&&("node:create"===t.type&&this.I(s),"node:dispose"===t.type&&this.N(s))};const t=e.getGraph();t.addEventListener("node:create",this.S),t.addEventListener("node:dispose",this.S)}dispose(){this.document.getRoot().p(this);const e=this.document.getGraph();e.removeEventListener("node:create",this.S),e.removeEventListener("node:dispose",this.S);for(const e of this.properties)e.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}I(e){return this.properties.add(e),this}N(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}Ae.EXTENSION_NAME=void 0;class Se{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),void 0!==t.texCoord&&e.setTexCoord(t.texCoord),void 0!==t.extras&&e.setExtras(t.extras);const s=this.jsonDoc.json.textures[t.index];if(void 0===s.sampler)return;const r=this.jsonDoc.json.samplers[s.sampler];void 0!==r.magFilter&&e.setMagFilter(r.magFilter),void 0!==r.minFilter&&e.setMinFilter(r.minFilter),void 0!==r.wrapS&&e.setWrapS(r.wrapS),void 0!==r.wrapT&&e.setWrapT(r.wrapT)}}const Ne={logger:L.DEFAULT_INSTANCE,extensions:[],dependencies:{}};function be(e,t){const s=t.bufferViews[e.bufferView],r=t.jsonDoc.json.bufferViews[e.bufferView],n=y[e.componentType],i=ee.getElementSize(e.type),o=n.BYTES_PER_ELEMENT;if(void 0!==r.byteStride&&r.byteStride!==i*o)return function(e,t){const s=t.bufferViews[e.bufferView],r=t.jsonDoc.json.bufferViews[e.bufferView],n=y[e.componentType],i=ee.getElementSize(e.type),o=n.BYTES_PER_ELEMENT,a=e.byteOffset||0,c=new n(e.count*i),u=new DataView(s.buffer,s.byteOffset,s.byteLength),h=r.byteStride;for(let t=0;t<e.count;t++)for(let s=0;s<i;s++){const r=a+t*h+s*o;let n;switch(e.componentType){case ee.ComponentType.FLOAT:n=u.getFloat32(r,!0);break;case ee.ComponentType.UNSIGNED_INT:n=u.getUint32(r,!0);break;case ee.ComponentType.UNSIGNED_SHORT:n=u.getUint16(r,!0);break;case ee.ComponentType.UNSIGNED_BYTE:n=u.getUint8(r);break;case ee.ComponentType.SHORT:n=u.getInt16(r,!0);break;case ee.ComponentType.BYTE:n=u.getInt8(r);break;default:throw new Error(`Unexpected componentType "${e.componentType}".`)}c[t*i+s]=n}return c}(e,t);const a=s.byteOffset+(e.byteOffset||0);return new n(s.buffer.slice(a,a+e.count*i*o))}var we;!function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(we||(we={}));class _e{constructor(e,t,s){this.O=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.C=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.O=e,this.jsonDoc=t,this.options=s;const r=e.getRoot(),n=r.listBuffers().length,i=r.listTextures().length;this.bufferURIGenerator=new Me(n>1,(()=>s.basename||"buffer")),this.imageURIGenerator=new Me(i>1,(t=>function(e,t){const s=e.getGraph().listParentEdges(t).find((t=>t.getParent()!==e.getRoot()));return s?s.getName().replace(/texture$/i,""):""}(e,t)||s.basename||"texture")),this.logger=e.getLogger()}createTextureInfoDef(e,t){const s={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},r=JSON.stringify(s);this.samplerDefIndexMap.has(r)||(this.samplerDefIndexMap.set(r,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(s));const n={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(r)},i=JSON.stringify(n);this.textureDefIndexMap.has(i)||(this.textureDefIndexMap.set(i,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(n));const o={index:this.textureDefIndexMap.get(i)};return 0!==t.getTexCoord()&&(o.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(o.extras=t.getExtras()),this.textureInfoDefMap.set(t,o),o}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this.O.getGraph().listParentEdges(e).some((e=>"attributes"===e.getName()&&"POSITION"===e.getAttributes().key||"input"===e.getName()))&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,s){if(this.options.format===T.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const r=v.mimeTypeToExtension(s.getMimeType());e.uri=this.imageURIGenerator.createURI(s,r),this.jsonDoc.resources[e.uri]=t}}getAccessorUsage(e){const t=this.C.get(e);if(t)return t;if(e.getSparse())return m.SPARSE;for(const t of this.O.getGraph().listParentEdges(e)){const{usage:e}=t.getAttributes();if(e)return e;t.getParent().propertyType!==p.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${t.getName()}".`)}return m.OTHER}addAccessorToUsageGroup(e,t){const s=this.C.get(e);if(s&&s!==t)throw new Error(`Accessor with usage "${s}" cannot be reused as "${t}".`);return this.C.set(e,t),this}listAccessorUsageGroups(){const e={};for(const[t,s]of Array.from(this.C.entries()))e[s]=e[s]||[],e[s].push(t);return e}}_e.BufferViewTarget=we,_e.BufferViewUsage=m,_e.USAGE_TO_TARGET={[m.ARRAY_BUFFER]:we.ARRAY_BUFFER,[m.ELEMENT_ARRAY_BUFFER]:we.ELEMENT_ARRAY_BUFFER};class Me{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const s=this.basename(e);return this.counter[s]=this.counter[s]||1,`${s}_${this.counter[s]++}.${t}`}return`${this.basename(e)}.${t}`}}const{BufferViewUsage:Ce}=_e,{UNSIGNED_INT:Oe,UNSIGNED_SHORT:ve,UNSIGNED_BYTE:De}=ee.ComponentType;var Fe;!function(e){e[e.JSON=1313821514]="JSON",e[e.BIN=5130562]="BIN"}(Fe||(Fe={}));class Ue{constructor(){this.M=L.DEFAULT_INSTANCE,this.h=new Set,this.F={},this.U=d.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this.M=e,this}registerExtensions(e){for(const t of e)this.h.add(t),t.register();return this}registerDependencies(e){return Object.assign(this.F,e),this}setVertexLayout(e){return this.U=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const s=Be(t)?this.P(t):{json:JSON.parse(M.decodeText(t)),resources:{}};return await this.L(s,this.dirname(e)),this.j(s),s}async readJSON(e){return e=this.D(e),this.j(e),class{static read(e,t=Ne){const s=xe({},Ne,t),{json:r}=e,n=(new Ie).setLogger(s.logger);this.validate(e,s);const i=new Se(e),o=r.asset,a=n.getRoot().getAsset();o.copyright&&(a.copyright=o.copyright),o.extras&&(a.extras=o.extras),void 0!==r.extras&&n.getRoot().setExtras(xe({},r.extras));const c=r.extensionsUsed||[],u=r.extensionsRequired||[];for(const e of s.extensions)if(c.includes(e.EXTENSION_NAME)){const t=n.createExtension(e).setRequired(u.includes(e.EXTENSION_NAME));for(const e of t.readDependencies)t.install(e,s.dependencies[e])}const h=r.buffers||[];n.getRoot().listExtensionsUsed().filter((e=>e.prereadTypes.includes(p.BUFFER))).forEach((e=>e.preread(i,p.BUFFER))),i.buffers=h.map((e=>{const t=n.createBuffer(e.name);return e.extras&&t.setExtras(e.extras),e.uri&&0!==e.uri.indexOf("__")&&t.setURI(e.uri),t})),i.bufferViewBuffers=(r.bufferViews||[]).map(((t,s)=>{if(!i.bufferViews[s]){const r=e.json.buffers[t.buffer];i.bufferViews[s]=M.toView(r.uri?e.resources[r.uri]:e.resources["@glb.bin"],t.byteOffset||0,t.byteLength)}return i.buffers[t.buffer]}));const l=r.accessors||[];i.accessors=l.map((e=>{const t=n.createAccessor(e.name,i.bufferViewBuffers[e.bufferView]).setType(e.type);return e.extras&&t.setExtras(e.extras),void 0!==e.normalized&&t.setNormalized(e.normalized),void 0===e.bufferView||t.setArray(be(e,i)),t}));const f=r.images||[],g=r.textures||[];n.getRoot().listExtensionsUsed().filter((e=>e.prereadTypes.includes(p.TEXTURE))).forEach((e=>e.preread(i,p.TEXTURE))),i.textures=f.map((t=>{const s=n.createTexture(t.name);if(t.extras&&s.setExtras(t.extras),void 0!==t.bufferView){const n=r.bufferViews[t.bufferView],i=e.json.buffers[n.buffer],o=n.byteOffset||0,a=(i.uri?e.resources[i.uri]:e.resources["@glb.bin"]).slice(o,o+n.byteLength);s.setImage(a)}else void 0!==t.uri&&(s.setImage(e.resources[t.uri]),0!==t.uri.indexOf("__")&&s.setURI(t.uri));if(void 0!==t.mimeType)s.setMimeType(t.mimeType);else if(t.uri){const e=F.extension(t.uri);s.setMimeType(v.extensionToMimeType(e))}return s})),i.materials=(r.materials||[]).map((e=>{const t=n.createMaterial(e.name);e.extras&&t.setExtras(e.extras),void 0!==e.alphaMode&&t.setAlphaMode(e.alphaMode),void 0!==e.alphaCutoff&&t.setAlphaCutoff(e.alphaCutoff),void 0!==e.doubleSided&&t.setDoubleSided(e.doubleSided);const s=e.pbrMetallicRoughness||{};if(void 0!==s.baseColorFactor&&t.setBaseColorFactor(s.baseColorFactor),void 0!==e.emissiveFactor&&t.setEmissiveFactor(e.emissiveFactor),void 0!==s.metallicFactor&&t.setMetallicFactor(s.metallicFactor),void 0!==s.roughnessFactor&&t.setRoughnessFactor(s.roughnessFactor),void 0!==s.baseColorTexture){const e=s.baseColorTexture;t.setBaseColorTexture(i.textures[g[e.index].source]),i.setTextureInfo(t.getBaseColorTextureInfo(),e)}if(void 0!==e.emissiveTexture){const s=e.emissiveTexture;t.setEmissiveTexture(i.textures[g[s.index].source]),i.setTextureInfo(t.getEmissiveTextureInfo(),s)}if(void 0!==e.normalTexture){const s=e.normalTexture;t.setNormalTexture(i.textures[g[s.index].source]),i.setTextureInfo(t.getNormalTextureInfo(),s),void 0!==e.normalTexture.scale&&t.setNormalScale(e.normalTexture.scale)}if(void 0!==e.occlusionTexture){const s=e.occlusionTexture;t.setOcclusionTexture(i.textures[g[s.index].source]),i.setTextureInfo(t.getOcclusionTextureInfo(),s),void 0!==e.occlusionTexture.strength&&t.setOcclusionStrength(e.occlusionTexture.strength)}if(void 0!==s.metallicRoughnessTexture){const e=s.metallicRoughnessTexture;t.setMetallicRoughnessTexture(i.textures[g[e.index].source]),i.setTextureInfo(t.getMetallicRoughnessTextureInfo(),e)}return t}));const d=r.meshes||[];n.getRoot().listExtensionsUsed().filter((e=>e.prereadTypes.includes(p.PRIMITIVE))).forEach((e=>e.preread(i,p.PRIMITIVE))),i.meshes=d.map((e=>{const t=n.createMesh(e.name);return e.extras&&t.setExtras(e.extras),void 0!==e.weights&&t.setWeights(e.weights),(e.primitives||[]).forEach((s=>{const r=n.createPrimitive();s.extras&&r.setExtras(s.extras),void 0!==s.material&&r.setMaterial(i.materials[s.material]),void 0!==s.mode&&r.setMode(s.mode);for(const[e,t]of Object.entries(s.attributes||{}))r.setAttribute(e,i.accessors[t]);void 0!==s.indices&&r.setIndices(i.accessors[s.indices]);const o=e.extras&&e.extras.targetNames||[];(s.targets||[]).forEach(((e,t)=>{const s=o[t]||t.toString(),a=n.createPrimitiveTarget(s);for(const[t,s]of Object.entries(e))a.setAttribute(t,i.accessors[s]);r.addTarget(a)})),t.addPrimitive(r)})),t})),i.cameras=(r.cameras||[]).map((e=>{const t=n.createCamera(e.name).setType(e.type);if(e.extras&&t.setExtras(e.extras),e.type===ie.Type.PERSPECTIVE){const s=e.perspective;t.setYFov(s.yfov),t.setZNear(s.znear),void 0!==s.zfar&&t.setZFar(s.zfar),void 0!==s.aspectRatio&&t.setAspectRatio(s.aspectRatio)}else{const s=e.orthographic;t.setZNear(s.znear).setZFar(s.zfar).setXMag(s.xmag).setYMag(s.ymag)}return t}));const m=r.nodes||[];n.getRoot().listExtensionsUsed().filter((e=>e.prereadTypes.includes(p.NODE))).forEach((e=>e.preread(i,p.NODE))),i.nodes=m.map((e=>{const t=n.createNode(e.name);if(e.extras&&t.setExtras(e.extras),void 0!==e.translation&&t.setTranslation(e.translation),void 0!==e.rotation&&t.setRotation(e.rotation),void 0!==e.scale&&t.setScale(e.scale),void 0!==e.matrix){const s=[0,0,0],r=[0,0,0,1],n=[1,1,1];P.decompose(e.matrix,s,r,n),t.setTranslation(s),t.setRotation(r),t.setScale(n)}return void 0!==e.weights&&t.setWeights(e.weights),t})),i.skins=(r.skins||[]).map((e=>{const t=n.createSkin(e.name);e.extras&&t.setExtras(e.extras),void 0!==e.inverseBindMatrices&&t.setInverseBindMatrices(i.accessors[e.inverseBindMatrices]),void 0!==e.skeleton&&t.setSkeleton(i.nodes[e.skeleton]);for(const s of e.joints)t.addJoint(i.nodes[s]);return t})),m.map(((e,t)=>{const s=i.nodes[t];(e.children||[]).forEach((e=>s.addChild(i.nodes[e]))),void 0!==e.mesh&&s.setMesh(i.meshes[e.mesh]),void 0!==e.camera&&s.setCamera(i.cameras[e.camera]),void 0!==e.skin&&s.setSkin(i.skins[e.skin])})),i.animations=(r.animations||[]).map((e=>{const t=n.createAnimation(e.name);e.extras&&t.setExtras(e.extras);const s=(e.samplers||[]).map((e=>{const s=n.createAnimationSampler().setInput(i.accessors[e.input]).setOutput(i.accessors[e.output]).setInterpolation(e.interpolation||re.Interpolation.LINEAR);return e.extras&&s.setExtras(e.extras),t.addSampler(s),s}));return(e.channels||[]).forEach((e=>{const r=n.createAnimationChannel().setSampler(s[e.sampler]).setTargetPath(e.target.path);void 0!==e.target.node&&r.setTargetNode(i.nodes[e.target.node]),e.extras&&r.setExtras(e.extras),t.addChannel(r)})),t}));const x=r.scenes||[];return n.getRoot().listExtensionsUsed().filter((e=>e.prereadTypes.includes(p.SCENE))).forEach((e=>e.preread(i,p.SCENE))),i.scenes=x.map((e=>{const t=n.createScene(e.name);return e.extras&&t.setExtras(e.extras),(e.nodes||[]).map((e=>i.nodes[e])).forEach((e=>t.addChild(e))),t})),void 0!==r.scene&&n.getRoot().setDefaultScene(i.scenes[r.scene]),n.getRoot().listExtensionsUsed().forEach((e=>e.read(i))),l.forEach(((e,t)=>{const s=i.accessors[t],r=!!e.sparse,n=!e.bufferView&&!s.getArray();(r||n)&&s.setSparse(!0).setArray(function(e,t){const s=y[e.componentType],r=ee.getElementSize(e.type);let n;n=void 0!==e.bufferView?be(e,t):new s(e.count*r);const i=e.sparse;if(!i)return n;const o=i.count,a=xe({},e,i.indices,{count:o,type:"SCALAR"}),c=xe({},e,i.values,{count:o}),u=be(a,t),h=be(c,t);for(let e=0;e<a.count;e++)for(let t=0;t<r;t++)n[u[e]*r+t]=h[e*r+t];return n}(e,i))})),n}static validate(e,t){const s=e.json;if("2.0"!==s.asset.version)throw new Error(`Unsupported glTF version, "${s.asset.version}".`);if(s.extensionsRequired)for(const e of s.extensionsRequired)if(!t.extensions.find((t=>t.EXTENSION_NAME===e)))throw new Error(`Missing required extension, "${e}".`);if(s.extensionsUsed)for(const e of s.extensionsUsed)t.extensions.find((t=>t.EXTENSION_NAME===e))||t.logger.warn(`Missing optional extension, "${e}".`)}}.read(e,{extensions:Array.from(this.h),dependencies:this.F,logger:this.M})}async binaryToJSON(e){const t=this.P(M.assertView(e));this.j(t);const s=t.json;if(s.buffers&&s.buffers.some((e=>function(e,t){return void 0!==t.uri&&!(t.uri in e.resources)}(t,e))))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(s.images&&s.images.some((e=>function(e,t){return void 0!==t.uri&&!(t.uri in e.resources)&&void 0===t.bufferView}(t,e))))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(M.assertView(e)))}async writeJSON(e,t={}){if(t.format===T.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 0–1 buffers.");return class{static write(e,t){const s=e.getRoot(),r={asset:xe({generator:"glTF-Transform v3.2.1"},s.getAsset()),extras:xe({},s.getExtras())},n={json:r,resources:{}},i=new _e(e,n,t),o=t.logger||L.DEFAULT_INSTANCE,a=new Set(t.extensions.map((e=>e.EXTENSION_NAME))),c=e.getRoot().listExtensionsUsed().filter((e=>a.has(e.extensionName))),u=e.getRoot().listExtensionsRequired().filter((e=>a.has(e.extensionName)));c.length<e.getRoot().listExtensionsUsed().length&&o.warn("Some extensions were not registered for I/O, and will not be written.");for(const e of c)for(const s of e.writeDependencies)e.install(s,t.dependencies[s]);function h(e,t,s,n){const o=[];let a=0;for(const t of e){const e=i.createAccessorDef(t);e.bufferView=r.bufferViews.length;const s=t.getArray(),n=M.pad(M.toView(s));e.byteOffset=a,a+=n.byteLength,o.push(n),i.accessorIndexMap.set(t,r.accessors.length),r.accessors.push(e)}const c={buffer:t,byteOffset:s,byteLength:M.concat(o).byteLength};return n&&(c.target=n),r.bufferViews.push(c),{buffers:o,byteLength:a}}function l(e,t,s){const n=e[0].getCount();let o=0;for(const t of e){const e=i.createAccessorDef(t);e.bufferView=r.bufferViews.length,e.byteOffset=o;const s=t.getElementSize(),n=t.getComponentSize();o+=M.padNumber(s*n),i.accessorIndexMap.set(t,r.accessors.length),r.accessors.push(e)}const a=n*o,c=new ArrayBuffer(a),u=new DataView(c);for(let t=0;t<n;t++){let s=0;for(const r of e){const e=r.getElementSize(),n=r.getComponentSize(),i=r.getComponentType(),a=r.getArray();for(let r=0;r<e;r++){const c=t*o+s+r*n,h=a[t*e+r];switch(i){case ee.ComponentType.FLOAT:u.setFloat32(c,h,!0);break;case ee.ComponentType.BYTE:u.setInt8(c,h);break;case ee.ComponentType.SHORT:u.setInt16(c,h,!0);break;case ee.ComponentType.UNSIGNED_BYTE:u.setUint8(c,h);break;case ee.ComponentType.UNSIGNED_SHORT:u.setUint16(c,h,!0);break;case ee.ComponentType.UNSIGNED_INT:u.setUint32(c,h,!0);break;default:throw new Error("Unexpected component type: "+i)}}s+=M.padNumber(e*n)}}return r.bufferViews.push({buffer:t,byteOffset:s,byteLength:a,byteStride:o,target:_e.BufferViewTarget.ARRAY_BUFFER}),{byteLength:a,buffers:[new Uint8Array(c)]}}function f(e,t,s){const n=[];let a=0;const c=new Map;let u=-1/0;for(const t of e){const e=i.createAccessorDef(t);r.accessors.push(e),i.accessorIndexMap.set(t,r.accessors.length-1);const s=[],n=[],a=[],h=new Array(t.getElementSize()).fill(0);for(let e=0,r=t.getCount();e<r;e++)if(t.getElement(e,a),!P.eq(a,h,0)){u=Math.max(e,u),s.push(e);for(let e=0;e<a.length;e++)n.push(a[e])}const l=s.length,f={accessorDef:e,count:l};if(c.set(t,f),0===l)continue;if(l>t.getCount()/3){const e=(100*s.length/t.getCount()).toFixed(1);o.warn(`Sparse accessor with many non-zero elements (${e}%) may increase file size.`)}const g=y[t.getComponentType()];f.indices=s,f.values=new g(n)}if(!Number.isFinite(u))return{buffers:n,byteLength:a};const h=u<255?Uint8Array:u<65535?Uint16Array:Uint32Array,l=u<255?De:u<65535?ve:Oe,f={buffer:t,byteOffset:s+a,byteLength:0};for(const t of e){const e=c.get(t);if(0===e.count)continue;e.indicesByteOffset=f.byteLength;const s=M.pad(M.toView(new h(e.indices)));n.push(s),a+=s.byteLength,f.byteLength+=s.byteLength}r.bufferViews.push(f);const g=r.bufferViews.length-1,p={buffer:t,byteOffset:s+a,byteLength:0};for(const t of e){const e=c.get(t);if(0===e.count)continue;e.valuesByteOffset=p.byteLength;const s=M.pad(M.toView(e.values));n.push(s),a+=s.byteLength,p.byteLength+=s.byteLength}r.bufferViews.push(p);const d=r.bufferViews.length-1;for(const t of e){const e=c.get(t);0!==e.count&&(e.accessorDef.sparse={count:e.count,indices:{bufferView:g,byteOffset:e.indicesByteOffset,componentType:l},values:{bufferView:d,byteOffset:e.valuesByteOffset}})}return{buffers:n,byteLength:a}}const g=new Map;for(const t of e.getGraph().listEdges()){if(t.getParent()===s)continue;const e=t.getChild();if(e instanceof ee){const s=g.get(e)||[];s.push(t),g.set(e,s)}}if(r.accessors=[],r.bufferViews=[],r.samplers=[],r.textures=[],r.images=s.listTextures().map(((e,t)=>{const s=i.createPropertyDef(e);e.getMimeType()&&(s.mimeType=e.getMimeType());const r=e.getImage();return r&&i.createImageData(s,r,e),i.imageIndexMap.set(e,t),s})),c.filter((e=>e.prewriteTypes.includes(p.ACCESSOR))).forEach((e=>e.prewrite(i,p.ACCESSOR))),s.listAccessors().forEach((e=>{const t=i.accessorUsageGroupedByParent,s=i.accessorParents;if(i.accessorIndexMap.has(e))return;const r=g.get(e)||[],n=i.getAccessorUsage(e);if(i.addAccessorToUsageGroup(e,n),t.has(n)){const t=r[0].getParent(),n=s.get(t)||new Set;n.add(e),s.set(t,n)}})),c.filter((e=>e.prewriteTypes.includes(p.BUFFER))).forEach((e=>e.prewrite(i,p.BUFFER))),(s.listAccessors().length>0||s.listTextures().length>0||i.otherBufferViews.size>0)&&0===s.listBuffers().length)throw new Error("Buffer required for Document resources, but none was found.");r.buffers=[],s.listBuffers().forEach(((e,s)=>{const o=i.createPropertyDef(e),a=i.accessorUsageGroupedByParent,c=i.accessorParents,u=e.listParents().filter((e=>e instanceof ee)),g=new Set(u),p=[],m=r.buffers.length;let x=0;const E=i.listAccessorUsageGroups();for(const e in E)if(a.has(e))for(const s of Array.from(c.values())){const r=Array.from(s).filter((e=>g.has(e))).filter((t=>i.getAccessorUsage(t)===e));if(r.length)if(e!==Ce.ARRAY_BUFFER||t.vertexLayout===d.INTERLEAVED){const t=e===Ce.ARRAY_BUFFER?l(r,m,x):h(r,m,x);x+=t.byteLength,p.push(...t.buffers)}else for(const e of r){const t=l([e],m,x);x+=t.byteLength,p.push(...t.buffers)}}else{const t=E[e].filter((e=>g.has(e)));if(!t.length)continue;const s=e===Ce.ELEMENT_ARRAY_BUFFER?_e.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0,r=e===Ce.SPARSE?f(t,m,x):h(t,m,x,s);x+=r.byteLength,p.push(...r.buffers)}if(i.imageBufferViews.length&&0===s)for(let e=0;e<i.imageBufferViews.length;e++)if(r.bufferViews[r.images[e].bufferView].byteOffset=x,x+=i.imageBufferViews[e].byteLength,p.push(i.imageBufferViews[e]),x%8){const e=8-x%8;x+=e,p.push(new Uint8Array(e))}if(i.otherBufferViews.has(e))for(const t of i.otherBufferViews.get(e))r.bufferViews.push({buffer:m,byteOffset:x,byteLength:t.byteLength}),i.otherBufferViewsIndexMap.set(t,r.bufferViews.length-1),x+=t.byteLength,p.push(t);if(x){let s;t.format===T.GLB?s="@glb.bin":(s=i.bufferURIGenerator.createURI(e,"bin"),o.uri=s),o.byteLength=x,n.resources[s]=M.concat(p)}r.buffers.push(o),i.bufferIndexMap.set(e,s)})),s.listAccessors().find((e=>!e.getBuffer()))&&o.warn("Skipped writing one or more Accessors: no Buffer assigned."),r.materials=s.listMaterials().map(((e,t)=>{const s=i.createPropertyDef(e);if(e.getAlphaMode()!==fe.AlphaMode.OPAQUE&&(s.alphaMode=e.getAlphaMode()),e.getAlphaMode()===fe.AlphaMode.MASK&&(s.alphaCutoff=e.getAlphaCutoff()),e.getDoubleSided()&&(s.doubleSided=!0),s.pbrMetallicRoughness={},P.eq(e.getBaseColorFactor(),[1,1,1,1])||(s.pbrMetallicRoughness.baseColorFactor=e.getBaseColorFactor()),P.eq(e.getEmissiveFactor(),[0,0,0])||(s.emissiveFactor=e.getEmissiveFactor()),1!==e.getRoughnessFactor()&&(s.pbrMetallicRoughness.roughnessFactor=e.getRoughnessFactor()),1!==e.getMetallicFactor()&&(s.pbrMetallicRoughness.metallicFactor=e.getMetallicFactor()),e.getBaseColorTexture()){const t=e.getBaseColorTexture(),r=e.getBaseColorTextureInfo();s.pbrMetallicRoughness.baseColorTexture=i.createTextureInfoDef(t,r)}if(e.getEmissiveTexture()){const t=e.getEmissiveTexture(),r=e.getEmissiveTextureInfo();s.emissiveTexture=i.createTextureInfoDef(t,r)}if(e.getNormalTexture()){const t=e.getNormalTexture(),r=e.getNormalTextureInfo(),n=i.createTextureInfoDef(t,r);1!==e.getNormalScale()&&(n.scale=e.getNormalScale()),s.normalTexture=n}if(e.getOcclusionTexture()){const t=e.getOcclusionTexture(),r=e.getOcclusionTextureInfo(),n=i.createTextureInfoDef(t,r);1!==e.getOcclusionStrength()&&(n.strength=e.getOcclusionStrength()),s.occlusionTexture=n}if(e.getMetallicRoughnessTexture()){const t=e.getMetallicRoughnessTexture(),r=e.getMetallicRoughnessTextureInfo();s.pbrMetallicRoughness.metallicRoughnessTexture=i.createTextureInfoDef(t,r)}return i.materialIndexMap.set(e,t),s})),r.meshes=s.listMeshes().map(((e,t)=>{const s=i.createPropertyDef(e);let r=null;return s.primitives=e.listPrimitives().map((e=>{const t={attributes:{}};t.mode=e.getMode();const s=e.getMaterial();s&&(t.material=i.materialIndexMap.get(s)),Object.keys(e.getExtras()).length&&(t.extras=e.getExtras());const n=e.getIndices();n&&(t.indices=i.accessorIndexMap.get(n));for(const s of e.listSemantics())t.attributes[s]=i.accessorIndexMap.get(e.getAttribute(s));for(const s of e.listTargets()){const e={};for(const t of s.listSemantics())e[t]=i.accessorIndexMap.get(s.getAttribute(t));t.targets=t.targets||[],t.targets.push(e)}return e.listTargets().length&&!r&&(r=e.listTargets().map((e=>e.getName()))),t})),e.getWeights().length&&(s.weights=e.getWeights()),r&&(s.extras=s.extras||{},s.extras.targetNames=r),i.meshIndexMap.set(e,t),s})),r.cameras=s.listCameras().map(((e,t)=>{const s=i.createPropertyDef(e);if(s.type=e.getType(),s.type===ie.Type.PERSPECTIVE){s.perspective={znear:e.getZNear(),zfar:e.getZFar(),yfov:e.getYFov()};const t=e.getAspectRatio();null!==t&&(s.perspective.aspectRatio=t)}else s.orthographic={znear:e.getZNear(),zfar:e.getZFar(),xmag:e.getXMag(),ymag:e.getYMag()};return i.cameraIndexMap.set(e,t),s})),r.nodes=s.listNodes().map(((e,t)=>{const s=i.createPropertyDef(e);return P.eq(e.getTranslation(),[0,0,0])||(s.translation=e.getTranslation()),P.eq(e.getRotation(),[0,0,0,1])||(s.rotation=e.getRotation()),P.eq(e.getScale(),[1,1,1])||(s.scale=e.getScale()),e.getWeights().length&&(s.weights=e.getWeights()),i.nodeIndexMap.set(e,t),s})),r.skins=s.listSkins().map(((e,t)=>{const s=i.createPropertyDef(e),r=e.getInverseBindMatrices();r&&(s.inverseBindMatrices=i.accessorIndexMap.get(r));const n=e.getSkeleton();return n&&(s.skeleton=i.nodeIndexMap.get(n)),s.joints=e.listJoints().map((e=>i.nodeIndexMap.get(e))),i.skinIndexMap.set(e,t),s})),s.listNodes().forEach(((e,t)=>{const s=r.nodes[t],n=e.getMesh();n&&(s.mesh=i.meshIndexMap.get(n));const o=e.getCamera();o&&(s.camera=i.cameraIndexMap.get(o));const a=e.getSkin();a&&(s.skin=i.skinIndexMap.get(a)),e.listChildren().length>0&&(s.children=e.listChildren().map((e=>i.nodeIndexMap.get(e))))})),r.animations=s.listAnimations().map(((e,t)=>{const s=i.createPropertyDef(e),r=new Map;return s.samplers=e.listSamplers().map(((e,t)=>{const s=i.createPropertyDef(e);return s.input=i.accessorIndexMap.get(e.getInput()),s.output=i.accessorIndexMap.get(e.getOutput()),s.interpolation=e.getInterpolation(),r.set(e,t),s})),s.channels=e.listChannels().map((e=>{const t=i.createPropertyDef(e);return t.sampler=r.get(e.getSampler()),t.target={node:i.nodeIndexMap.get(e.getTargetNode()),path:e.getTargetPath()},t})),i.animationIndexMap.set(e,t),s})),r.scenes=s.listScenes().map(((e,t)=>{const s=i.createPropertyDef(e);return s.nodes=e.listChildren().map((e=>i.nodeIndexMap.get(e))),i.sceneIndexMap.set(e,t),s}));const m=s.getDefaultScene();return m&&(r.scene=s.listScenes().indexOf(m)),r.extensionsUsed=c.map((e=>e.extensionName)),r.extensionsRequired=u.map((e=>e.extensionName)),c.forEach((e=>e.write(i))),function(e){const t=[];for(const s in e){const r=e[s];(Array.isArray(r)&&0===r.length||null===r||""===r||r&&"object"==typeof r&&0===Object.keys(r).length)&&t.push(s)}for(const s of t)delete e[s]}(r),n}}.write(e,{format:t.format||T.GLTF,basename:t.basename||"",logger:this.M,vertexLayout:this.U,dependencies:xe({},this.F),extensions:Array.from(this.h)})}async writeBinary(e){const{json:t,resources:s}=await this.writeJSON(e,{format:T.GLB}),r=new Uint32Array([1179937895,2,12]),n=JSON.stringify(t),i=M.pad(M.encodeText(n),32),o=M.toView(new Uint32Array([i.byteLength,1313821514])),a=M.concat([o,i]);r[r.length-1]+=a.byteLength;const c=Object.values(s)[0];if(!c||!c.byteLength)return M.concat([M.toView(r),a]);const u=M.pad(c,0),h=M.toView(new Uint32Array([u.byteLength,5130562])),l=M.concat([h,u]);return r[r.length-1]+=l.byteLength,M.concat([M.toView(r),a,l])}async L(e,t){var s=this;const r=[...e.json.images||[],...e.json.buffers||[]].map((async function(r){const n=r.uri;if(!n||n.match(/data:/))return Promise.resolve();e.resources[n]=await s.readURI(s.resolve(t,n),"view"),s.lastReadBytes+=e.resources[n].byteLength}));await Promise.all(r)}j(e){function t(t){if(t.uri)if(t.uri in e.resources)M.assertView(e.resources[t.uri]);else if(t.uri.match(/data:/)){const s=`__${function(){for(let e=0;e<999;e++){const e=q();if(!K.has(e))return K.add(e),e}return""}()}.${F.extension(t.uri)}`;e.resources[s]=M.createBufferFromDataURI(t.uri),t.uri=s}}(e.json.images||[]).forEach((e=>{if(void 0===e.bufferView&&void 0===e.uri)throw new Error("Missing resource URI or buffer view.");t(e)})),(e.json.buffers||[]).forEach(t)}D(e){const{images:t,buffers:s}=e.json;return e={json:xe({},e.json),resources:xe({},e.resources)},t&&(e.json.images=t.map((e=>xe({},e)))),s&&(e.json.buffers=s.map((e=>xe({},e)))),e}P(e){if(!Be(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==Fe.JSON)throw new Error("Missing required GLB JSON chunk.");const s=t[0],r=M.decodeText(M.toView(e,20,s)),n=JSON.parse(r),i=20+s;if(e.byteLength<=i)return{json:n,resources:{}};const o=new Uint32Array(e.buffer,e.byteOffset+i,2);if(o[1]!==Fe.BIN)throw new Error("Expected GLB BIN in second chunk.");return{json:n,resources:{"@glb.bin":M.toView(e,i+8,o[0])}}}}function Be(e){if(e.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const t=new Uint32Array(e.buffer,e.byteOffset,3);return 1179937895===t[0]&&2===t[1]}class Le extends Ue{constructor(e=W.DEFAULT_INIT){super(),this.k=void 0,this.k=e}async readURI(e,t){const s=await fetch(e,this.k);switch(t){case"view":return new Uint8Array(await s.arrayBuffer());case"text":return s.text()}}resolve(e,t){return W.resolve(e,t)}dirname(e){return W.dirname(e)}}},9453:function(e,t,s){s.d(t,{BR:function(){return At},r7:function(){return ee}});var r=s(4330);const n=64;class i{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class o{constructor(e,t,s,r){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,s),this._littleEndian=r,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_skip(e){return this._offset+=e,this}_scan(e,t=0){const s=this._offset;let r=0;for(;this._dataView.getUint8(this._offset)!==t&&r<e;)r++,this._offset++;return r<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,r)}}new Uint8Array([0]);const a=[171,75,84,88,32,50,48,187,13,10,26,10];function c(e){return"undefined"!=typeof TextDecoder?(new TextDecoder).decode(e):Buffer.from(e).toString("utf8")}function u(e){const t=new Uint8Array(e.buffer,e.byteOffset,a.length);if(t[0]!==a[0]||t[1]!==a[1]||t[2]!==a[2]||t[3]!==a[3]||t[4]!==a[4]||t[5]!==a[5]||t[6]!==a[6]||t[7]!==a[7]||t[8]!==a[8]||t[9]!==a[9]||t[10]!==a[10]||t[11]!==a[11])throw new Error("Missing KTX 2.0 identifier.");const s=new i,r=17*Uint32Array.BYTES_PER_ELEMENT,u=new o(e,a.length,r,!0);s.vkFormat=u._nextUint32(),s.typeSize=u._nextUint32(),s.pixelWidth=u._nextUint32(),s.pixelHeight=u._nextUint32(),s.pixelDepth=u._nextUint32(),s.layerCount=u._nextUint32(),s.faceCount=u._nextUint32();const h=u._nextUint32();s.supercompressionScheme=u._nextUint32();const l=u._nextUint32(),f=u._nextUint32(),g=u._nextUint32(),p=u._nextUint32(),d=u._nextUint64(),m=u._nextUint64(),x=3*h*8,T=new o(e,a.length+r,x,!0);for(let t=0;t<h;t++)s.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+T._nextUint64(),T._nextUint64()),uncompressedByteLength:T._nextUint64()});const E=new o(e,l,f,!0),y={vendorId:E._skip(4)._nextUint16(),descriptorType:E._nextUint16(),versionNumber:E._nextUint16(),descriptorBlockSize:E._nextUint16(),colorModel:E._nextUint8(),colorPrimaries:E._nextUint8(),transferFunction:E._nextUint8(),flags:E._nextUint8(),texelBlockDimension:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],bytesPlane:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],samples:[]},R=(y.descriptorBlockSize/4-6)/4;for(let e=0;e<R;e++){const t={bitOffset:E._nextUint16(),bitLength:E._nextUint8(),channelType:E._nextUint8(),samplePosition:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};t.channelType&n?(t.sampleLower=E._nextInt32(),t.sampleUpper=E._nextInt32()):(t.sampleLower=E._nextUint32(),t.sampleUpper=E._nextUint32()),y.samples[e]=t}s.dataFormatDescriptor.length=0,s.dataFormatDescriptor.push(y);const I=new o(e,g,p,!0);for(;I._offset<p;){const e=I._nextUint32(),t=I._scan(e),r=c(t),n=I._scan(e-t.byteLength);s.keyValue[r]=r.match(/^ktx/i)?c(n):n,I._offset%4&&I._skip(4-I._offset%4)}if(m<=0)return s;const A=new o(e,d,m,!0),S=A._nextUint16(),N=A._nextUint16(),b=A._nextUint32(),w=A._nextUint32(),_=A._nextUint32(),M=A._nextUint32(),C=[];for(let e=0;e<h;e++)C.push({imageFlags:A._nextUint32(),rgbSliceByteOffset:A._nextUint32(),rgbSliceByteLength:A._nextUint32(),alphaSliceByteOffset:A._nextUint32(),alphaSliceByteLength:A._nextUint32()});const O=d+A._offset,v=O+b,D=v+w,F=D+_,U=new Uint8Array(e.buffer,e.byteOffset+O,b),B=new Uint8Array(e.buffer,e.byteOffset+v,w),L=new Uint8Array(e.buffer,e.byteOffset+D,_),j=new Uint8Array(e.buffer,e.byteOffset+F,M);return s.globalData={endpointCount:S,selectorCount:N,imageDescs:C,endpointsData:U,selectorsData:B,tablesData:L,extendedData:j},s}class h extends r.eY{init(){this.extensionName="EXT_mesh_gpu_instancing",this.propertyType="InstancedMesh",this.parentTypes=[r.uS.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:"INSTANCE_ATTRIBUTE"})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}h.EXTENSION_NAME="EXT_mesh_gpu_instancing";const l="EXT_mesh_gpu_instancing";class f extends r.hj{constructor(...e){super(...e),this.extensionName=l,this.provideTypes=[r.uS.NODE],this.prewriteTypes=[r.uS.ACCESSOR]}createInstancedMesh(){return new h(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach(((t,s)=>{if(!t.extensions||!t.extensions[l])return;const r=t.extensions[l],n=this.createInstancedMesh();for(const t in r.attributes)n.setAttribute(t,e.accessors[r.attributes[t]]);e.nodes[s].setExtension(l,n)})),this}prewrite(e){e.accessorUsageGroupedByParent.add("INSTANCE_ATTRIBUTE");for(const t of this.properties)for(const s of t.listAttributes())e.addAccessorToUsageGroup(s,"INSTANCE_ATTRIBUTE");return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach((s=>{const r=s.getExtension(l);if(r){const n=e.nodeIndexMap.get(s),i=t.json.nodes[n],o={attributes:{}};r.listSemantics().forEach((t=>{const s=r.getAttribute(t);o.attributes[t]=e.accessorIndexMap.get(s)})),i.extensions=i.extensions||{},i.extensions[l]=o}})),this}}function g(){return(g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}var p,d,m,x;f.EXTENSION_NAME=l,(x=p||(p={})).QUANTIZE="quantize",x.FILTER="filter",function(e){e.ATTRIBUTES="ATTRIBUTES",e.TRIANGLES="TRIANGLES",e.INDICES="INDICES"}(d||(d={})),function(e){e.NONE="NONE",e.OCTAHEDRAL="OCTAHEDRAL",e.QUATERNION="QUATERNION",e.EXPONENTIAL="EXPONENTIAL"}(m||(m={}));const{BYTE:T,SHORT:E,FLOAT:y}=r.Accessor.ComponentType,{encodeNormalizedInt:R,decodeNormalizedInt:I}=r.MathUtils;function A(e,t,s,n){const{filter:i,bits:o}=n,a={array:e.getArray(),byteStride:e.getElementSize()*e.getComponentSize(),componentType:e.getComponentType(),normalized:e.getNormalized()};if(s!==d.ATTRIBUTES)return a;if(i!==m.NONE){let s=e.getNormalized()?function(e){const t=e.getComponentType(),s=e.getArray(),r=new Float32Array(s.length);for(let e=0;e<s.length;e++)r[e]=I(s[e],t);return r}(e):new Float32Array(a.array);switch(i){case m.EXPONENTIAL:a.byteStride=4*e.getElementSize(),a.componentType=y,a.normalized=!1,a.array=t.encodeFilterExp(s,e.getCount(),a.byteStride,o);break;case m.OCTAHEDRAL:a.byteStride=o>8?8:4,a.componentType=o>8?E:T,a.normalized=!0,s=3===e.getElementSize()?function(e){const t=new Float32Array(4*e.length/3);for(let s=0,r=e.length/3;s<r;s++)t[4*s]=e[3*s],t[4*s+1]=e[3*s+1],t[4*s+2]=e[3*s+2];return t}(s):s,a.array=t.encodeFilterOct(s,e.getCount(),a.byteStride,o);break;case m.QUATERNION:a.byteStride=8,a.componentType=E,a.normalized=!0,a.array=t.encodeFilterQuat(s,e.getCount(),a.byteStride,o);break;default:throw new Error("Invalid filter.")}a.min=e.getMin([]),a.max=e.getMax([]),e.getNormalized()&&(a.min=a.min.map((t=>I(t,e.getComponentType()))),a.max=a.max.map((t=>I(t,e.getComponentType())))),a.normalized&&(a.min=a.min.map((e=>R(e,a.componentType))),a.max=a.max.map((e=>R(e,a.componentType))))}else a.byteStride%4&&(a.array=function(e,t){const s=r.oY.padNumber(e.BYTES_PER_ELEMENT*t)/e.BYTES_PER_ELEMENT,n=new e.constructor(e.length/t*s);for(let r=0;r*t<e.length;r++)for(let i=0;i<t;i++)n[r*s+i]=e[r*t+i];return n}(a.array,e.getElementSize()),a.byteStride=a.array.byteLength/e.getCount());return a}function S(e,t){return t===r.qi.BufferViewUsage.ELEMENT_ARRAY_BUFFER?e.listParents().some((e=>e instanceof r.WV&&e.getMode()===r.WV.Mode.TRIANGLES))?d.TRIANGLES:d.INDICES:d.ATTRIBUTES}function N(e,t){const s=t.getGraph().listParentEdges(e).filter((e=>!(e.getParent()instanceof r.fC)));for(const t of s){const s=t.getName(),r=t.getAttributes().key||"";if("indices"===s)return{filter:m.NONE};if("attributes"===s){if("POSITION"===r)return{filter:m.NONE};if("TEXCOORD_0"===r)return{filter:m.NONE};if("NORMAL"===r)return{filter:m.OCTAHEDRAL,bits:8};if("TANGENT"===r)return{filter:m.OCTAHEDRAL,bits:8};if(r.startsWith("JOINTS_"))return{filter:m.NONE};if(r.startsWith("WEIGHTS_"))return{filter:m.NONE}}if("output"===s){const t=b(e);return"rotation"===t?{filter:m.QUATERNION,bits:16}:"translation"===t||"scale"===t?{filter:m.EXPONENTIAL,bits:12}:{filter:m.NONE}}if("input"===s)return{filter:m.NONE};if("inverseBindMatrices"===s)return{filter:m.NONE}}return{filter:m.NONE}}function b(e){for(const t of e.listParents())if(t instanceof r.BD)for(const e of t.listParents())if(e instanceof r.Zt)return e.getTargetPath();return null}const w="EXT_meshopt_compression",_={method:p.QUANTIZE};class M extends r.hj{constructor(...e){super(...e),this.extensionName=w,this.prereadTypes=[r.uS.BUFFER,r.uS.PRIMITIVE],this.prewriteTypes=[r.uS.BUFFER,r.uS.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=_,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return"meshopt.decoder"===e&&(this._decoder=t),"meshopt.encoder"===e&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=g({},_,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${w}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${w}]: Missing WASM support.`)}return t===r.uS.BUFFER?this._prereadBuffers(e):t===r.uS.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(((s,n)=>{if(!s.extensions||!s.extensions[w])return;const i=s.extensions[w],o=i.byteOffset||0,a=i.byteLength||0,c=i.count,u=i.byteStride,h=new Uint8Array(c*u),l=t.json.buffers[i.buffer],f=r.oY.toView(l.uri?t.resources[l.uri]:t.resources[r.aw],o,a);this._decoder.decodeGltfBuffer(h,c,u,f,i.mode,i.filter),e.bufferViews[n]=h}))}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s=>{var r;s.extensions&&s.extensions[w]&&(r=t.json.buffers[s.buffer]).extensions&&r.extensions.EXT_meshopt_compression&&r.extensions.EXT_meshopt_compression.fallback&&this._decoderFallbackBufferMap.set(e.buffers[s.buffer],e.buffers[s.extensions[w].buffer])}))}read(e){if(!this.isRequired())return this;for(const[e,t]of this._decoderFallbackBufferMap){for(const s of e.listParents())s instanceof r.Accessor&&s.swap(e,t);e.dispose()}return this}prewrite(e,t){return t===r.uS.ACCESSOR?this._prewriteAccessors(e):t===r.uS.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,s=this._encoder,n=this._encoderOptions,i=this.document.createBuffer(),o=this.document.getRoot().listBuffers().indexOf(i);this._encoderFallbackBuffer=i,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const i of this.document.getRoot().listAccessors()){if("weights"===b(i))continue;if(i.getSparse())continue;const a=e.getAccessorUsage(i),c=S(i,a),u=n.method===p.FILTER?N(i,this.document):{filter:m.NONE},h=A(i,s,c,u),{array:l,byteStride:f}=h,g=i.getBuffer();if(!g)throw new Error(`${w}: Missing buffer for accessor.`);const d=this.document.getRoot().listBuffers().indexOf(g),x=[a,c,u.filter,f,d].join(":");let T=this._encoderBufferViews[x],E=this._encoderBufferViewData[x],y=this._encoderBufferViewAccessors[x];T&&E||(y=this._encoderBufferViewAccessors[x]=[],E=this._encoderBufferViewData[x]=[],T=this._encoderBufferViews[x]={buffer:o,target:r.qi.USAGE_TO_TARGET[a],byteOffset:0,byteLength:0,byteStride:a===r.qi.BufferViewUsage.ARRAY_BUFFER?f:void 0,extensions:{[w]:{buffer:d,byteOffset:0,byteLength:0,mode:c,filter:u.filter!==m.NONE?u.filter:void 0,byteStride:f,count:0}}});const R=e.createAccessorDef(i);R.componentType=h.componentType,R.normalized=h.normalized,R.byteOffset=T.byteLength,R.min&&h.min&&(R.min=h.min),R.max&&h.max&&(R.max=h.max),e.accessorIndexMap.set(i,t.accessors.length),t.accessors.push(R),y.push(R),E.push(new Uint8Array(l.buffer,l.byteOffset,l.byteLength)),T.byteLength+=l.byteLength,T.extensions.EXT_meshopt_compression.count+=i.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const s in this._encoderBufferViews){const n=this._encoderBufferViews[s],i=this._encoderBufferViewData[s],o=this.document.getRoot().listBuffers()[n.extensions[w].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:h}=n.extensions[w],l=r.oY.concat(i),f=t.encodeGltfBuffer(l,c,u,h),g=r.oY.pad(f);n.extensions[w].byteLength=f.byteLength,i.length=0,i.push(g),a.push(g),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const s in this._encoderBufferViews){const n=this._encoderBufferViews[s],i=e.otherBufferViewsIndexMap.get(this._encoderBufferViewData[s][0]),o=this._encoderBufferViewAccessors[s];for(const e of o)e.bufferView=i;const a=e.jsonDoc.json.bufferViews[i],c=a.byteOffset||0;Object.assign(a,n),a.byteOffset=t,a.extensions[w].byteOffset=c,t+=r.oY.padNumber(n.byteLength)}const s=this._encoderFallbackBuffer,n=e.bufferIndexMap.get(s),i=e.jsonDoc.json.buffers[n];return i.byteLength=t,i.extensions={[w]:{fallback:!0}},s.dispose(),this}}M.EXTENSION_NAME=w,M.EncoderMethod=p;const C="EXT_texture_avif";class O{match(e){return e.length>=12&&"ftypavif"===r.oY.decodeText(e.slice(4,12))}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let s=D(t,0);if(!s)return null;let r=s.end;for(;s=D(t,r);)if("meta"===s.type)r=s.start+4;else if("iprp"===s.type||"ipco"===s.type)r=s.start;else{if("ispe"===s.type)return[t.getUint32(s.start+4),t.getUint32(s.start+8)];if("mdat"===s.type)break;r=s.end}return null}getChannels(e){return 4}}class v extends r.hj{constructor(...e){super(...e),this.extensionName=C,this.prereadTypes=[r.uS.TEXTURE]}static register(){r.Pp.registerFormat("image/avif",new O)}preread(e){return(e.jsonDoc.json.textures||[]).forEach((e=>{e.extensions&&e.extensions[C]&&(e.source=e.extensions[C].source)})),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach((s=>{if("image/avif"===s.getMimeType()){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach((e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[C]={source:e.source},delete e.source)}))}})),this}}function D(e,t){if(e.byteLength<4+t)return null;const s=e.getUint32(t);return e.byteLength<s+t||s<8?null:{type:r.oY.decodeText(new Uint8Array(e.buffer,e.byteOffset+t+4,4)),start:t+8,end:t+s}}v.EXTENSION_NAME=C;const F="EXT_texture_webp";class U{match(e){return e.length>=12&&87===e[8]&&69===e[9]&&66===e[10]&&80===e[11]}getSize(e){const t=r.oY.decodeText(e.slice(0,4)),s=r.oY.decodeText(e.slice(8,12));if("RIFF"!==t||"WEBP"!==s)return null;const n=new DataView(e.buffer,e.byteOffset);let i=12;for(;i<n.byteLength;){const e=r.oY.decodeText(new Uint8Array([n.getUint8(i),n.getUint8(i+1),n.getUint8(i+2),n.getUint8(i+3)])),t=n.getUint32(i+4,!0);if("VP8 "===e)return[16383&n.getInt16(i+14,!0),16383&n.getInt16(i+16,!0)];if("VP8L"===e){const e=n.getUint8(i+9),t=n.getUint8(i+10),s=n.getUint8(i+11);return[1+((63&t)<<8|e),1+((15&n.getUint8(i+12))<<10|s<<2|(192&t)>>6)]}i+=8+t+t%2}return null}getChannels(e){return 4}}class B extends r.hj{constructor(...e){super(...e),this.extensionName=F,this.prereadTypes=[r.uS.TEXTURE]}static register(){r.Pp.registerFormat("image/webp",new U)}preread(e){return(e.jsonDoc.json.textures||[]).forEach((e=>{e.extensions&&e.extensions[F]&&(e.source=e.extensions[F].source)})),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach((s=>{if("image/webp"===s.getMimeType()){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach((e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[F]={source:e.source},delete e.source)}))}})),this}}B.EXTENSION_NAME=F;const L="KHR_draco_mesh_compression";let j,P,V,k;function G(e,t){const s=new j.DecoderBuffer;try{if(s.Init(t,t.length),e.GetEncodedGeometryType(s)!==j.TRIANGULAR_MESH)throw new Error(`[${L}] Unknown geometry type.`);const r=new j.Mesh;if(!e.DecodeBufferToMesh(s,r).ok()||0===r.ptr)throw new Error(`[${L}] Decoding failure.`);return r}finally{j.destroy(s)}}function H(e,t){const s=3*t.num_faces();let r,n;if(t.num_points()<=65534){const i=s*Uint16Array.BYTES_PER_ELEMENT;r=j._malloc(i),e.GetTrianglesUInt16Array(t,i,r),n=new Uint16Array(j.HEAPU16.buffer,r,s).slice()}else{const i=s*Uint32Array.BYTES_PER_ELEMENT;r=j._malloc(i),e.GetTrianglesUInt32Array(t,i,r),n=new Uint32Array(j.HEAPU32.buffer,r,s).slice()}return j._free(r),n}function z(e,t,s,r){const n=V[r.componentType],i=P[r.componentType],o=s.num_components(),a=t.num_points()*o,c=a*i.BYTES_PER_ELEMENT,u=j._malloc(c);e.GetAttributeDataArrayForAllPoints(t,s,n,c,u);const h=new i(j.HEAPF32.buffer,u,a).slice();return j._free(u),h}var X,Y;!function(e){e[e.EDGEBREAKER=1]="EDGEBREAKER",e[e.SEQUENTIAL=0]="SEQUENTIAL"}(X||(X={})),function(e){e.POSITION="POSITION",e.NORMAL="NORMAL",e.COLOR="COLOR",e.TEX_COORD="TEX_COORD",e.GENERIC="GENERIC"}(Y||(Y={}));const K={[Y.POSITION]:14,[Y.NORMAL]:10,[Y.COLOR]:8,[Y.TEX_COORD]:12,[Y.GENERIC]:12},q={decodeSpeed:5,encodeSpeed:5,method:X.EDGEBREAKER,quantizationBits:K,quantizationVolume:"mesh"};function W(e,t=q){const s=g({},q,t);s.quantizationBits=g({},K,t.quantizationBits);const r=new k.Encoder,n=new k.MeshBuilder,i=new k.Mesh,o={},a=new k.DracoInt8Array,c=e.listTargets().length>0;let u=!1;for(const t of e.listSemantics()){const a=e.getAttribute(t);if(a.getSparse()){u=!0;continue}const c=$(t),h=J(n,a.getComponentType(),i,k[c],a.getCount(),a.getElementSize(),a.getArray());if(-1===h)throw new Error(`Error compressing "${t}" attribute.`);if(o[t]=h,"mesh"===s.quantizationVolume||"POSITION"!==t)r.SetAttributeQuantization(k[c],s.quantizationBits[c]);else{if("object"!=typeof s.quantizationVolume)throw new Error("Invalid quantization volume state.");{const{quantizationVolume:e}=s,t=Math.max(e.max[0]-e.min[0],e.max[1]-e.min[1],e.max[2]-e.min[2]);r.SetAttributeExplicitQuantization(k[c],s.quantizationBits[c],a.getElementSize(),e.min,t)}}}const h=e.getIndices();if(!h)throw new Z("Primitive must have indices.");n.AddFacesToMesh(i,h.getCount()/3,h.getArray()),r.SetSpeedOptions(s.encodeSpeed,s.decodeSpeed),r.SetTrackEncodedProperties(!0),r.SetEncodingMethod(s.method===X.SEQUENTIAL||c||u?k.MESH_SEQUENTIAL_ENCODING:k.MESH_EDGEBREAKER_ENCODING);const l=r.EncodeMeshToDracoBuffer(i,a);if(l<=0)throw new Z("Error applying Draco compression.");const f=new Uint8Array(l);for(let e=0;e<l;++e)f[e]=a.GetValue(e);const p=e.getAttribute("POSITION").getCount(),d=r.GetNumberOfEncodedPoints(),m=3*r.GetNumberOfEncodedFaces();if((c||u)&&d!==p)throw new Z('Compression reduced vertex count unexpectedly, corrupting mesh data. Applying the "weld" function before compression may resolve the issue. See: https://github.com/google/draco/issues/929');return k.destroy(a),k.destroy(i),k.destroy(n),k.destroy(r),{numVertices:d,numIndices:m,data:f,attributeIDs:o}}function $(e){return"POSITION"===e?Y.POSITION:"NORMAL"===e?Y.NORMAL:e.startsWith("COLOR_")?Y.COLOR:e.startsWith("TEXCOORD_")?Y.TEX_COORD:Y.GENERIC}function J(e,t,s,n,i,o,a){switch(t){case r.Accessor.ComponentType.UNSIGNED_BYTE:return e.AddUInt8Attribute(s,n,i,o,a);case r.Accessor.ComponentType.BYTE:return e.AddInt8Attribute(s,n,i,o,a);case r.Accessor.ComponentType.UNSIGNED_SHORT:return e.AddUInt16Attribute(s,n,i,o,a);case r.Accessor.ComponentType.SHORT:return e.AddInt16Attribute(s,n,i,o,a);case r.Accessor.ComponentType.UNSIGNED_INT:return e.AddUInt32Attribute(s,n,i,o,a);case r.Accessor.ComponentType.FLOAT:return e.AddFloatAttribute(s,n,i,o,a);default:throw new Error(`Unexpected component type, "${t}".`)}}class Z extends Error{}const Q="KHR_draco_mesh_compression";class ee extends r.hj{constructor(...e){super(...e),this.extensionName=Q,this.prereadTypes=[r.uS.PRIMITIVE],this.prewriteTypes=[r.uS.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return"draco3d.decoder"===e&&(this._decoderModule=t,j=this._decoderModule,P={[r.Accessor.ComponentType.FLOAT]:Float32Array,[r.Accessor.ComponentType.UNSIGNED_INT]:Uint32Array,[r.Accessor.ComponentType.UNSIGNED_SHORT]:Uint16Array,[r.Accessor.ComponentType.UNSIGNED_BYTE]:Uint8Array,[r.Accessor.ComponentType.SHORT]:Int16Array,[r.Accessor.ComponentType.BYTE]:Int8Array},V={[r.Accessor.ComponentType.FLOAT]:j.DT_FLOAT32,[r.Accessor.ComponentType.UNSIGNED_INT]:j.DT_UINT32,[r.Accessor.ComponentType.UNSIGNED_SHORT]:j.DT_UINT16,[r.Accessor.ComponentType.UNSIGNED_BYTE]:j.DT_UINT8,[r.Accessor.ComponentType.SHORT]:j.DT_INT16,[r.Accessor.ComponentType.BYTE]:j.DT_INT8}),"draco3d.encoder"===e&&(this._encoderModule=t,k=this._encoderModule),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${Q}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),s=e.jsonDoc,n=new Map;try{const i=s.json.meshes||[];for(const o of i)for(const i of o.primitives){if(!i.extensions||!i.extensions[Q])continue;const o=i.extensions[Q];let[a,c]=n.get(o.bufferView)||[];if(!c||!a){const e=s.json.bufferViews[o.bufferView],i=s.json.buffers[e.buffer],u=r.oY.toView(i.uri?s.resources[i.uri]:s.resources[r.aw],e.byteOffset||0,e.byteLength);a=new this._decoderModule.Decoder,c=G(a,u),n.set(o.bufferView,[a,c]),t.debug(`[${Q}] Decompressed ${u.byteLength} bytes.`)}for(const t in i.attributes){const s=e.jsonDoc.json.accessors[i.attributes[t]],r=a.GetAttributeByUniqueId(c,o.attributes[t]),n=z(a,c,r,s);e.accessors[i.attributes[t]].setArray(n)}void 0!==i.indices&&e.accessors[i.indices].setArray(H(a,c))}}finally{for(const[e,t]of Array.from(n.values()))this._decoderModule.destroy(e),this._decoderModule.destroy(t)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${Q}] Please install extension dependency, "draco3d.encoder".`);const s=this.document.getLogger();s.debug(`[${Q}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const n=function(e){const t=e.getLogger(),s=new Set,n=new Set;for(const i of e.getRoot().listMeshes())for(const e of i.listPrimitives())e.getIndices()?e.getMode()!==r.WV.Mode.TRIANGLES?(n.add(e),t.warn(`[${Q}] Skipping Draco compression on non-TRIANGLES primitive.`)):s.add(e):(n.add(e),t.warn(`[${Q}] Skipping Draco compression on non-indexed primitive.`));const i=e.getRoot().listAccessors(),o=new Map;for(let e=0;e<i.length;e++)o.set(i[e],e);const a=new Map,c=new Set,u=new Map;for(const t of Array.from(s)){let s=te(t,o);if(c.has(s))u.set(t,s);else{if(a.has(t.getIndices())){const s=t.getIndices(),r=s.clone();o.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}for(const s of t.listAttributes())if(a.has(s)){const r=s.clone();o.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}s=te(t,o),c.add(s),u.set(t,s),a.set(t.getIndices(),s);for(const e of t.listAttributes())a.set(e,s)}}for(const e of Array.from(a.keys())){const t=new Set(e.listParents().map((e=>e.propertyType)));if(2!==t.size||!t.has(r.uS.PRIMITIVE)||!t.has(r.uS.ROOT))throw new Error(`[${Q}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const e of Array.from(s)){const t=u.get(e),s=e.getIndices();if(a.get(s)!==t||e.listAttributes().some((e=>a.get(e)!==t)))throw new Error(`[${Q}] Draco primitives must share all, or no, accessors.`)}for(const e of Array.from(n)){const t=e.getIndices();if(a.has(t)||e.listAttributes().some((e=>a.has(e))))throw new Error(`[${Q}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return u}(this.document),i=new Map;let o="mesh";"scene"===this._encoderOptions.quantizationVolume&&(1!==this.document.getRoot().listScenes().length?s.warn(`[${Q}]: quantizationVolume=scene requires exactly 1 scene.`):o=(0,r.zX)(this.document.getRoot().listScenes().pop()));for(const t of Array.from(n.keys())){const r=n.get(t);if(!r)throw new Error("Unexpected primitive.");if(i.has(r)){i.set(r,i.get(r));continue}const a=t.getIndices(),c=e.jsonDoc.json.accessors;let u;try{u=W(t,g({},this._encoderOptions,{quantizationVolume:o}))}catch(e){if(e instanceof Z){s.warn(`[${Q}]: ${e.message} Skipping primitive compression.`);continue}throw e}i.set(r,u);const h=e.createAccessorDef(a);h.count=u.numIndices,e.accessorIndexMap.set(a,c.length),c.push(h);for(const s of t.listSemantics()){const r=t.getAttribute(s);if(void 0===u.attributeIDs[s])continue;const n=e.createAccessorDef(r);n.count=u.numVertices,e.accessorIndexMap.set(r,c.length),c.push(n)}const l=t.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(l)||e.otherBufferViews.set(l,[]),e.otherBufferViews.get(l).push(u.data)}return s.debug(`[${Q}] Compressed ${n.size} primitives.`),e.extensionData[Q]={primitiveHashMap:n,primitiveEncodingMap:i},this}write(e){const t=e.extensionData[Q];for(const s of this.document.getRoot().listMeshes()){const r=e.jsonDoc.json.meshes[e.meshIndexMap.get(s)];for(let n=0;n<s.listPrimitives().length;n++){const i=s.listPrimitives()[n],o=r.primitives[n],a=t.primitiveHashMap.get(i);if(!a)continue;const c=t.primitiveEncodingMap.get(a);c&&(o.extensions=o.extensions||{},o.extensions[Q]={bufferView:e.otherBufferViewsIndexMap.get(c.data),attributes:c.attributeIDs})}}if(!t.primitiveHashMap.size){const t=e.jsonDoc.json;t.extensionsUsed=(t.extensionsUsed||[]).filter((e=>e!==Q)),t.extensionsRequired=(t.extensionsRequired||[]).filter((e=>e!==Q))}return this}}function te(e,t){const s=[],r=e.getIndices();s.push(t.get(r));for(const r of e.listAttributes())s.push(t.get(r));return s.sort().join("|")}ee.EXTENSION_NAME=Q,ee.EncoderMethod=X;class se extends r.eY{init(){this.extensionName="KHR_lights_punctual",this.propertyType="Light",this.parentTypes=[r.uS.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:se.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getColorHex(){return r.i5.factorToHex(this.getColor())}setColorHex(e){const t=this.getColor().slice();return r.i5.hexToFactor(e,t),this.setColor(t)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}se.EXTENSION_NAME="KHR_lights_punctual",se.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const re="KHR_lights_punctual";class ne extends r.hj{constructor(...e){super(...e),this.extensionName=re}createLight(e=""){return new se(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[re])return this;const s=(t.json.extensions[re].lights||[]).map((e=>{var t,s;const r=this.createLight().setName(e.name||"").setType(e.type);return void 0!==e.color&&r.setColor(e.color),void 0!==e.intensity&&r.setIntensity(e.intensity),void 0!==e.range&&r.setRange(e.range),void 0!==(null==(t=e.spot)?void 0:t.innerConeAngle)&&r.setInnerConeAngle(e.spot.innerConeAngle),void 0!==(null==(s=e.spot)?void 0:s.outerConeAngle)&&r.setOuterConeAngle(e.spot.outerConeAngle),r}));return t.json.nodes.forEach(((t,r)=>{t.extensions&&t.extensions[re]&&e.nodes[r].setExtension(re,s[t.extensions[re].light])})),this}write(e){const t=e.jsonDoc;if(0===this.properties.size)return this;const s=[],n=new Map;for(const e of this.properties){const t=e,i={type:t.getType()};r.MathUtils.eq(t.getColor(),[1,1,1])||(i.color=t.getColor()),1!==t.getIntensity()&&(i.intensity=t.getIntensity()),null!=t.getRange()&&(i.range=t.getRange()),t.getName()&&(i.name=t.getName()),t.getType()===se.Type.SPOT&&(i.spot={innerConeAngle:t.getInnerConeAngle(),outerConeAngle:t.getOuterConeAngle()}),s.push(i),n.set(t,s.length-1)}return this.document.getRoot().listNodes().forEach((s=>{const r=s.getExtension(re);if(r){const i=e.nodeIndexMap.get(s),o=t.json.nodes[i];o.extensions=o.extensions||{},o.extensions[re]={light:n.get(r)}}})),t.json.extensions=t.json.extensions||{},t.json.extensions[re]={lights:s},this}}ne.EXTENSION_NAME=re;const{R:ie,G:oe}=r.TextureChannel;class ae extends r.eY{init(){this.extensionName="KHR_materials_anisotropy",this.propertyType="Anisotropy",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new r.lO(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:ie|oe})}}ae.EXTENSION_NAME="KHR_materials_anisotropy";const ce="KHR_materials_anisotropy";class ue extends r.hj{constructor(...e){super(...e),this.extensionName=ce}createAnisotropy(){return new ae(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[ce]){const n=this.createAnisotropy();e.materials[r].setExtension(ce,n);const i=t.extensions[ce];if(void 0!==i.anisotropyStrength&&n.setAnisotropyStrength(i.anisotropyStrength),void 0!==i.anisotropyRotation&&n.setAnisotropyRotation(i.anisotropyRotation),void 0!==i.anisotropyTexture){const t=i.anisotropyTexture;n.setAnisotropyTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getAnisotropyTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(ce);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[ce]={};if(r.getAnisotropyStrength()>0&&(o.anisotropyStrength=r.getAnisotropyStrength()),0!==r.getAnisotropyRotation()&&(o.anisotropyRotation=r.getAnisotropyRotation()),r.getAnisotropyTexture()){const t=r.getAnisotropyTexture(),s=r.getAnisotropyTextureInfo();o.anisotropyTexture=e.createTextureInfoDef(t,s)}}})),this}}ue.EXTENSION_NAME=ce;const{R:he,G:le,B:fe}=r.TextureChannel;class ge extends r.eY{init(){this.extensionName="KHR_materials_clearcoat",this.propertyType="Clearcoat",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new r.lO(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new r.lO(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new r.lO(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:he})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:le})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:he|le|fe})}}ge.EXTENSION_NAME="KHR_materials_clearcoat";const pe="KHR_materials_clearcoat";class de extends r.hj{constructor(...e){super(...e),this.extensionName=pe}createClearcoat(){return new ge(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[pe]){const n=this.createClearcoat();e.materials[r].setExtension(pe,n);const i=t.extensions[pe];if(void 0!==i.clearcoatFactor&&n.setClearcoatFactor(i.clearcoatFactor),void 0!==i.clearcoatRoughnessFactor&&n.setClearcoatRoughnessFactor(i.clearcoatRoughnessFactor),void 0!==i.clearcoatTexture){const t=i.clearcoatTexture;n.setClearcoatTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getClearcoatTextureInfo(),t)}if(void 0!==i.clearcoatRoughnessTexture){const t=i.clearcoatRoughnessTexture;n.setClearcoatRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getClearcoatRoughnessTextureInfo(),t)}if(void 0!==i.clearcoatNormalTexture){const t=i.clearcoatNormalTexture;n.setClearcoatNormalTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getClearcoatNormalTextureInfo(),t),void 0!==t.scale&&n.setClearcoatNormalScale(t.scale)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(pe);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[pe]={clearcoatFactor:r.getClearcoatFactor(),clearcoatRoughnessFactor:r.getClearcoatRoughnessFactor()};if(r.getClearcoatTexture()){const t=r.getClearcoatTexture(),s=r.getClearcoatTextureInfo();o.clearcoatTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatRoughnessTexture()){const t=r.getClearcoatRoughnessTexture(),s=r.getClearcoatRoughnessTextureInfo();o.clearcoatRoughnessTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatNormalTexture()){const t=r.getClearcoatNormalTexture(),s=r.getClearcoatNormalTextureInfo();o.clearcoatNormalTexture=e.createTextureInfoDef(t,s),1!==r.getClearcoatNormalScale()&&(o.clearcoatNormalTexture.scale=r.getClearcoatNormalScale())}}})),this}}de.EXTENSION_NAME=pe;class me extends r.eY{init(){this.extensionName="KHR_materials_emissive_strength",this.propertyType="EmissiveStrength",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}me.EXTENSION_NAME="KHR_materials_emissive_strength";const xe="KHR_materials_emissive_strength";class Te extends r.hj{constructor(...e){super(...e),this.extensionName=xe}createEmissiveStrength(){return new me(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach(((t,s)=>{if(t.extensions&&t.extensions[xe]){const r=this.createEmissiveStrength();e.materials[s].setExtension(xe,r);const n=t.extensions[xe];void 0!==n.emissiveStrength&&r.setEmissiveStrength(n.emissiveStrength)}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(xe);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{},i.extensions[xe]={emissiveStrength:r.getEmissiveStrength()}}})),this}}Te.EXTENSION_NAME=xe;class Ee extends r.eY{init(){this.extensionName="KHR_materials_ior",this.propertyType="IOR",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}Ee.EXTENSION_NAME="KHR_materials_ior";const ye="KHR_materials_ior";class Re extends r.hj{constructor(...e){super(...e),this.extensionName=ye}createIOR(){return new Ee(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach(((t,s)=>{if(t.extensions&&t.extensions[ye]){const r=this.createIOR();e.materials[s].setExtension(ye,r);const n=t.extensions[ye];void 0!==n.ior&&r.setIOR(n.ior)}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(ye);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{},i.extensions[ye]={ior:r.getIOR()}}})),this}}Re.EXTENSION_NAME=ye;const{R:Ie,G:Ae}=r.TextureChannel;class Se extends r.eY{init(){this.extensionName="KHR_materials_iridescence",this.propertyType="Iridescence",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new r.lO(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new r.lO(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:Ie})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Ae})}}Se.EXTENSION_NAME="KHR_materials_iridescence";const Ne="KHR_materials_iridescence";class be extends r.hj{constructor(...e){super(...e),this.extensionName=Ne}createIridescence(){return new Se(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[Ne]){const n=this.createIridescence();e.materials[r].setExtension(Ne,n);const i=t.extensions[Ne];if(void 0!==i.iridescenceFactor&&n.setIridescenceFactor(i.iridescenceFactor),void 0!==i.iridescenceIor&&n.setIridescenceIOR(i.iridescenceIor),void 0!==i.iridescenceThicknessMinimum&&n.setIridescenceThicknessMinimum(i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&n.setIridescenceThicknessMaximum(i.iridescenceThicknessMaximum),void 0!==i.iridescenceTexture){const t=i.iridescenceTexture;n.setIridescenceTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getIridescenceTextureInfo(),t)}if(void 0!==i.iridescenceThicknessTexture){const t=i.iridescenceThicknessTexture;n.setIridescenceThicknessTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getIridescenceThicknessTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(Ne);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[Ne]={};if(r.getIridescenceFactor()>0&&(o.iridescenceFactor=r.getIridescenceFactor()),1.3!==r.getIridescenceIOR()&&(o.iridescenceIor=r.getIridescenceIOR()),100!==r.getIridescenceThicknessMinimum()&&(o.iridescenceThicknessMinimum=r.getIridescenceThicknessMinimum()),400!==r.getIridescenceThicknessMaximum()&&(o.iridescenceThicknessMaximum=r.getIridescenceThicknessMaximum()),r.getIridescenceTexture()){const t=r.getIridescenceTexture(),s=r.getIridescenceTextureInfo();o.iridescenceTexture=e.createTextureInfoDef(t,s)}if(r.getIridescenceThicknessTexture()){const t=r.getIridescenceThicknessTexture(),s=r.getIridescenceThicknessTextureInfo();o.iridescenceThicknessTexture=e.createTextureInfoDef(t,s)}}})),this}}be.EXTENSION_NAME=Ne;const{R:we,G:_e,B:Me,A:Ce}=r.TextureChannel;class Oe extends r.eY{init(){this.extensionName="KHR_materials_pbrSpecularGlossiness",this.propertyType="PBRSpecularGlossiness",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new r.lO(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new r.lO(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseHex(){return r.i5.factorToHex(this.getDiffuseFactor())}setDiffuseHex(e){const t=this.getDiffuseFactor().slice();return this.setDiffuseFactor(r.i5.hexToFactor(e,t))}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:we|_e|Me|Ce})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:we|_e|Me|Ce})}}Oe.EXTENSION_NAME="KHR_materials_pbrSpecularGlossiness";const ve="KHR_materials_pbrSpecularGlossiness";class De extends r.hj{constructor(...e){super(...e),this.extensionName=ve}createPBRSpecularGlossiness(){return new Oe(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[ve]){const n=this.createPBRSpecularGlossiness();e.materials[r].setExtension(ve,n);const i=t.extensions[ve];if(void 0!==i.diffuseFactor&&n.setDiffuseFactor(i.diffuseFactor),void 0!==i.specularFactor&&n.setSpecularFactor(i.specularFactor),void 0!==i.glossinessFactor&&n.setGlossinessFactor(i.glossinessFactor),void 0!==i.diffuseTexture){const t=i.diffuseTexture;n.setDiffuseTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getDiffuseTextureInfo(),t)}if(void 0!==i.specularGlossinessTexture){const t=i.specularGlossinessTexture;n.setSpecularGlossinessTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getSpecularGlossinessTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(ve);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[ve]={diffuseFactor:r.getDiffuseFactor(),specularFactor:r.getSpecularFactor(),glossinessFactor:r.getGlossinessFactor()};if(r.getDiffuseTexture()){const t=r.getDiffuseTexture(),s=r.getDiffuseTextureInfo();o.diffuseTexture=e.createTextureInfoDef(t,s)}if(r.getSpecularGlossinessTexture()){const t=r.getSpecularGlossinessTexture(),s=r.getSpecularGlossinessTextureInfo();o.specularGlossinessTexture=e.createTextureInfoDef(t,s)}}})),this}}De.EXTENSION_NAME=ve;const{R:Fe,G:Ue,B:Be,A:Le}=r.TextureChannel;class je extends r.eY{init(){this.extensionName="KHR_materials_sheen",this.propertyType="Sheen",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new r.lO(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new r.lO(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}getSheenColorHex(){return r.i5.factorToHex(this.getSheenColorFactor())}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}setSheenColorHex(e){const t=this.getSheenColorFactor().slice();return this.set("sheenColorFactor",r.i5.hexToFactor(e,t))}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:Fe|Ue|Be})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:Le})}}je.EXTENSION_NAME="KHR_materials_sheen";const Pe="KHR_materials_sheen";class Ve extends r.hj{constructor(...e){super(...e),this.extensionName=Pe}createSheen(){return new je(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[Pe]){const n=this.createSheen();e.materials[r].setExtension(Pe,n);const i=t.extensions[Pe];if(void 0!==i.sheenColorFactor&&n.setSheenColorFactor(i.sheenColorFactor),void 0!==i.sheenRoughnessFactor&&n.setSheenRoughnessFactor(i.sheenRoughnessFactor),void 0!==i.sheenColorTexture){const t=i.sheenColorTexture;n.setSheenColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getSheenColorTextureInfo(),t)}if(void 0!==i.sheenRoughnessTexture){const t=i.sheenRoughnessTexture;n.setSheenRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getSheenRoughnessTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension(Pe);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[Pe]={sheenColorFactor:r.getSheenColorFactor(),sheenRoughnessFactor:r.getSheenRoughnessFactor()};if(r.getSheenColorTexture()){const t=r.getSheenColorTexture(),s=r.getSheenColorTextureInfo();o.sheenColorTexture=e.createTextureInfoDef(t,s)}if(r.getSheenRoughnessTexture()){const t=r.getSheenRoughnessTexture(),s=r.getSheenRoughnessTextureInfo();o.sheenRoughnessTexture=e.createTextureInfoDef(t,s)}}})),this}}Ve.EXTENSION_NAME=Pe;const{R:ke,G:Ge,B:He,A:ze}=r.TextureChannel;class Xe extends r.eY{init(){this.extensionName="KHR_materials_specular",this.propertyType="Specular",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new r.lO(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new r.lO(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularColorHex(){return r.i5.factorToHex(this.getSpecularColorFactor())}setSpecularColorHex(e){const t=this.getSpecularColorFactor().slice();return this.set("specularColorFactor",r.i5.hexToFactor(e,t))}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:ze})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:ke|Ge|He})}}Xe.EXTENSION_NAME="KHR_materials_specular";const Ye="KHR_materials_specular";class Ke extends r.hj{constructor(...e){super(...e),this.extensionName=Ye}createSpecular(){return new Xe(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[Ye]){const n=this.createSpecular();e.materials[r].setExtension(Ye,n);const i=t.extensions[Ye];if(void 0!==i.specularFactor&&n.setSpecularFactor(i.specularFactor),void 0!==i.specularColorFactor&&n.setSpecularColorFactor(i.specularColorFactor),void 0!==i.specularTexture){const t=i.specularTexture;n.setSpecularTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getSpecularTextureInfo(),t)}if(void 0!==i.specularColorTexture){const t=i.specularColorTexture;n.setSpecularColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getSpecularColorTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const n=s.getExtension(Ye);if(n){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ye]={};if(1!==n.getSpecularFactor()&&(a.specularFactor=n.getSpecularFactor()),r.MathUtils.eq(n.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=n.getSpecularColorFactor()),n.getSpecularTexture()){const t=n.getSpecularTexture(),s=n.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(t,s)}if(n.getSpecularColorTexture()){const t=n.getSpecularColorTexture(),s=n.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(t,s)}}})),this}}Ke.EXTENSION_NAME=Ye;const{R:qe}=r.TextureChannel;class We extends r.eY{init(){this.extensionName="KHR_materials_transmission",this.propertyType="Transmission",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new r.lO(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:qe})}}We.EXTENSION_NAME="KHR_materials_transmission";const $e="KHR_materials_transmission";class Je extends r.hj{constructor(...e){super(...e),this.extensionName=$e}createTransmission(){return new We(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[$e]){const n=this.createTransmission();e.materials[r].setExtension($e,n);const i=t.extensions[$e];if(void 0!==i.transmissionFactor&&n.setTransmissionFactor(i.transmissionFactor),void 0!==i.transmissionTexture){const t=i.transmissionTexture;n.setTransmissionTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getTransmissionTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const r=s.getExtension($e);if(r){const n=e.materialIndexMap.get(s),i=t.json.materials[n];i.extensions=i.extensions||{};const o=i.extensions[$e]={transmissionFactor:r.getTransmissionFactor()};if(r.getTransmissionTexture()){const t=r.getTransmissionTexture(),s=r.getTransmissionTextureInfo();o.transmissionTexture=e.createTextureInfoDef(t,s)}}})),this}}Je.EXTENSION_NAME=$e;class Ze extends r.eY{init(){this.extensionName="KHR_materials_unlit",this.propertyType="Unlit",this.parentTypes=[r.uS.MATERIAL]}}Ze.EXTENSION_NAME="KHR_materials_unlit";const Qe="KHR_materials_unlit";class et extends r.hj{constructor(...e){super(...e),this.extensionName=Qe}createUnlit(){return new Ze(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach(((t,s)=>{t.extensions&&t.extensions[Qe]&&e.materials[s].setExtension(Qe,this.createUnlit())})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{if(s.getExtension(Qe)){const r=e.materialIndexMap.get(s),n=t.json.materials[r];n.extensions=n.extensions||{},n.extensions[Qe]={}}})),this}}et.EXTENSION_NAME=Qe;class tt extends r.eY{init(){this.extensionName="KHR_materials_variants",this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:[]})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}tt.EXTENSION_NAME="KHR_materials_variants";class st extends r.eY{init(){this.extensionName="KHR_materials_variants",this.propertyType="MappingList",this.parentTypes=[r.uS.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:[]})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}st.EXTENSION_NAME="KHR_materials_variants";class rt extends r.eY{init(){this.extensionName="KHR_materials_variants",this.propertyType="Variant",this.parentTypes=["MappingList"]}}rt.EXTENSION_NAME="KHR_materials_variants";const nt="KHR_materials_variants";class it extends r.hj{constructor(...e){super(...e),this.extensionName=nt}createMappingList(){return new st(this.document.getGraph())}createVariant(e=""){return new rt(this.document.getGraph(),e)}createMapping(){return new tt(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter((e=>e instanceof rt))}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[nt])return this;const s=(t.json.extensions[nt].variants||[]).map((e=>this.createVariant().setName(e.name||"")));return(t.json.meshes||[]).forEach(((t,r)=>{const n=e.meshes[r];(t.primitives||[]).forEach(((t,r)=>{if(!t.extensions||!t.extensions[nt])return;const i=this.createMappingList(),o=t.extensions[nt];for(const t of o.mappings){const r=this.createMapping();void 0!==t.material&&r.setMaterial(e.materials[t.material]);for(const e of t.variants||[])r.addVariant(s[e]);i.addMapping(r)}n.listPrimitives()[r].setExtension(nt,i)}))})),this}write(e){const t=e.jsonDoc,s=this.listVariants();if(!s.length)return this;const r=[],n=new Map;for(const t of s)n.set(t,r.length),r.push(e.createPropertyDef(t));for(const t of this.document.getRoot().listMeshes()){const s=e.meshIndexMap.get(t);t.listPrimitives().forEach(((t,r)=>{const i=t.getExtension(nt);if(!i)return;const o=e.jsonDoc.json.meshes[s].primitives[r],a=i.listMappings().map((t=>{const s=e.createPropertyDef(t),r=t.getMaterial();return r&&(s.material=e.materialIndexMap.get(r)),s.variants=t.listVariants().map((e=>n.get(e))),s}));o.extensions=o.extensions||{},o.extensions[nt]={mappings:a}}))}return t.json.extensions=t.json.extensions||{},t.json.extensions[nt]={variants:r},this}}it.EXTENSION_NAME=nt;const{G:ot}=r.TextureChannel;class at extends r.eY{init(){this.extensionName="KHR_materials_volume",this.propertyType="Volume",this.parentTypes=[r.uS.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new r.lO(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:ot})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}getAttenuationColorHex(){return r.i5.factorToHex(this.getAttenuationColor())}setAttenuationColorHex(e){const t=this.getAttenuationColor().slice();return this.set("attenuationColor",r.i5.hexToFactor(e,t))}}at.EXTENSION_NAME="KHR_materials_volume";const ct="KHR_materials_volume";class ut extends r.hj{constructor(...e){super(...e),this.extensionName=ct}createVolume(){return new at(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach(((t,r)=>{if(t.extensions&&t.extensions[ct]){const n=this.createVolume();e.materials[r].setExtension(ct,n);const i=t.extensions[ct];if(void 0!==i.thicknessFactor&&n.setThicknessFactor(i.thicknessFactor),void 0!==i.attenuationDistance&&n.setAttenuationDistance(i.attenuationDistance),void 0!==i.attenuationColor&&n.setAttenuationColor(i.attenuationColor),void 0!==i.thicknessTexture){const t=i.thicknessTexture;n.setThicknessTexture(e.textures[s[t.index].source]),e.setTextureInfo(n.getThicknessTextureInfo(),t)}}})),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach((s=>{const n=s.getExtension(ct);if(n){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[ct]={};if(n.getThicknessFactor()>0&&(a.thicknessFactor=n.getThicknessFactor()),Number.isFinite(n.getAttenuationDistance())&&(a.attenuationDistance=n.getAttenuationDistance()),r.MathUtils.eq(n.getAttenuationColor(),[1,1,1])||(a.attenuationColor=n.getAttenuationColor()),n.getThicknessTexture()){const t=n.getThicknessTexture(),s=n.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(t,s)}}})),this}}ut.EXTENSION_NAME=ct;const ht="KHR_mesh_quantization";class lt extends r.hj{constructor(...e){super(...e),this.extensionName=ht}read(e){return this}write(e){return this}}lt.EXTENSION_NAME=ht;const ft="KHR_texture_basisu";class gt{match(e){return 171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&50===e[5]&&48===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11]}getSize(e){const t=u(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const t=u(e).dataFormatDescriptor[0];if(163===t.colorModel)return 2===t.samples.length&&15==(15&t.samples[1].channelType)?4:3;if(166===t.colorModel)return 3==(15&t.samples[0].channelType)?4:3;throw new Error(`Unexpected KTX2 colorModel, "${t.colorModel}".`)}getVRAMByteLength(e){const t=u(e),s=this.getChannels(e)>3;let r=0;for(let e=0;e<t.levels.length;e++){const n=t.levels[e];r+=n.uncompressedByteLength?n.uncompressedByteLength:Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,e)))/4*(Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,e)))/4)*(s?16:8)}return r}}class pt extends r.hj{constructor(...e){super(...e),this.extensionName=ft,this.prereadTypes=[r.uS.TEXTURE]}static register(){r.Pp.registerFormat("image/ktx2",new gt)}preread(e){return e.jsonDoc.json.textures.forEach((e=>{e.extensions&&e.extensions[ft]&&(e.source=e.extensions[ft].source)})),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach((s=>{if("image/ktx2"===s.getMimeType()){const r=e.imageIndexMap.get(s);t.json.textures.forEach((e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[ft]={source:e.source},delete e.source)}))}})),this}}pt.EXTENSION_NAME=ft;class dt extends r.eY{init(){this.extensionName="KHR_texture_transform",this.propertyType="Transform",this.parentTypes=[r.uS.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}dt.EXTENSION_NAME="KHR_texture_transform";const mt="KHR_texture_transform";class xt extends r.hj{constructor(...e){super(...e),this.extensionName=mt}createTransform(){return new dt(this.document.getGraph())}read(e){for(const[t,s]of Array.from(e.textureInfos.entries())){if(!s.extensions||!s.extensions[mt])continue;const e=this.createTransform(),r=s.extensions[mt];void 0!==r.offset&&e.setOffset(r.offset),void 0!==r.rotation&&e.setRotation(r.rotation),void 0!==r.scale&&e.setScale(r.scale),void 0!==r.texCoord&&e.setTexCoord(r.texCoord),t.setExtension(mt,e)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[e,s]of t){const t=e.getExtension(mt);if(!t)continue;s.extensions=s.extensions||{};const n={},i=r.MathUtils.eq;i(t.getOffset(),[0,0])||(n.offset=t.getOffset()),0!==t.getRotation()&&(n.rotation=t.getRotation()),i(t.getScale(),[1,1])||(n.scale=t.getScale()),null!=t.getTexCoord()&&(n.texCoord=t.getTexCoord()),s.extensions[mt]=n}return this}}xt.EXTENSION_NAME=mt;const Tt=[r.uS.ROOT,r.uS.SCENE,r.uS.NODE,r.uS.MESH,r.uS.MATERIAL,r.uS.TEXTURE,r.uS.ANIMATION];class Et extends r.eY{init(){this.extensionName="KHR_xmp_json_ld",this.propertyType="Packet",this.parentTypes=Tt}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",g({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const s=g({},this.get("properties"));return t?s[e]=t:delete s[e],this.set("properties",s)}toJSONLD(){return g({"@context":yt(this.get("context"))},yt(this.get("properties")))}fromJSONLD(e){const t=(e=yt(e))["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`KHR_xmp_json_ld: Missing context for term, "${e}".`)}}function yt(e){return JSON.parse(JSON.stringify(e))}Et.EXTENSION_NAME="KHR_xmp_json_ld";const Rt="KHR_xmp_json_ld";class It extends r.hj{constructor(...e){super(...e),this.extensionName=Rt}createPacket(){return new Et(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const s=null==(t=e.jsonDoc.json.extensions)?void 0:t[Rt];if(!s||!s.packets)return this;const r=e.jsonDoc.json,n=this.document.getRoot(),i=s.packets.map((e=>this.createPacket().fromJSONLD(e))),o=[[r.asset],r.scenes,r.nodes,r.meshes,r.materials,r.images,r.animations],a=[[n],n.listScenes(),n.listNodes(),n.listMeshes(),n.listMaterials(),n.listTextures(),n.listAnimations()];for(let e=0;e<o.length;e++){const t=o[e]||[];for(let s=0;s<t.length;s++){const r=t[s];r.extensions&&r.extensions[Rt]&&a[e][s].setExtension(Rt,i[r.extensions[Rt].packet])}}return this}write(e){const{json:t}=e.jsonDoc,s=[];for(const n of this.properties){s.push(n.toJSONLD());for(const i of n.listParents()){let n;switch(i.propertyType){case r.uS.ROOT:n=t.asset;break;case r.uS.SCENE:n=t.scenes[e.sceneIndexMap.get(i)];break;case r.uS.NODE:n=t.nodes[e.nodeIndexMap.get(i)];break;case r.uS.MESH:n=t.meshes[e.meshIndexMap.get(i)];break;case r.uS.MATERIAL:n=t.materials[e.materialIndexMap.get(i)];break;case r.uS.TEXTURE:n=t.images[e.imageIndexMap.get(i)];break;case r.uS.ANIMATION:n=t.animations[e.animationIndexMap.get(i)];break;default:n=null,this.document.getLogger().warn(`[${Rt}]: Unsupported parent property, "${i.propertyType}"`)}n&&(n.extensions=n.extensions||{},n.extensions[Rt]={packet:s.length-1})}}return s.length>0&&(t.extensions=t.extensions||{},t.extensions[Rt]={packets:s}),this}}It.EXTENSION_NAME=Rt;const At=[f,M,v,B,ee,ne,ue,de,Te,Re,be,De,Ke,Ve,Je,et,it,ut,lt,pt,xt,It]}}]);
//# sourceMappingURL=453.34f6c7c6.js.map